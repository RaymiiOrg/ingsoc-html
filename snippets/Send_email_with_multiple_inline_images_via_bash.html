
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Send email with multiple inline images via bash with a loop - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Send email with multiple inline images via bash with a loop</h2><p><small>Published: 23-07-2018 | Author: Remy van Elst | <a href="Send_email_with_multiple_inline_images_via_bash.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>Recently I had a request from a user that whished to receive a scheduled email
with two screenshots. The screenshots were automated via AutoIt on a network
share, the user manually logged in every evening to check the pictures. With
bash and postfix/sendmail we can automate this process, the user now doesn&#39;t
have to login but can just check their email. There are a lot of snippets and
guides to attach emails via the shell, but displaying multiple images inline as
an HTML mail was something I had to figure out. You cannot embed the image in
base64 HTML because Outlook doesn&#39;t show that, you must use the Content-ID style
embed. Like UUENCODE, but more complicated. (The next step in this process with
the user is to automate the reason why they have to check those screenshots
every night, that is something for another article)</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p><img src="https://raymii.org/s/inc/img/automate-all-the-things.png" alt=""></p>

<p>The script first fetches the images from a remote URL and places them on the
filesystem, in a date-structured folder for archival purposes. It then
constructs the HTML email, appending the attachments as base64 encoded content
below the text part of the email.</p>

<h3>Script</h3>

<pre><code>#!/bin/bash
# date with hour and minute for in filename
CURDATE=$(date +%Y%m%dT%H%M)
# date for folder name
FOLDERDATE=$(date +%Y%m%d)
# path where files are stored for archival
SAVEPATH=/opt/monitoring/screenshots/$FOLDERDATE
mkdir -p $SAVEPATH
# declare the array with the images to mail, can be as many as you want.
declare -A ATTS
#filename without extension. Key = header, value is filename without ext
ATTS[&quot;Screenshot 1, Most important&quot;]=&quot;image1&quot;
ATTS[&quot;Screenshot 2, Some more info&quot;]=&quot;image2&quot;
# extension must all be the same
EXT=&quot;.png&quot;
# loop over all images and download them locally
$(for key in &quot;${!ATTS[@]}&quot;; do 
  value=${ATTS[$key]};
  /usr/bin/wget -q -O $SAVEPATH/$value-$CURDATE$EXT https://[...]/$value$EXT;
  cp $SAVEPATH/$value-$CURDATE$EXT $SAVEPATH/$value$EXT;
done)

for key in &quot;${!ATTS[@]}&quot;; do 
  # due to formatting of the base64 output in the command loop
  # the file must be base64 encoded in a variable.
  # here we encode the file, in the loop we get in it a var.
  value=${ATTS[$key]};
  /usr/bin/base64 &quot;$SAVEPATH/$value$EXT&quot; &gt; $SAVEPATH/$value$EXT.base64;
done

/usr/sbin/sendmail -t &lt;&lt;EOT
TO: user@example.org
FROM: automation@example.com
BCC: manager@example.org
SUBJECT: State of the union $(date +%c) 
MIME-Version: 1.0
Content-Type: multipart/related;boundary=&quot;XYZ&quot;

--XYZ
Content-Type: text/html; charset=ISO-8859-15
Content-Transfer-Encoding: 7bit

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-15&quot;&gt;
&lt;/head&gt;
&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;
$(for key in &quot;${!ATTS[@]}&quot;; do 
  value=${ATTS[$key]};
  echo &quot;&lt;h1&gt;$key&lt;/h1&gt;&quot;;
  echo &quot;&lt;img src=\&quot;cid:$value\&quot;&gt;&lt;/br&gt;&quot;;
done)
&lt;a href=&quot;https://[...]&quot;&gt;More information&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;

$(for key in &quot;${!ATTS[@]}&quot;; do 
  value=${ATTS[$key]};
  ATT=$(cat $SAVEPATH/$value$EXT.base64);
  echo &quot;--XYZ&quot;
  echo &quot;Content-Type: image/png;name=\&quot;$value$EXT\&quot;&quot;
  echo &quot;Content-Transfer-Encoding: base64&quot;
  echo &quot;Content-ID: &lt;$value&gt;&quot;
  echo &quot;Content-Disposition: inline; filename=\&quot;$value$EXT\&quot;&quot;
  echo &quot;&quot;
  echo &quot;$ATT&quot;
done)
--XYZ--
EOT


for key in &quot;${!ATTS[@]}&quot;; do 
  value=${ATTS[$key]};
  rm $SAVEPATH/$value$EXT.base64;
done
</code></pre>

<p>The <code>--XYZ</code> variable has been copied from a script online.</p>

<p>More images can be added in this loop by editing the array <code>ATTS</code>. Make sure
they all have the same extension.</p>
Tags: <a href="../tags/attachments.html" class="link">attachments</a>, <a href="../tags/automation.html" class="link">automation</a>, <a href="../tags/bash.html" class="link">bash</a>, <a href="../tags/inline.html" class="link">inline</a>, <a href="../tags/mail.html" class="link">mail</a>, <a href="../tags/outlook.html" class="link">outlook</a>, <a href="../tags/postfix.html" class="link">postfix</a>, <a href="../tags/sendmail.html" class="link">sendmail</a>, <a href="../tags/shell.html" class="link">shell</a>, <a href="../tags/snippets.html" class="link">snippets</a>, <a href="../tags/uuencode.html" class="link">uuencode</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    