
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Proxmox VE - One Public IP - Raymii.org</title>
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <script src="/s//inc/js/instant.js"></script> 
        <script src="/s//inc/js/toc.js"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="/s/inc/img/resistor-50.png" alt="Logo (IEC resistor symbol)">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Proxmox VE - One Public IP</h2>
<p><small>Published: 10-07-2014 | Author: Remy van Elst | <a href="Proxmox_VE_One_Public_IP.txt" class="link">Text only version of this article</small></a>
</p>
<div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc">
<h3>Table of Contents</h3>
</div>
<hr>
<div id="contents">
<p>This guide will show you how to set up Proxmox with only one public IP. We will
configure an extra interface bridge and make sure VM traffic is NATed. I have a
few dedicated servers, some run Proxmox. Most of them however have only a few
IP&#39;s. Therefore the VM&#39;s in proxmox cannot all have a public IP. For most of
them that is not a problem. If needed I run a proxy or set up iptables to
forward ports to the VM&#39;s.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>This guide is tested on a proxmox machine running proxmox version 3.2.</p>

<p>What we will have at the end is a VM with an SSH port reachable on the public
IP:</p>

<pre><code>Container/VM ------------ Proxmox Server -------------- Public Internet
10.21.21.5:22 --- 10.21.21.5:22 NAT to 1.2.3.4:2222 --- 1.2.3.4:2222
</code></pre>

<p>Proxmox by default creates one interface, <code>vmbr0</code>. That config looks like this:</p>

<pre><code># /etc/network/interfaces
auto vmbr0
iface vmbr0 inet static
    address 1.2.3.4
    netmask 255.255.255.0
    network 1.2.3.0
    broadcast 1.2.3.255
    gateway 1.2.3.1
    bridge_ports eth0
    bridge_stp off
    bridge_fd 0
</code></pre>

<p>Replace <code>1.2.3.X</code> with your public ip, network, gateway and such. Do note that
there might be more interfaces, like <code>vmbr1</code> for ipv6.</p>

<p>We create a new bridge which will enable NAT when the interface gets UP. Add the
following to the file:</p>

<pre><code># /etc/network/interfaces:
auto vmbr2
iface vmbr2 inet static
    address 10.21.21.254
    netmask 255.255.255.0
    bridge_ports none
    bridge_stp off
    bridge_fd 0
    post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward
    post-up iptables -t nat -A POSTROUTING -s &#39;10.21.21.0/24&#39; -o vmbr0 -j MASQUERADE
    post-down iptables -t nat -D POSTROUTING -s &#39;10.21.21.0/24&#39; -o vmbr0 -j MASQUERADE
    post-up iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport 2222 -j DNAT --to 10.21.21.5:22
    post-down iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport 2222 -j DNAT --to 10.21.21.5:22
</code></pre>

<p>The first part:</p>

<pre><code>address 10.21.21.254
netmask 255.255.255.0
bridge_ports none
bridge_stp off
bridge_fd 0
</code></pre>

<p>defines the IP address and subnet mask of the new interface. It also tells the
network stack that the bridge has no actual ports (like eth0) and that the
Spanning Tree Protocol should be disabled.</p>

<pre><code>post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward
</code></pre>

<p>Enables IP forwarding when this interface gets up. This allows the machine to
forward packets.</p>

<pre><code>post-up iptables -t nat -A POSTROUTING -s &#39;10.21.21.0/24&#39; -o vmbr0 -j MASQUERADE
post-down iptables -t nat -D POSTROUTING -s &#39;10.21.21.0/24&#39; -o vmbr0 -j MASQUERADE
</code></pre>

<p>These two lines enable the actual NAT-ing of packets from the source network
&#39;10.21.21.0/24&#39; and <code>vmbr0</code> as the output interface. If your WAN interface has a
different name, change that here. The first line enables the natting when the
interface gets up, the second line deletes the firewall rule when the interface
goes down.</p>

<pre><code>post-up iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport 2222 -j DNAT --to 10.21.21.5:22
post-down iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport 2222 -j DNAT --to 10.21.21.5:22
</code></pre>

<p>These two rules enable and disable the actual port forwarding of tcp port <code>2222</code>
on the WAN IP to tcp port 22 on internal IP address 10.21.21.5. Here as well the
WAN interface (this time, the input interface) is <code>vmbr0</code>.</p>

<p>If you for example want to expose tcp port 80 of a VM with IP 10.21.21.6 on the
public IP&#39;s port 80, you should also add these lines:</p>

<pre><code>post-up iptables -t nat -A PREROUTING -i vmbr0 -p tcp --dport 80 -j DNAT --to 10.21.21.6:80
post-down iptables -t nat -D PREROUTING -i vmbr0 -p tcp --dport 80 -j DNAT --to 10.21.21.6:80
</code></pre>

<p>When you create a KVM VM, make sure it is attached to the bridge <code>vmbr2</code>. It
should also have a static IP configured in the range you define. OpenVZ <code>venet</code>
interfaces with an IP in this range automagiaclly work.</p>

<p>Don&#39;t forget to restart the network afterwards:</p>

<pre><code>/etc/init.d/networking restart
</code></pre>
Tags: <a href="../tags/bash.html" class="link">bash</a>
, <a href="../tags/kvm.html" class="link">kvm</a>
, <a href="../tags/openvz.html" class="link">openvz</a>
, <a href="../tags/proxmox.html" class="link">proxmox</a>
, <a href="../tags/proxmox-ve.html" class="link">proxmox-ve</a>
, <a href="../tags/ssh.html" class="link">ssh</a>
, <a href="../tags/tutorials.html" class="link">tutorials</a>
, <a href="../tags/virtualization.html" class="link">virtualization</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
     
    </main>
    </body>
    </html>
    