
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Ansible - Playbook Testing - Raymii.org</title>
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <script src="/s//inc/js/instant.js"></script> 
        <script src="/s//inc/js/toc.js"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="/s/inc/img/resistor-50.png" alt="Logo (IEC resistor symbol)">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Ansible - Playbook Testing</h2>
<p><small>Published: 29-12-2013 | Author: Remy van Elst | <a href="Ansible_-_Playbook_Testing.txt" class="link">Text only version of this article</small></a>
</p>
<div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc">
<h3>Table of Contents</h3>
</div>
<hr>
<div id="contents">
<p>This Ansible article shows you how to run a basic test on your playbooks to
check if their syntax is correct. It shows methods for both Ansible 1.3 and 1.4.
When you get more complicated Ansible playbooks you sometimes have syntax (YAML)
errors in them. It sometimes can take a while before those errors show up
because they are lower in a playbook. By running the syntax check you make sure
this won&#39;t happen.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<h3>Dummy inventory file</h3>

<p>Lets say your playbooks are located in <code>/home/username/ansible/playbooks</code>. You
have a few roles and a few playbooks. To test them, we need a dummy
<code>ansible_hosts</code> file. Create it:</p>

<pre><code>cd ~/ansible/
mkdir tests/
vim tests/ansible_hosts
</code></pre>

<p>Put this in the file:</p>

<pre><code>[local]
127.0.0.1
</code></pre>

<p>Note that when executing the tasks it will not actually execute them on your
local machine. It only does a syntax check.</p>

<h3>Testing</h3>

<p>Use the <code>--syntax-check</code> and <code>-list-tasks</code> options, plus the dummy inventory
file to do a full syntax check, including all includes roles and task files:</p>

<pre><code>ansible-playbook --syntax-check --list-tasks -i tests/ansible_hosts
./example-playbook.yml
</code></pre>

<p>If there are no errors, you will get a list of tasks which the playbook wil
execute:</p>

<pre><code>playbook: ./playbooks/default-vps-setup.yml

  play #1 (local):
    apt name={{item}} state=latest update_cache=yes
    apt pkg={{item}} state=absent
    template src=localegen.j2 dest=/etc/locale.gen
    template src=localepurge.j2 dest=/etc/locale.nopurge
    template src=timezone.j2 dest=/etc/timezone
    template src=issue.net.j2 dest=/etc/issue.net
    template src=issue.net.j2 dest=/etc/issue
    template src=hostname.j2 dest=/etc/hostname
</code></pre>

<p>If you have an error it will show up in red:</p>

<pre><code>ansible-playbook --syntax-check --list-tasks -i tests/ansible_hosts
./playbooks/default-vps-setup.yml

playbook: ./playbooks/default-vps-setup.yml

ERROR: Syntax Error while loading YAML script,
/home/remy/ansible/playbooks/roles/vim/tasks/main.yml Note: The error may
actually appear before this position: line 3, column 7

-dfi://dsf;apt: pkg=vim-tiny state=latest update_cache=yes
  sudo: yes
</code></pre>

<h3>Testing all the playbooks</h3>

<p>My ansible git repository is set up like so:</p>

<pre><code> $ tree -L 3

|-- ansible_hosts
|-- ci.sh
|-- playbooks
|   |-- debug.yml
|   |-- default-vps-setup.yml
|   |-- group_vars
|   |   |-- all.yml
|   |   |-- apache-php.yml
|   |   |-- lighttpd-php.yml
|   |   |-- desktop-awesome.yml
|   |   `-- nginx-php.yml
|   |-- nginx-vps.yml
|   `-- roles
       |-- bash
|       |   `-- tasks
|       |-- basic-debian-setup
|       |   |-- files
|       |   |-- tasks
|       |   `-- templates
[...]
|       |-- vim
|       `-- vnstat
`-- tests
    `-- ansible_hosts
</code></pre>

<p>As you can see my playbooks are in the <code>playbooks</code> folder. To test all the
playbooks I use the following find command piped trough to ansible:</p>

<pre><code>find ./playbooks -name &#39;*.yml&#39; -depth 1 | xargs -n1  ansible-playbook
--syntax-check --list-tasks -i tests/ansible_hosts
</code></pre>

<p>The <code>-depth 1</code> makes sure only playbooks are tested, testing task or variable
files will fail.</p>

<p>You can very easily add this setup to Jenkins or any other CI. I have my
playbooks in Jenkins, a simple bash script named <code>ci.sh</code> is used as the only
test step:</p>

<pre><code>#!/usr/bin/env bash
set -o errexit
set -o nounset
# set -o xtrace
set -o pipefail

__DIR__=&quot;$(cd &quot;$(dirname &quot;${0}&quot;)&quot;; echo $(pwd))&quot;
__BASE__=&quot;$(basename &quot;${0}&quot;)&quot;
__FILE__=&quot;${__DIR__}/${__BASE__}&quot;

echo &quot;################################&quot;
echo &quot;Build Information&quot;
echo &quot;Directory: ${__DIR__}&quot;
echo &quot;Filename: ${__FILE__}&quot;
echo &quot;Version Information:&quot;
echo &quot;Ansible Version: $(ansible --version)&quot;
echo &quot;Ansible Playbook Version: $(ansible-playbook --version)&quot;
echo &quot;Operating System: $(lsb_release -d | awk -F: &#39;{ print $2 }&#39; | tr -d &#39;\t&#39;)&quot;
echo &quot;Kernel: $(uname -a)&quot;
echo &quot;################################&quot;

echo &quot;### Starting tests&quot;

find ./playbooks -maxdepth 1 -name &#39;*.yml&#39;| xargs -n1  ansible-playbook
--syntax-check --list-tasks -i tests/ansible_hosts
</code></pre>
Tags: <a href="../tags/ansible.html" class="link">ansible</a>
, <a href="../tags/configuration-management.html" class="link">configuration-management</a>
, <a href="../tags/deployment.html" class="link">deployment</a>
, <a href="../tags/devops.html" class="link">devops</a>
, <a href="../tags/python.html" class="link">python</a>
, <a href="../tags/syntax.html" class="link">syntax</a>
, <a href="../tags/testing.html" class="link">testing</a>
, <a href="../tags/tests.html" class="link">tests</a>
, <a href="../tags/tutorials.html" class="link">tutorials</a>
, <a href="../tags/yaml.html" class="link">yaml</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
     
    </main>
    </body>
    </html>
    