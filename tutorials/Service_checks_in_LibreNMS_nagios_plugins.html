
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Service checks in LibreNMS (http, all other Nagios plugins) - Raymii.org</title>
        <link href="/s/inc/css/custom-first.css" rel="stylesheet" />
        <!-- <link href="/s/inc/css/light.css" rel="stylesheet"  />
        # <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        <a class="skip-main" href="#main">Skip to main content</a>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a> | <a href="gopher://raymii.org:70">Gopher</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/index.html" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/tags/all.html" class="special-menu">All Pages</a></li><li class='hideifsmall'><a href="/s/tags/articles.html" class="link">Articles</a></li>
<li class='hideifsmall'><a href="/s/tags/blog.html" class="link">Blog</a></li>
<li class='hideifsmall'><a href="/s/tags/tutorials.html" class="link">Tutorials</a></li>
<li class='hideifsmall'><a href="/s/tags/ansible.html" class="link">Ansible</a></li><li class='hideifsmall'><a href="/s/tags/openstack.html" class="link">Openstack</a></li><li class='hideifsmall'><a href="/s/tags/bash.html" class="link">Bash</a></li><li class='hideifsmall'><a href="/s/tags/ssl.html" class="link">SSL</a></li><li class='hideifsmall'><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li class='hideifsmall'><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li><li class='hideifsmall'><a href="/s/tags/openvms.html" class="link">OpenVMS</a></li></ul>            
               <!-- advertisement start -->
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212"><img src="https://raymii.org/s/inc/img/banner_trans.png"></a><br>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br />
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Raymii-2 -->
                <ins class="adsbygoogle"
                     style="display:inline-block;width:200px;height:200px"
                     data-ad-client="ca-pub-7993642564731324"
                     data-ad-slot="9322003332"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">
                <div id="main"></div>

           <h2 class='headheader' id='main'>Service checks in LibreNMS (http, all other Nagios plugins)</h2><ul class="breadcrumb"><li><a href="../index.html" class="link">Home</a></li><li><a href="../tags/tutorials.html" class="link">Tutorials</a></li><li><a href="Service_checks_in_LibreNMS_nagios_plugins.html" class="link">Service checks in LibreNMS (http, all other Nagios plugins)</a></li></ul><p><small>Published: 10-09-2018</small> | <small>Author: Remy van Elst | </small><a href="Service_checks_in_LibreNMS_nagios_plugins.txt" class="link"><small>Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>LibreNMS is becoming one of my favorite monitoring tools. Setup and getting started is easy and it has enough advanced options and tunables. I recently discovered that LibreNMS is able to check services as well. Services, in this context, means, executing Nagios plugins (like check<em>http, check</em>ping, etc). This allows you to check services that SNMP does not cover by default, like HTTP(s) health checks, certificate expiry, tcp port checks (e.g. rdp) and anything for which you can write a Nagios plugin yourself. The performance data, if available, is graphed automatically. Alerting is done with the regular LibreNMS alerts. This guide covers the setup of services (it&#39;s not enabled by default) and a few basic checks, like an http health check, certificate expiry and SSH monitoring.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a>  </p>

<p>You need a LibreNMS server for this guide to work. The project provides excellent documentation. To get started, get a <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean VPS</a> and follow the <a href="http://web.archive.org/web/20180910120958/https://docs.librenms.org/#Installation/Installation-Ubuntu-1804-Nginx/">official guide for Ubuntu</a>.</p>

<h3>Nagios check plugins</h3>

<p>For those unfamiliar with Nagios, it is a monitoring system which can execute checks. These checks are scripts and progams which take input (for example, which host to check, tresholds), do a check and then return an exit code and some performance data. The plugins can be in any language, Nagios only cares about the exit codes. They can be the following:</p>

<ul>
<li>0: OK</li>
<li>1: WARNING</li>
<li>2: CRITICAL</li>
<li>3: OK</li>
<li>4 and up: UNKNOWN</li>
</ul>

<p>For example, to check if a website is working, you would use the <code>check_http</code> plugin. This plugin checks if the site returns a <code>200 OK</code> and if so, gives exit status <code>0</code>. If not, for example because of a timeout, access denied or <code>50x error</code>, it will return status <code>1</code> or <code>2</code>. Nagios then can do all kinds of alerting based on those statusses. </p>

<p>Performance data is comma seperated value data added after the status output in the command result. This can be anything, for example, the time the HTTP request took. </p>

<p>Since you can write these scripts yourself any monitoring system that uses these plugins is very extensible. It can check anything you want as long as you can write a script for it. This makes the monitoring tool very powerfull, you&#39;re not limited to what they provide. </p>

<p>To read more about monitoring, <a href="https://raymii.org/s/articles/Essential_Monitoring_checks.html">you can read one of my other articles</a>.</p>

<h3>Enabling service checks</h3>

<p>Service checks are not enabled by default in LibreNMS. <a href="http://web.archive.org/web/20180910121438/https://github.com/librenms/librenms/blob/master/doc/Extensions/Services.md">The documentation</a> explains how to enable the module. In this guide I asume your path is <code>/opt/librenms/</code>. Edit your config file:</p>

<pre><code>vim /opt/librenms/config.php
</code></pre>

<p>Add the following line:</p>

<pre><code>$config[&#39;show_services&#39;]           = 1;
</code></pre>

<p>Save the file. </p>

<p>Edit the LibreNMS cronjob to include service checks:</p>

<pre><code>vim /etc/cron.d/librenms
</code></pre>

<p>Add:</p>

<pre><code>*/5  *    * * *   librenms    /opt/librenms/services-wrapper.py 1
</code></pre>

<p>Make sure the Nagios plugins are installed:</p>

<pre><code>apt-get install nagios-plugins nagios-plugins-extra
</code></pre>

<p>Do a test to see if the plugins work:</p>

<pre><code>/usr/lib/nagios/plugins/check_http -H raymii.org -S -p 443 
</code></pre>

<p>Example output:</p>

<pre><code>HTTP OK: HTTP/1.1 200 OK - 1320 bytes in 0.199 second response time |time=0.198748s;;;0.000000 size=1320B;;;0   
</code></pre>

<h4>Adding a (dummy) host</h4>

<p>You must have a host in LibreNMS to be able to add service checks. Normally you would use <code>snmp</code> to monitor devices, but if you just want to do simple (HTTP) checks without SNMP you can add a host without SNMP or TCP checks. Via <code>Devices</code>, <code>Add Device</code> you can enter an URL/IP. Uncheck the SNMP checkbox and check the <code>Force add</code> button:</p>

<p><img src="https://raymii.org/s/inc/img/librenms_svc_2.png"></p>

<p>If this device does not accept ICMP (ping) traffic, you can disable that as well. Go to the device, select the Cog menu, Edit, &quot;Misc&quot; tab, then check &quot;Disable ICMP Test?&quot;:</p>

<p><img src="https://raymii.org/s/inc/img/librenms_svc_3.png"></p>

<p>If you do want to use SNMP, here is a quick guide for Ubuntu. First install <code>snmpd</code>:</p>

<pre><code>apt-get install snmpd
</code></pre>

<p>Edit the configuration. Remove everything and add the following:</p>

<pre><code>agentAddress udp:161

createUser &lt;username&gt; SHA &quot;&lt;password&gt;&quot; AES &quot;&lt;password2&gt;&quot; 

view systemonly included .1.3.6.1.2.1.1
view systemonly included .1.3.6.1.2.1.25.1

rwuser &lt;username&gt;

sysLocation &lt;location&gt;
sysContact  &lt;your name and email&gt;

includeAllDisks 10%

defaultMonitors         yes
linkUpDownNotifications yes
</code></pre>

<p>Change <code>username</code> and <code>password</code> to a long and secure name and password (8 characters minimum). Restart snmpd:</p>

<pre><code>service snmpd restart
</code></pre>

<p><strong>Add a rule in your firewall to only allow access to UDP port 161 from your monitoring service and deny all other traffic.</strong></p>

<p>You can now add this machine in LibreNMS using SNMPv3 and the authentication data you provided.</p>

<h3>Configuring services in LibreNMS</h3>

<p>In LibreNMS you should now have a new tab button in the top menu, named &quot;Services&quot;:</p>

<p><img src="https://raymii.org/s/inc/img/librenms_svc_1.png"></p>

<p>Make sure you added a host as described above. You can navigate to a host and click the &quot;Services&quot; tab, then click &quot;Add service&quot;. In the top menu bar you can also click &quot;Services&quot;, &quot;Add Service&quot;. You then have to select the host as well.</p>

<p>The <code>type</code> is the nagios plugin you want to use. In our case, <code>http</code> (the <code>check_</code> part is not shown). </p>

<p>Enter a meaningfull description. For example, &quot;HTTP Check https://example.org/path/to/data&quot;. </p>

<p>The IP address can be the hostname or the IP. It is recommended to make this the same as the host the services are coupled to.</p>

<p>The &quot;Parameters&quot; are the Nagios check command parameters, from the shell. In the case of an HTTP check for one of the servers hosting raymii.org it would be:</p>

<pre><code>-E -I 80.211.96.38 -S -p 443 -u &quot;/s/index.html&quot;
</code></pre>

<ul>
<li><code>IP Address</code>: raymii.org</li>
<li><code>-E</code>: extended performance data</li>
<li><code>-I 80.211.96.38</code>: the specifc IP address (optional, I have multiple A records)</li>
<li><code>-S</code>: use SSL</li>
<li><code>-p 443</code>: use port 443</li>
<li><code>-u &quot;/s/index.html&quot;</code>: the URL to request. (optional)</li>
</ul>

<p><img src="https://raymii.org/s/inc/img/librenms_svc_6.png"></p>

<p>All parameters can be found on the <a href="https://www.monitoring-plugins.org/doc/man/check_http.html">monitoring-plugins</a> website. You can test on the shell first before you add the check to LibreNMS.</p>

<p>Save the dialog box and wait a few minutes for the check to run.</p>

<p>An SSH check is even simpler, just select <code>SSH</code> as the type and add the check. Here is an example of a Cisco switch where SSH is checked:</p>

<p><img src="https://raymii.org/s/inc/img/librenms_svc_7.png"></p>

<p>A certificate check, to get an alert when a certificate is about to expire, can also be done. The <code>type</code> is <code>http</code> and the parameters are:</p>

<pre><code>--sni -S -p 443 -C 30
</code></pre>

<p>It will check if the certificate expires within 30 days.</p>

<h4>Alerting</h4>

<p>There is a default alert rule in LibreNMS named <code>Service up/down</code>:</p>

<pre><code>services.service_status != 0 AND macros.device_up = 1
</code></pre>

<p>If you want to differentiate between WARNING and CRITICAL Nagios alerts, you can create two rules:</p>

<pre><code># warning
services.service_status = 1 AND macros.device_up = 1


# critical
services.service_status = 2 AND macros.device_up = 1
</code></pre>

<h3>Limits</h3>

<p>Specific alerting and rechecking when a check fails is not as configurable in Icinga or Nagios. The check will run, and alert you on a failure. Icinga/Nagios allow you to configure escalation paths and advanced re-checking. For example, when a check fails, recheck it 4 times with an interval of X seconds (instead of the regular check interval) and only alert if it still fails. </p>

<p>In Icinga you can define (service or host) groups and apply service checks to these groups. LibreNMS doesn&#39;t allow this, so you cannot define a check and apply it to a group. If you need to check 100 servers, it means defining 100 checks by hand per server.</p>

<h3>Examples</h3>

<p>Here is an example of services that are down:</p>

<p><img src="https://raymii.org/s/inc/img/librenms_svc_5.png"></p>

<p>Here is an example of a dummy host (no ICMP or SNMP) with a HTTP check and alerting enabled:</p>

<p><img src="https://raymii.org/s/inc/img/librenms_svc_4.png"></p>
</div><hr>Tags: <a href="../tags/bash.html" class="link">bash &nbsp;</a><a href="../tags/icinga.html" class="link">icinga &nbsp;</a><a href="../tags/librenms.html" class="link">librenms &nbsp;</a><a href="../tags/logging.html" class="link">logging &nbsp;</a><a href="../tags/monitoring.html" class="link">monitoring &nbsp;</a><a href="../tags/nagios.html" class="link">nagios &nbsp;</a><a href="../tags/observium.html" class="link">observium &nbsp;</a><a href="../tags/plugin.html" class="link">plugin &nbsp;</a><a href="../tags/python.html" class="link">python &nbsp;</a><a href="../tags/tutorials.html" class="link">tutorials &nbsp;</a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    