
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Ansible - Only if a file exists or does not exist - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Ansible - Only if a file exists or does not exist</h2><p><small>Published: 27-12-2014 | Author: Remy van Elst | <a href="Ansible_-_Only_if_a_file_exists_or_does_not_exist.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>This Ansible playbook example helps you execute actions only if a file exists or
does not exist. If you for example have a command you need to run to generate a
certificate (or Diffie Hellman parameters for nginx) you only want to do that
once. The command itself is not convergent so it will run with every ansible
run. However, the command creates a file and Ansible is able to check if that
file exists. If the file exists, it will not execute the action. The same goes
for checking if a file does exist and only executing the action if it exists.
(The action you want to do will remove that file).</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>The below example command will generate <a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html">Diffi Hellman parameters for NGINX
ssl</a>. This command creates the file <code>/etc/ssl/certs/dhparam.pem</code>. It should
run only if that file does not exist (because only newly deployed servers will
not have the file), if the file exist there is no need to run again.</p>

<pre><code>- name: generate dh params
command: sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048 
args: 
  creates: /etc/ssl/certs/dhparam.pem
</code></pre>

<p>Ansible has the <code>creates</code> option in the <code>command</code> module. Give it a filename
(directories will not work) and if it already exists Ansible will skip the
action.</p>

<p>The same goes for only executing an action if a file exists. The command you are
using will remove that file, so only if the file is there the action should be
executed. Just as the <code>creates</code> option, there is the <code>removes</code> option. For the
<code>removes</code> option, you need at least Ansible 0.8.</p>

<p>The below example is for a custom piece of software one of my clients uses. If
we deploy a new version, we check out the code repository and run a script to
install a new version. That script will only run when the configuration file is
renamed to <code>software.conf.upgrade</code>. After the upgrade it renamed that config
file to the original <code>software.conf</code> and also puts the config in its database.
It is sadly proprietary software and the manufacturer has stated they are not
changing the behavior to a more sane default. The below example will only run
the upgrade script when the file <code>/etc/software/software.conf.upgrade</code> exists.
Since the script removes it, the next time Ansible runs it does not try to
upgrade the software.</p>

<pre><code>- name: upgrade software
command: /opt/software/bin/upgrade 
args:
  removes: etc/software/software.conf.upgrade
</code></pre>

<p><a href="http://docs.ansible.com/command_module.html">Documentation for the Command Module</a></p>

<p>If you have other commands which do not support the <code>creates</code> option, you need
to first use the <code>stat</code> module and register the result of that. This example is
for the Shorewall firewall. We first check if the rules file exists:</p>

<pre><code>- name: check if rules file exists
  stat: 
    path: /etc/shorewall/rules
  register: shorewall_rules
</code></pre>

<p>We fill the <code>shorewall_rules</code> variable with the result of this action. The next
two actions add a rule to the rules file and restart the firewall, but only if
the rules file exists:</p>

<pre><code>- name: add firewall rule for ssh
  lineinfile: 
    dest: /etc/shorewall/rules 
    state: present 
    regexp: &quot;^ACCEPT net0:192\.0\.2\.22 \$FW tcp 5666&quot; 
    line: &quot;ACCEPT net0:192.0.2.22 $FW tcp 5666&quot;
  when: shorewall_rules.stat.exists == true

- name: restart shorewall
  command: &quot;shorewall restart&quot;
  when: shorewall_rules.stat.exists == True
</code></pre>

<p>If you want to do stuff when a file is not present, you can check if the result
is <code>False</code>, like so:</p>

<pre><code>- action: example
  when: stat_result.stat.exists == False
</code></pre>
Tags: <a href="../tags/ansible.html" class="link">ansible</a>, <a href="../tags/configuration-management.html" class="link">configuration-management</a>, <a href="../tags/deployment.html" class="link">deployment</a>, <a href="../tags/devops.html" class="link">devops</a>, <a href="../tags/nginx.html" class="link">nginx</a>, <a href="../tags/openssl.html" class="link">openssl</a>, <a href="../tags/tutorials.html" class="link">tutorials</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    