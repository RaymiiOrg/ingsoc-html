
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Ansible - sudoers safety and sanity checking in playbook - Raymii.org</title>
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <script src="/s//inc/js/instant.js"></script> 
        <script src="/s//inc/js/toc.js"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="/s/inc/img/resistor-50.png" alt="Logo (IEC resistor symbol)">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Ansible - sudoers safety and sanity checking in playbook</h2>
<p><small>Published: 23-03-2013 | Author: Remy van Elst | <a href="Ansible_-_Sudo_Safety_and_Sanity_Checks.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc">
<h3>Table of Contents</h3>
</div>
<hr>
<div id="contents">
<p>Using Ansible to manage the /etc/sudoers file is fine, except when you have a
syntax error in your template. This method helps you to only deploy a correct
sudoers file.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>I manage the <code>sudo</code> config (<code>/etc/sudoers/</code>) via Ansible. My sudo playbook
creates an admin group, adds me to that admin group, and sets some variables in
<code>/etc/sudoers/</code>. I do not have a sudoers template file, because I created the
playbook at a client which has various different sudoers files, which they do
not want to have changed ,because of different nagios checks that needed sudo on
different hosts. However, if you start of clean, then a template file for
<code>/etc/sudoers</code> is the best choice.</p>

<p>This is the playbook:</p>

<pre><code>    ---
      - hosts: all
        sudo: True
        user: remy
        connection: ssh # or paramiko

        vars:
          distro: {{ ansible_distribution }}
          pkg_mgr: {{ ansible_pkg_mgr }}
          pbname: {{ inventory_hostname }}

        tasks:

        - name: Copy sudoers file for safety
          command: cp -f /etc/sudoers /etc/sudoers.tmp

        - name: Create sudoers file backup
          command: cp -f /etc/sudoers /etc/sudoers.bak

        - name: Create admins group
          group: name=admins system=yes state=present

        - name: make sure we can sudo as admin group
          lineinfile: dest=/etc/sudoers.tmp state=present regexp=&#39;^%admin&#39; line=&#39;%admin ALL=(ALL) ALL&#39;

        - name: also make sure ssh-agent works via sudo
          lineinfile: dest=/etc/sudoers.tmp state=present regexp=&#39;^Defaults env_keep\+\=SSH_AUTH_SOCK&#39; line=&#39;Defaults env_keep+=SSH_AUTH_SOCK&#39;

        - name: Final sudoers file check
          shell: visudo -q -c -f /etc/sudoers.tmp &amp;&amp; cp -f /etc/sudoers.tmp /etc/sudoers
</code></pre>

<ul>
<li><p>We create the <code>admins</code> group, to which all users that need sudo are added by other playbooks. </p></li>
<li><p>We copy the remote sudoers file to a temp one and perform all actions on the temp sudoers file. We also back up the sudoers file.</p></li>
<li><p>We enable the <code>admins</code> group to sudo</p></li>
<li><p>We make sure <code>ssh-agent</code> works via sudo. This was used for a git repository on the root user account, to show our own names in the commits.</p></li>
<li><p>Finally we use <code>visudo</code> to check if the file is correct, and if so we copy the file over the &quot;original&quot; sudos file.</p></li>
</ul>

<p>By using the temp file we make sure we don&#39;t have any syntax errors and lock
ourselves out of machines, needing to use ILO/DRAC to reset passwords and such.
Been there, done that, not funny at all.</p>
Tags: <a href="../tags/ansible.html">ansible</a>
, <a href="../tags/configuration-management.html">configuration-management</a>
, <a href="../tags/deployment.html">deployment</a>
, <a href="../tags/python.html">python</a>
, <a href="../tags/sudo.html">sudo</a>
, <a href="../tags/sudoers.html">sudoers</a>
, <a href="../tags/tutorials.html">tutorials</a>
, <a href="../tags/visudo.html">visudo</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
     
    </main>
    </body>
    </html>
    