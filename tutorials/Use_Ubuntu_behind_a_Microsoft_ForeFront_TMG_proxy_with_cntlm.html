
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Use Ubuntu behind a Microsoft ForeFront TMG proxy with cntlm - Raymii.org</title>
        <link href="/s/inc/css/custom-first.css" rel="stylesheet" />
        <!-- <link href="/s/inc/css/light.css" rel="stylesheet"  />
        # <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        <a class="skip-main" href="#main">Skip to main content</a>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a> | <a href="gopher://raymii.org:70">Gopher</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/index.html" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/tags/all.html" class="special-menu">All Pages</a></li><li class='hideifsmall'><a href="/s/tags/articles.html" class="link">Articles</a></li>
<li class='hideifsmall'><a href="/s/tags/blog.html" class="link">Blog</a></li>
<li class='hideifsmall'><a href="/s/tags/tutorials.html" class="link">Tutorials</a></li>
<li class='hideifsmall'><a href="/s/tags/ansible.html" class="link">Ansible</a></li><li class='hideifsmall'><a href="/s/tags/openstack.html" class="link">Openstack</a></li><li class='hideifsmall'><a href="/s/tags/bash.html" class="link">Bash</a></li><li class='hideifsmall'><a href="/s/tags/ssl.html" class="link">SSL</a></li><li class='hideifsmall'><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li class='hideifsmall'><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li><li class='hideifsmall'><a href="/s/tags/openvms.html" class="link">OpenVMS</a></li></ul>            
               <!-- advertisement start -->
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212"><img src="https://raymii.org/s/inc/img/banner_trans.png"></a><br>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br />
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Raymii-2 -->
                <ins class="adsbygoogle"
                     style="display:inline-block;width:200px;height:200px"
                     data-ad-client="ca-pub-7993642564731324"
                     data-ad-slot="9322003332"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">
                <div id="main"></div>

           <h2 class='headheader' id='main'>Use Ubuntu behind a Microsoft ForeFront TMG proxy with cntlm</h2><ul class="breadcrumb"><li><a href="../index.html" class="link">Home</a></li><li><a href="../tags/tutorials.html" class="link">Tutorials</a></li><li><a href="Use_Ubuntu_behind_a_Microsoft_ForeFront_TMG_proxy_with_cntlm.html" class="link">Use Ubuntu behind a Microsoft ForeFront TMG proxy with cntlm</a></li></ul><p><small>Published: 27-10-2018</small> | <small>Author: Remy van Elst | </small><a href="Use_Ubuntu_behind_a_Microsoft_ForeFront_TMG_proxy_with_cntlm.txt" class="link"><small>Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p><img src="https://raymii.org/s/inc/img/tmg.png"></p>

<p>Recently I had to deploy a few machines in a network where outgoing network access was forced through a Microsoft Forefront TMG proxy. For all the Windows clients this went automatically due to domain policies, for Linux this has to be set up manually. Defining the proxy in <code>/etc/environment</code> was not enough since NTML authentication is required, which is not supported by default. I found <code>cntlm</code>, a piece of software which acts as a local proxy, translating all requests to authenticated NTLM requests to your upstream proxy. This guide covers the (offline) installation, setup, getting the correct password hash and system-wide configuration. It should work on a desktop as well, but I did not test that.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a>  </p>

<p>This guide was tested on both Ubuntu 16.04 and 18.04. You need a user account with the correct permissions for the proxy. The account will be locked, so make sure you have access the the Active Directory to unlock it when needed.</p>

<h3>Installing cntlm</h3>

<p>If you can get a temporary exeption for the machine, you can use your favorite package manager to install cntlm:</p>

<pre><code>apt-get install cntlm
</code></pre>

<p>If you have no network access, download the package from <a href="https://packages.ubuntu.com/xenial/cntlm">the ubuntu packages site</a>. The <code>dpkg</code> file has no dependencies other than <code>libc</code>. </p>

<p>Place it on the server and install it:</p>

<pre><code>dpkg -i cntlm*.deb
</code></pre>

<p>Make sure the service is not started yet:</p>

<pre><code>systemctl stop cntlm
</code></pre>

<h3>Configuring cntlm</h3>

<p>The configuration file lives in <code>/etc/cntlm.conf</code> and is very simple. You can setup cntlm as a proxy for other servers, but that is not in the scope of this guide. For me, I used Ansible to configure these few servers. </p>

<p>You can put the password as plaintext in the configuration file, but we are not going to do that since the software supports placing the ntlm hash directly.</p>

<p>First we use the commandline to figure out which type of hash is used. Use the <code>-M</code> (magic) parameter with a username and password to autodetect the correct settings:</p>

<pre><code>cntlm -u $USERNAME@$ADDOMAIN -M http://raymii.org proxy.$ADDOMAIN.EXT 8080
Password: 
</code></pre>

<p>Example output:</p>

<pre><code>Config profile  1/4... OK (HTTP code: 200)
----------------------------[ Profile  0 ]------
Auth            NTLMv2
PassNTLMv2      AAAAAAABBBBBBBBBXXXXXXX99999AAAA
------------------------------------------------
</code></pre>

<p>The username format is <code>$USERNAME@$domain</code>. The password is your domain account&#39;s password. The last two parameters are the proxy hostname/ip and port.</p>

<p>In this case we have the NTLMv2 hash and the output format. In other cases, there might be an NTLM hash, an NT hash, an LM hash or any combination.</p>

<p>In the configuration file, abide to the following rules:</p>

<ul>
<li>Auth is NT: use only PassNT</li>
<li>Auth is LM: use only PassLM</li>
<li>Auth is NTLM: use both PassLM and PassNT</li>
<li>Auth is NTLMv2: use only PassNTLMv2</li>
</ul>

<p>If you cannot connect right away or need to generate the hash offline, cntlm can do that as well:</p>

<pre><code>echo &quot;P@ssw0rd&quot; | cntlm -H -u $USERNAME -d $ADDOMAIN 
</code></pre>

<p>Output:</p>

<pre><code>Password: 
PassLM          xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
PassNT          yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
PassNTLMv2      AAAAAAABBBBBBBBBXXXXXXX99999AAAA    # Only for user &#39;$USERNAME&#39;, domain &#39;$ADDOMAIN&#39;
</code></pre>

<p>Use your favorite editor to place these values in the configuration file.</p>

<pre><code>vim /etc/cntlm.conf
</code></pre>

<p>The file is self-explanatory, but read through it if you want to setup a gateway. Here is the config we need for the above setup:</p>

<pre><code>Username    $USERNAME
Domain      $ADDOMAIN
PassNTLMv2  AAAAAAABBBBBBBBBXXXXXXX99999AAAA
Auth        NTLMv2
Workstation $SERVER_HOSTNAME
Proxy       proxy.$ADDOMAIN.EXT:8080
NoProxy     localhost, 127.0.0.*, 10.*, 192.168.*
Listen      3128
</code></pre>

<p><code>WorkStation</code> is optional, by default the system hostname is used. The other values like <code>Proxy</code> and <code>Listen</code> are self-explanatory as well.</p>

<p>When your configuration file is done, make sure only root can read it:</p>

<pre><code>chmod 600 /etc/cntlm.conf
</code></pre>

<p>Start the service:</p>

<pre><code>systemctl start cntlm
</code></pre>

<h3>Testing cntlm</h3>

<p>Use either cntlm itself with debug on, or a tool like curl with the proxy configured to test the local proxy. </p>

<h4>Testing with curl</h4>

<p>curl has the <code>-x</code> option to provide a proxy. Since <code>cntlm</code> is configured and listening on <code>127.0.0.1:3128</code> we can use it to test with curl:</p>

<pre><code>curl -v -x http://127.0.0.1:3128/ http://raymii.org
</code></pre>

<p>Example output:</p>

<pre><code>* Rebuilt URL to: raymii.org/
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
&gt; GET http://raymii.org/ HTTP/1.1
&gt; Host: raymii.org
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
[...]
&lt; HTTP/1.1 200 OK
&lt; Via: 1.1 proxy
&lt; Connection: Keep-Alive
&lt; Proxy-Connection: Keep-Alive
&lt; Content-Length: 376
[...]
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 3.2//EN&quot;&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta name=&quot;generator&quot; content=&quot;newspeak.py&quot;&gt;
&lt;title&gt;Raymii.org&lt;/title&gt;
&lt;meta http-equiv=&quot;REFRESH&quot; content=&quot;0; url=https://raymii.org/s/&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
You should be redirected to &lt;a href=&quot;https://raymii.org/s/&quot;&gt;https://raymii.org/s/. If that is not the case, please click here to continue.&lt;/a&gt;
&lt;/body&gt;
* Connection #0 to host 127.0.0.1 left intact
</code></pre>

<p>As you can see, the proxy is used and working. If it is not, the output will include something like below:  </p>

<pre><code># lots of html
 407 Proxy Authentication Required. Forefront TMG requires authorization to fulfill the request. Access to the Web Proxy filter is denied. (12209).
</code></pre>

<p>Your password hash could be wrong, the account might be locked out or the other authentication credentials are wrong.</p>

<h4>Testing with cntlm</h4>

<p>Using the <code>-v</code> option, for verbose with the <code>-M</code> option as before, we can test the connection.</p>

<pre><code>cntlm -fv -c /etc/cntlm.conf -M http://raymii.org
</code></pre>

<p>Output:</p>

<pre><code>section: global, Username = &#39;$USERNAME&#39;
section: global, Domain = &#39;$ADDOMAIN&#39;
section: global, PassNTLMv2 = &#39;AAAAAAABBBBBBBBBXXXXXXX99999AAAA&#39;
section: global, Auth = &#39;NTLMv2&#39;
section: global, Workstation = &#39;$SERVER_HOSTNAME&#39;
section: global, Proxy = &#39;proxy.$ADDOMAIN.EXT:8080&#39;
section: global, NoProxy = &#39;localhost, 127.0.0.*, 10.*, 192.168.*&#39;
section: global, Listen = &#39;3128&#39;
cntlm: Proxy listening on 127.0.0.1:3128
Adding no-proxy for: &#39;localhost&#39;
Adding no-proxy for: &#39;127.0.0.*&#39;
Adding no-proxy for: &#39;10.*&#39;
Adding no-proxy for: &#39;192.168.*&#39;
cntlm: Using proxy proxy.$ADDOMAIN.EXT:8080
cntlm: Resolving proxy proxy.$ADDOMAIN.EXT...
Config profile  1/4... Resolve proxy.$ADDOMAIN.EXT:
  -&gt; 192.0.2.10
NTLM Request:
       Domain: $ADDOMAIN
     Hostname: $SERVER_HOSTNAME
        Flags: 0xA208B205

Sending PROXY auth request...
Proxy-Connection               =&gt; keep-alive
Host                           =&gt; raymii.org
Proxy-Authorization            =&gt; NTLM xxxx
Content-Length                 =&gt; 0

Reading PROXY auth response...
HEAD: HTTP/1.1 407 Proxy Authentication Required ( Access is denied.  )
Via                            =&gt; 1.1 proxy
Proxy-Authenticate             =&gt; NTLM xxxx
Connection                     =&gt; Keep-Alive
Proxy-Connection               =&gt; Keep-Alive
Pragma                         =&gt; no-cache
Cache-Control                  =&gt; no-cache
Content-Type                   =&gt; text/html
Content-Length                 =&gt; 0
NTLM Challenge:
    Challenge: xxx (len: 208)
        Flags: 0xA2898205
    NT domain: $ADDOMAIN
       Server: proxy
       Domain: $ADDOMAIN.EXT
         FQDN: proxy.$ADDOMAIN.EXT
          TLD: $ADDOMAIN.EXT
            7: 
        TBofs: 66
        TBlen: 142
        ttype: 0
NTLMv2:
        Nonce: xxxxxxxxxxxxxxxxxx
    Timestamp: 131850205990000000
NTLM Response:
     Hostname: &#39;$SERVER_HOSTNAME&#39;
       Domain: &#39;$ADDOMAIN&#39;
     Username: &#39;$USERNAME&#39;
     Response: &#39;xxxx&#39; (190)
     Response: &#39;xxxx&#39; (24)
HEAD: HTTP/1.1 200 OK
OK (HTTP code: 200)
----------------------------[ Profile  0 ]------
Auth            NTLMv2
PassNTLMv2      AAAAAAABBBBBBBBBXXXXXXX99999AAAA
------------------------------------------------
cntlm: Terminating with 0 active threads
</code></pre>

<p>The <code>200 OK</code> is what we&#39;re looking for. Stuff like below is wrong, just as above, check your credentials and config:</p>

<pre><code>HEAD: HTTP/1.1 407 Proxy Authentication Required ( Forefront TMG requires authorization to fulfill the request. Access to the Web Proxy filter is denied.  )
Credentials rejected

Wrong credentials, invalid URL or proxy doesn&#39;t support NTLM nor BASIC.
</code></pre>

<p>The account will be locked, so make sure you have access the the Active Directory to unlock it.</p>

<h3>Systemwide proxy configuration</h3>

<p>When the proxy is working, you make it available for the entire system. Most software will understand this, but make sure to check the specific manpages if software is not working for you.</p>

<p>Edit the following file:</p>

<pre><code>vim /etc/environment
</code></pre>

<p>Append the following:</p>

<pre><code>http_proxy=&quot;http://127.0.0.1:3128/&quot;
https_proxy=&quot;http://127.0.0.1:3128/&quot;
ftp_proxy=&quot;http://127.0.0.1:3128/&quot;
no_proxy=&quot;localhost,127.0.0.1,localaddress,.localdomain.com&quot;

HTTP_PROXY=&quot;http://127.0.0.1:3128/&quot;
HTTPS_PROXY=&quot;http://127.0.0.1:3128/&quot;
FTP_PROXY=&quot;http://127.0.0.1:3128/&quot;
NO_PROXY=&quot;localhost,127.0.0.1,localaddress,.localdomain.com&quot;
</code></pre>

<p>Save it and logout. Log back in to make it active.</p>

<p>For <code>apt-get</code>, you need to edit the following file:</p>

<pre><code>vim /etc/apt/apt.conf
</code></pre>

<p>Append the following:</p>

<pre><code>Acquire::http::proxy &quot;http://127.0.0.1:3128/&quot;;
Acquire::ftp::proxy &quot;ftp://127.0.0.1:3128/&quot;;
Acquire::https::proxy &quot;https://127.0.0.1:3128/&quot;;
</code></pre>

<p>After logging out and in, test it with curl once again, but now without the <code>-x</code> option (so no proxy is specified, but the system proxy is used):</p>

<pre><code>curl -v raymii.org
</code></pre>

<p>Output:</p>

<pre><code>* Rebuilt URL to: raymii.org/
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
&gt; GET http://raymii.org/ HTTP/1.1
&gt; Host: raymii.org
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt; Proxy-Connection: Keep-Alive
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Via: 1.1 proxy
&lt; Connection: Keep-Alive
</code></pre>
</div><hr>Tags: <a href="../tags/cntlm.html" class="link">cntlm &nbsp;</a><a href="../tags/microsoft.html" class="link">microsoft &nbsp;</a><a href="../tags/ntlm.html" class="link">ntlm &nbsp;</a><a href="../tags/proxy.html" class="link">proxy &nbsp;</a><a href="../tags/server.html" class="link">server &nbsp;</a><a href="../tags/tutorials.html" class="link">tutorials &nbsp;</a><a href="../tags/ubuntu.html" class="link">ubuntu &nbsp;</a><a href="../tags/windows.html" class="link">windows &nbsp;</a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    