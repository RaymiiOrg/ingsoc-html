
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Simple keepalived failover setup on Ubuntu 14.04 - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Simple keepalived failover setup on Ubuntu 14.04</h2><p><small>Published: 13-06-2014 | Author: Remy van Elst | <a href="Keepalived-Simple-IP-failover-on-Ubuntu.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>We are going to set up very simple keepalived IP failover on Ubuntu 14.04.
Keepalived is a piece of software which can be used to achieve high availability
by assigning two or more nodes a virtual IP and monitoring those nodes, failing
over when one goes down. Keepalived can do more, like load balancing and
monitoring, but this tutorial focusses on a very simple setup, just IP failover.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>Internally keepalived uses VRRP. The VRRP protocol ensures that one of
participating nodes is master. The backup node(s) listens for multicast packets
from a node with a higher priority. If the backup node fails to receive VRRP
advertisements for a period longer than three times of the advertisement timer,
the backup node takes the master state and assigns the configured IP(s) to
itself. In case there are more than one backup nodes with the same priority, the
one with the highest IP wins the election.</p>

<p>I&#39;m also a fan of Corosync/Pacemaker, you can see my articles about <a href="https://raymii.org/s/tags/corosync.html">Corosync
here</a>.</p>

<p>We&#39;ll install nginx and edit the default webpage, just to see where the IP is
pointing to.</p>

<h3>Requirements</h3>

<p>You&#39;ll need the following to get started with keepalived:</p>

<ul>
<li>2 servers in the same network</li>
</ul>

<p>I&#39;ll be using Ubuntu 14.04 servers in this example. These servers are in the
<code>10.32.75.0/24</code> network. The virtual IP will be <code>10.32.75.200</code>.</p>

<h3>Install packages</h3>

<p>Use apt to install the required packages:</p>

<pre><code>apt-get install nginx keepalived
</code></pre>

<h3>Configuring keepalived</h3>

<p>Create the config file on the first server (<code>10.32.75.12</code>):</p>

<pre><code>vim /etc/keepalived/keepalived.conf
</code></pre>

<p>Edit and paste the following config:</p>

<pre><code>! Configuration File for keepalived

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass $ place secure password here.
    }
    virtual_ipaddress {
        10.32.75.200
    }
}
</code></pre>

<p>Create the config file on the second server (<code>10.32.75.14</code>):</p>

<pre><code>vim /etc/keepalived/keepalived.conf
</code></pre>

<p>Edit and paste the following config:</p>

<pre><code>! Configuration File for keepalived

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass $ place secure password here.
    }
    virtual_ipaddress {
        10.32.75.200
    }
}
</code></pre>

<p>The <code>priority</code> must be highest on the server you want to be the master/primary.
It can be 150 on the master, and 100, 99, 98, 97 on the slaves. The
<code>virtual_router_id</code> must be the same on all nodes and the <code>auth_pass</code> must also
be the same. My network configuration is on <code>eth0</code>, change it if yours is on
another one.</p>

<h3>Configuring NGINX</h3>

<p>For this example I have set up a very simple NGINX server with a very simple
HTML page.</p>

<pre><code>vim /usr/share/nginx/html/index.html
</code></pre>

<p>Server 1:</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Keepalived 1!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Keepalived 1 - MASTER!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Server 2:</p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Keepalived 2!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Keepalived 2 - backup!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h4>sysctl</h4>

<p>In order to be able to bind on a IP which is not yet defined on the system, we
need to enable non local binding at the kernel level.</p>

<p>Temporary:</p>

<pre><code>echo 1 &gt; /proc/sys/net/ipv4/ip_nonlocal_bind
</code></pre>

<p>Permanent:</p>

<p>Add this to <code>/etc/sysctl.conf</code>:</p>

<pre><code>net.ipv4.ip_nonlocal_bind = 1
</code></pre>

<p>Enable with:</p>

<pre><code>sysctl -p
</code></pre>

<h3>Start &amp; Failover</h3>

<p>When the website is set up we can start both NGINX and Keepalived on both
servers:</p>

<pre><code>service keepalived start
service nginx start
</code></pre>

<p>Visit the IP you configured as a failover IP in your browser. You should see the
page for server 1.</p>

<p>Let&#39;s do a test failover. On server 1, stop keepalived:</p>

<pre><code>service keepalived stop
</code></pre>

<p>Refresh the webpage. You should see the page for server 2. The logging will show
something like this:</p>

<pre><code>tail /var/log/syslog
</code></pre>

<p>Output:</p>

<pre><code>Jun 13 22:50:59 ha2-ubu1 Keepalived_vrrp[1579]: VRRP_Instance(VI_1) Transition to MASTER STATE
Jun 13 22:51:00 ha2-ubu1 Keepalived_vrrp[1579]: VRRP_Instance(VI_1) Entering MASTER STATE
Jun 13 22:51:01 ha2-ubu1 ntpd[1445]: Listen normally on 9 eth0 10.32.75.200 UDP 123
Jun 13 22:51:01 ha2-ubu1 ntpd[1445]: peers refreshed
Jun 13 22:51:01 ha2-ubu1 ntpd[1445]: new interface(s) found: waking up resolver
</code></pre>

<p>As you can see, for a simple IP failover, keepalived is much simpler than
corosync/pacemaker to set up.</p>

<p>You can read more on keepalived on <a href="http://keepalived.org">their website</a>. Another article <a href="http://gcharriere.com/blog/?p=339">here</a>
describes how to do load balancing with keepalived.</p>
Tags: <a href="../tags/cluster.html" class="link">cluster</a>, <a href="../tags/heartbeat.html" class="link">heartbeat</a>, <a href="../tags/high-availability.html" class="link">high-availability</a>, <a href="../tags/keepalived.html" class="link">keepalived</a>, <a href="../tags/network.html" class="link">network</a>, <a href="../tags/tutorials.html" class="link">tutorials</a>, <a href="../tags/vrrp.html" class="link">vrrp</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    