
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>nginx 1.15.2, ssl_preread_protocol, multiplex HTTPS and SSH on the same port - Raymii.org</title>
        <link href="/s/inc/css/custom-first.css" rel="stylesheet" />
        <!-- <link href="/s/inc/css/light.css" rel="stylesheet"  />
        # <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        <a class="skip-main" href="#main">Skip to main content</a>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a> | <a href="gopher://raymii.org:70">Gopher</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/index.html" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/tags/all.html" class="special-menu">All Pages</a></li><li class='hideifsmall'><a href="/s/tags/articles.html" class="link">Articles</a></li>
<li class='hideifsmall'><a href="/s/tags/blog.html" class="link">Blog</a></li>
<li class='hideifsmall'><a href="/s/tags/tutorials.html" class="link">Tutorials</a></li>
<li class='hideifsmall'><a href="/s/tags/ansible.html" class="link">Ansible</a></li><li class='hideifsmall'><a href="/s/tags/openstack.html" class="link">Openstack</a></li><li class='hideifsmall'><a href="/s/tags/bash.html" class="link">Bash</a></li><li class='hideifsmall'><a href="/s/tags/ssl.html" class="link">SSL</a></li><li class='hideifsmall'><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li class='hideifsmall'><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li><li class='hideifsmall'><a href="/s/tags/openvms.html" class="link">OpenVMS</a></li></ul>            
               <!-- advertisement start -->
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212"><img src="https://raymii.org/s/inc/img/banner_trans.png"></a><br>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $100 free credit.</a><br />
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Raymii-2 -->
                <ins class="adsbygoogle"
                     style="display:inline-block;width:200px;height:200px"
                     data-ad-client="ca-pub-7993642564731324"
                     data-ad-slot="9322003332"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">
                <div id="main"></div>

           <h2 class='headheader' id='main'>nginx 1.15.2, ssl_preread_protocol, multiplex HTTPS and SSH on the same port</h2><ul class="breadcrumb"><li><a href="../index.html" class="link">Home</a></li><li><a href="../tags/tutorials.html" class="link">Tutorials</a></li><li><a href="nginx_1.15.2_ssl_preread_protocol_multiplex_https_and_ssh_on_the_same_port.html" class="link">nginx 1.15.2, ssl_preread_protocol, multiplex HTTPS and SSH on the same port</a></li></ul><p><small>Published: 06-08-2018</small> | <small>Author: Remy van Elst | </small><a href="nginx_1.15.2_ssl_preread_protocol_multiplex_https_and_ssh_on_the_same_port.txt" class="link"><small>Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>The NGINX blog recently had a <a href="http://web.archive.org/web/20180806131633/https://www.nginx.com/blog/running-non-ssl-protocols-over-ssl-port-nginx-1-15-2/">nice article on a new feature of NGINX 1.15.2, $ssl<em>preread</em>protocol</a>. This allows you to multiplex HTTPS and other SSL protocols on the same port, or as their blog states, &#39;to distinguish between SSL/TLS and other protocols when forwarding traffic using a TCP (stream) proxy&#39;. This can be used to run SSH and HTTPS on the same port (or any other SSL protocol next to HTTPS). By running SSH and HTTPS on the same port, one can circumvent certain firewall restrictions. If the session looks like HTTPS, nginx will handle it, if it looks like something else, it will forward it to the configured other program. I used to use <a href="https://github.com/yrutschle/sslh">SSLH</a> to get this functionality, but now it&#39;s built into the nginx webserver. </p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a>  </p>

<p>This small guide will cover the installation of the latest version of nginx on Ubuntu (16.04) and configuring this multiplex feature.</p>

<p>You must use NGINX in proxy mode. This means that nginx will act as a load balancer or proxy in front of your application (like Django, Rails, etc). </p>

<h3>Install the latest version of NGINX</h3>

<p>nginx provides <a href="http://nginx.org/en/linux_packages.html#mainline">a repository</a> for both CentOS, Debian/Ubuntu and SUSE. In this example we will use Ubuntu. </p>

<p>Download the signing key:</p>

<pre><code>wget http://nginx.org/keys/nginx_signing.key
</code></pre>

<p>Add the repository:</p>

<pre><code>echo &quot;deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx&quot; &gt; /etc/apt/sources.list.d/nginx.list
echo &quot;deb-src http://nginx.org/packages/mainline/ubuntu/ xenial nginx&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list
</code></pre>

<p>Replace <code>xenial</code> with your version of Ubuntu (use <code>lsb_release -a</code> to find out).</p>

<p>Install nginx:</p>

<pre><code>apt-get update; 
apt-get install nginx
</code></pre>

<h3>Configure nginx for ssl<em>preread</em>protocol</h3>

<p>Quoted from the <a href="http://web.archive.org/web/20180806131633/https://www.nginx.com/blog/running-non-ssl-protocols-over-ssl-port-nginx-1-15-2/">nginx blog</a>:</p>

<p>The following configuration snippet uses the <code>$ssl_preread_protocol</code> variable in a map block to set the <code>$upstream variable</code> to the name of the upstream group appropriate for the protocol being used on the connection. The <code>proxy_pass</code> directive then forwards the request to the selected upstream group. Note that the <code>ssl_preread</code> on directive must be included in the server block for the <code>$ssl_preread_protocol</code> variable to work.</p>

<pre><code>stream {
    upstream ssh {
        server 192.0.2.10:22;
    }

    upstream https {
        server 192.0.2.20:443;
    }

    map $ssl_preread_protocol $upstream {
        default ssh;
        &quot;TLSv1.2&quot; web;
    }

    # SSH and SSL on the same port
    server {
        listen 443;

        proxy_pass $upstream;
        ssl_preread on;
    }
}
</code></pre>

<p>In this case, if the protocol detected is <code>TLSv1.2</code>, HTTPS is assumed and the traffix is forwarded to the HTTPS server (192.0.2.20). Otherwise the traffic is forwarded to the SSH host (192.0.2.10).</p>

<h3>More fun with ssl_preread</h3>

<p>The <code>ssl_preread</code> module can detect more than the protocol. The SNI server name is also supported, which allows for proxy forwarding to different backend servers based on the requested SSL hostname. <a href="http://web.archive.org/web/20180806133249/https://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html">Quoting the documentation</a>:</p>

<pre><code>map $ssl_preread_server_name $name {
    backend.example.com      backend;
    default                  backend2;
}

upstream backend {
    server 192.168.0.1:12345;
    server 192.168.0.2:12345;
}

upstream backend2 {
    server 192.168.0.3:12345;
    server 192.168.0.4:12345;
}

server {
    listen      12346;
    proxy_pass  $name;
    ssl_preread on;
}
</code></pre>

<p>Do note that this also requires a newer version of nginx than by default in the Ubuntu 16.04 release.</p>
</div><hr>Tags: <a href="../tags/firewall.html" class="link">firewall &nbsp;</a><a href="../tags/folder.html" class="link">folder &nbsp;</a><a href="../tags/multiplex.html" class="link">multiplex &nbsp;</a><a href="../tags/nginx.html" class="link">nginx &nbsp;</a><a href="../tags/proxy.html" class="link">proxy &nbsp;</a><a href="../tags/security.html" class="link">security &nbsp;</a><a href="../tags/ssh.html" class="link">ssh &nbsp;</a><a href="../tags/sslh.html" class="link">sslh &nbsp;</a><a href="../tags/subfolder.html" class="link">subfolder &nbsp;</a><a href="../tags/tutorials.html" class="link">tutorials &nbsp;</a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    