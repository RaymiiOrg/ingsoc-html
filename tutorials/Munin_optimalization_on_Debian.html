
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Munin optimization guide for Debian (rrdcached, tmpfs, ionice and nice) - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Munin optimization guide for Debian (rrdcached, tmpfs, ionice and nice)</h2><p><small>Published: 08-12-2012 | Author: Remy van Elst | <a href="Munin_optimalization_on_Debian.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>This guide will help you tune the performance of Munin. When Munin monitors more
than a few hosts the performance goes down and it requires more resources. This
gets better with newer releases, but it still is not perfect. You can limit
munin yourself so that the IO performance gets better.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>This guide assumes a working munin setup (1.4 or 2.0) on debian/ubuntu. It also
assumes root access to the server (either su or sudo).</p>

<h4>rrdcached</h4>

<p>rrdcached is as the name implies a caching daemon for rrd. Munin uses rrd for
the database, and updates the rrd files every 5 minutes, which gives a lot of
random IO. rrdcached makes the writes more sequential and less often.</p>

<p><em>Do note that rrdcached is only fully supported in munin 2.0. Usage on 1.4 is
not supported.</em></p>

<p>First install it:</p>

<pre><code>apt-get install rrdcached
</code></pre>

<p>Then run the below command to create an rrd socket</p>

<pre><code>sudo -u munin /usr/bin/rrdcached 
  -p /run/munin/rrdcached.pid 
  -B -b /var/lib/munin/ 
  -F -j /var/lib/munin/rrdcached-journal/ 
  -m 0660 -l unix:/run/munin/rrdcached.sock 
  -w 1800 -z 1800 -f 3600
</code></pre>

<p>Make sure to add it to <code>/etc/rc.local</code>.</p>

<p>Now add the following to your <code>/etc/munin/munin.conf</code> to enable the socket:</p>

<pre><code>rrdcached_socket /run/munin/rrdcached.sock
</code></pre>

<p>Some info about the command:</p>

<pre><code>RRDCached writes the spool data every 5 minutes by default. This is the same as the munin master. To have an effect, change the flushing intervals to allow more data to be spooled. Use the following parameters, and tune to your liking:

-w 1800 Wait 30 minutes before writing data
-z 1800 Delay writes by a random factor of up to 30 minutes (this should be equal to, or lower than, -w)
-f 3600 Flush all data every hour
</code></pre>

<p>By default munin-graph runs every 5 minutes so the caching we do above will not
work if the data is read every 5 minutes. To solve this we split the munin-
updating and the munin-graphing.</p>

<p>Edit the file <code>/etc/cron.d/munin</code>, add the following line:</p>

<pre><code>10 * * * *      munin if [ -x /usr/bin/munin-graph ]; then /usr/bin/munin-graph; fi
</code></pre>

<p>The file <code>/usr/bin/munin-graph</code> does not exist yet, we are going to create it:</p>

<pre><code>nano /usr/bin/munin-graph
</code></pre>

<p>Now add this:</p>

<pre><code>#!/bin/bash
# We always launch munin-html.
# It is a noop if html_strategy is &amp;quot;cgi&amp;quot;
nice /usr/share/munin/munin-html $@ || exit 1

# The result of munin-html is needed for munin-graph.
# It is a noop if graph_strategy is &amp;quot;cgi&amp;quot;
nice /usr/share/munin/munin-graph --cron $@ || exit 1 
</code></pre>

<p>and make it executable:</p>

<pre><code>chmod +x /usr/bin/munin-graph
</code></pre>

<p>Now we edit the <code>/usr/bin/munin-cron</code> file and comment out the lines we put in
the <code>munin-graph</code> file:</p>

<pre><code>[...]
# We always launch munin-html.
# It is a noop if html_strategy is &amp;quot;cgi&amp;quot;
# nice /usr/share/munin/munin-html $@ || exit 1

# The result of munin-html is needed for munin-graph.
# It is a noop if graph_strategy is &amp;quot;cgi&amp;quot;
# nice /usr/share/munin/munin-graph --cron $@ || exit 1   
</code></pre>

<p>By doing this, the munin-update runs every 5 minutes, and the graphing and HTML
page creation runs only once per hour. This prevents data loss, and I dont think
you are going to look at the graphs every 5 minutes. Whenever you need to have
faster updates, just change the crontab file to also create the munin-graphs
more often.</p>

<h4>nice and ionice</h4>

<p>This little tweak to the munin-cron file makes it IO and CPU friendlier. Note
that you need to use the default disk-scheduler for the ionice to work. Also
check the syntax of the nice command, different versions exist.</p>

<p>Edit the <code>/etc/cron.d/munin</code> file and change the cronjob:</p>

<pre><code>*/5 * * * *     munin if [ -x /usr/bin/munin-cron ]; then /usr/bin/ionice -c 3 /usr/bin/nice -n 19 /usr/bin/munin-cron; fi
</code></pre>

<p>If you have applied the above tweak with rrdcached then you can also make the
other cronjob nicer:</p>

<pre><code>10 * * * *      munin if [ -x /usr/bin/munin-graph ]; then /usr/bin/ionice -c 3 /usr/bin/nice -n 19 /usr/bin/munin-graph; fi
</code></pre>

<h4>munin html and graphs in RAM</h4>

<p>By mounting the folder where munin creates the HTML (in my case
<code>/var/www/munin</code>) we lower the IO a bit more because it is written to the RAM
instead of the disk. Data loss after a power outage/reboot is not an issue,
because the html and graphs are generated fresh every time.</p>

<p>Edit <code>/etc/fstab</code> and add the following (be careful not to change something
else):</p>

<pre><code>tmpfs  /var/www/munin   tmpfs   rw,mode=755,uid=munin,gid=munin,size=150M   0 0
</code></pre>

<p>Because my munin-server has 256MB RAM I give it a 150M size. If you have more
RAM available you can easisly up this to 1000 M. If you save your munin graphs
somewhere else (check the <code>htmldir</code> variable in <code>/etc/munin/munin.conf</code>) the
make sure you change that as well.</p>

<p>Now make sure it is mounted by executing the following:</p>

<pre><code>mount -a
</code></pre>

<h4>cgi strategy</h4>

<p>Another way to up the performance of Munin is by using a cgi-based graph
strategy. However, for me this made the munin webinterface terribly slow and
unworkable so I will not cover that here.</p>

<h4>Links</h4>

<ul>
<li><a href="http://munin.readthedocs.org/en/latest/master/rrdcached.html">http://munin.readthedocs.org/en/latest/master/rrdcached.html</a></li>
<li><a href="http://blog.pwkf.org/post/2011/06/Enhance-RRD-I/O-performance-in-Munin-1.4-and-Scale">http://blog.pwkf.org/post/2011/06/Enhance-RRD-I/O-performance-in-Munin-1.4-and-Scale</a></li>
<li><a href="http://beeznest.wordpress.com/2012/06/25/munin-2-0-on-debian-2/">http://beeznest.wordpress.com/2012/06/25/munin-2-0-on-debian-2/</a></li>
<li><a href="http://www.jethrocarr.com/2012/05/26/munin-performance/">http://www.jethrocarr.com/2012/05/26/munin-performance/</a></li>
</ul>
Tags: <a href="../tags/debian.html" class="link">debian</a>, <a href="../tags/ionice.html" class="link">ionice</a>, <a href="../tags/monitoring.html" class="link">monitoring</a>, <a href="../tags/munin.html" class="link">munin</a>, <a href="../tags/nice.html" class="link">nice</a>, <a href="../tags/performance.html" class="link">performance</a>, <a href="../tags/rrdcached.html" class="link">rrdcached</a>, <a href="../tags/tmpfs.html" class="link">tmpfs</a>, <a href="../tags/tutorials.html" class="link">tutorials</a>, <a href="../tags/ubuntu.html" class="link">ubuntu</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    