
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Icinga2 / Nagios / Net::SNMP change the default timeout of 60 seconds - Raymii.org</title>
        <link href="/s/inc/css/custom-first.css" rel="stylesheet" />
        <!-- <link href="/s/inc/css/light.css" rel="stylesheet"  />
        # <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link href="inc/img/icons/iphone.png" rel="apple-touch-icon" />
        <link href="inc/img/icons/ipad.png" rel="apple-touch-icon" sizes="76x76" />
        <link href="inc/img/icons/iphone-retina.png" rel="apple-touch-icon" sizes="120x120" />
        <link href="inc/img/icons/ipad-retina.png" rel="apple-touch-icon" sizes="152x152" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        <a class="skip-main" href="#main">Skip to main content</a>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/index.html" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/tags/all.html" class="special-menu">All Pages</a></li><li class='hideifsmall'><a href="/s/tags/articles.html" class="link">Articles</a></li>
<li class='hideifsmall'><a href="/s/tags/blog.html" class="link">Blog</a></li>
<li class='hideifsmall'><a href="/s/tags/tutorials.html" class="link">Tutorials</a></li>
<li class='hideifsmall'><a href="/s/tags/ansible.html" class="link">Ansible</a></li><li class='hideifsmall'><a href="/s/tags/openstack.html" class="link">Openstack</a></li><li class='hideifsmall'><a href="/s/tags/openvms.html" class="link">OpenVMS</a></li><li class='hideifsmall'><a href="/s/tags/pdp-8.html" class="link">PDP-8</a></li><li class='hideifsmall'><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li class='hideifsmall'><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li></ul>            
               <!-- advertisement start -->
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212"><img src="https://raymii.org/s/inc/img/banner_trans.png"></a><br>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $10 free credit.</a><br />
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Raymii-2 -->
                <ins class="adsbygoogle"
                     style="display:inline-block;width:200px;height:200px"
                     data-ad-client="ca-pub-7993642564731324"
                     data-ad-slot="9322003332"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">
                <div id="main"></div>

           <h2 class='headheader' id='main'>Icinga2 / Nagios / Net::SNMP change the default timeout of 60 seconds</h2><ul class="breadcrumb"><li><a href="../index.html" class="link">Home</a></li><li><a href="../tags/tutorials.html" class="link">Tutorials</a></li><li><a href="Icinga2_Nagios_Net_SNMP_raise_default_timeout.html" class="link">Icinga2 / Nagios / Net::SNMP change the default timeout of 60 seconds</a></li></ul><p><small>16-05-2018</small> | <small>Remy van Elst</small> | <a href="Icinga2_Nagios_Net_SNMP_raise_default_timeout.txt" class="link">Text only version of this article</a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>Recently a rather large amount of new infrastructure was added to one of my monitoring instances. Using SNMP exclusively, but not the fastest network or infrastructure. The SNMP checks in the Icinga2 instance started giving timeouts, which look like false positives and give unclean logs. Raising the SNMP timeout for the checks above 60 seconds was not that easy since the 60 second timeout is hardcoded in the underlying library (NET::SNMP). This article shows you how to raise that timeout on an Ubuntu 16.04 system.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a>  </p>

<p>In the webinterface of Icinga2 the logs are unclean, making it harder to find actual errors:</p>

<p><img src="https://raymii.org/s/inc/img/icinga_timeout.png"></p>

<h3>Timeout in the Manubulon SNMP checks</h3>

<p>The plugins used for the SNMP monitoring are <a href="http://nagios.manubulon.com/">from Manubulon</a>, Icinga2 has them integrated, and using Ansible I generate the configuration for the servers. An example apply rule could look like this:</p>

<pre><code>apply Service &quot;snmp-win-service-Microsoft-Exchange-IMAP4&quot; {
  import &quot;generic-service&quot;
  check_command                 = &quot;snmp-service&quot;
  vars.snmp_perf                = &quot;true&quot;
  vars.snmp_v2                  = &quot;true&quot;
  vars.snmp_service_name        = &quot;Microsoft Exchange IMAP4&quot;
  vars.snmp_community           = &quot;example&quot;
  vars.snmp_timeout             = &quot;60&quot;
  vars.snmp_service_count       = &quot;1&quot;
  assign where match(&quot;example&quot;, host.name)
}
</code></pre>

<p>All the variables can be found in:</p>

<pre><code>/usr/share/icinga2/include/command-plugins-manubulon.conf
</code></pre>

<p>Raising this timeout higher than 60 gives an error for the check. Let&#39;s dive on the commandline and check what goes wrong:</p>

<pre><code>/usr/bin/perl -w /usr/lib/nagios/plugins/check_snmp_process.pl -H example -C example -t 88 -n &quot;Microsoft Exchange IMAP4&quot;
Timeout must be &gt;1 and &lt;60 !
</code></pre>

<p>Looking through the perl code, <code>$o_timeout</code> is checked to not be greater then 60 seconds. Let&#39;s change that:</p>

<pre><code>sed -i &#39;s/$o_timeout &gt; 60/$o_timeout &gt; 900/g&#39; /usr/lib/nagios/plugins/check_snmp_process.pl
</code></pre>

<p>Should be fixed right?</p>

<pre><code>/usr/bin/perl -w /usr/lib/nagios/plugins/check_snmp_process.pl -H example -C example -t 88 -n &quot;Microsoft Exchange IMAP4&quot;
ERROR: The timeout value 88 is out of range (1..60).
</code></pre>

<p>And that error message is nowhere to be found in the plugin.</p>

<h3>Net::SNMP perl code</h3>

<p><a href="http://web.archive.org/web/20180516054845/https://webcache.googleusercontent.com/search?q=cache:QbXBdQJ8bzoJ:https://support.nagios.com/forum/viewtopic.php%3Ft%3D40836%26p%3D200360+&amp;cd=2&amp;hl=nl&amp;ct=clnk&amp;gl=nl&amp;client=ubuntu">This post</a> (the site is behind a login now, so I had to archive the google cache, neat), had more information where this error came from, hardcoded in the SNMP library used by the Icinga2 checks. </p>

<p>I was unable to find out why this limit was choosen and not made configurable. <a href="http://web.archive.org/web/20180516064030/http://search.cpan.org/%7Edtown/Net-SNMP-v6.0.1/lib/Net/SNMP.pm">This</a> was the closest, but that does not give a reason. Now, 60 seconds is a long timeout and I&#39;d also rather not raise it, but this case is an exception.</p>

<p>Change it in library:</p>

<pre><code>sed -i &#39;s/sub TIMEOUT_MAXIMUM      { 60/sub TIMEOUT_MAXIMUM      { 900/g&#39; /usr/share/perl5/Net/SNMP/Transport.pm 
</code></pre>

<p>Which does allows for a larger timeout:</p>

<pre><code>/usr/bin/perl -w /usr/lib/nagios/plugins/check_snmp_process.pl -H example -C example -t 88 -n &quot;Microsoft Exchange IMAP4&quot;
1 services active (matching &quot;Microsoft Exchange IMAP4&quot;) : OK
</code></pre>

<p>Not the most pretty fix, but a suitable workaround. Do note that my checks are not done every minute, but every 15 minutes or every hour. Otherwise it could clog up and cause a waterfall of load everywhere in this, lets call it vintage, infrastructure.</p>

<p>Also note that when you do system upgrades, these changes will be overwritten. You might want to <code>chattr +i</code> some files.</p>
</div><hr>Tags: <a href="../tags/health.html" class="link">health &nbsp;</a><a href="../tags/icinga.html" class="link">icinga &nbsp;</a><a href="../tags/icinga2.html" class="link">icinga2 &nbsp;</a><a href="../tags/monitoring.html" class="link">monitoring &nbsp;</a><a href="../tags/nagios.html" class="link">nagios &nbsp;</a><a href="../tags/perl.html" class="link">perl &nbsp;</a><a href="../tags/timeout.html" class="link">timeout &nbsp;</a><a href="../tags/tutorials.html" class="link">tutorials &nbsp;</a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    