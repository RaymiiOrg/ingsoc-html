
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Building opkg .ipk packages by hand (for OpenEmbedded/Yocto/OpenWRT) - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Building opkg .ipk packages by hand (for OpenEmbedded/Yocto/OpenWRT)</h2><p><small>Published: 05-04-2019 | Author: Remy van Elst | <a href="Building_IPK_packages_by_hand.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p><img src="https://raymii.org/s/inc/img/var-som-mx6.png" alt="VAR-SOM-MX6"></p>

<blockquote>
<p>Variscite VAR-SOM-MX6 - a high-performance ARM System on Module that can run
Yocto</p>
</blockquote>

<p><code>.ipk</code> packages are used by a variety of embedded linux systems, like routers
running OpenWRT and appliances running on OpenEmbedded (Yocto). The <code>opkg</code>
command installs these packages and OpenEmbedded comes with a set of tools to
build <code>.ipk</code> packages.</p>

<p>Recently I had to create ipk packages in a scripted fashion for a few hundred
systems, all unique per system. The <code>.ipk</code> packages includes a few software
changes for debugging, a systemd service and one precompiled binary. The yocto
build tools were not available on the machine where these packages would be made
so I had to figure out how to make them by hand, which means, automatically. The
packages are actually just compressed files containing a few control files and
the data to be extracted on the filesystem.</p>

<p>This article will walk you through the steps of creating these packages by hand.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>All steps are executed as the root user. The system the packages are built on is
running Ubuntu 18.04. If you haven&#39;t got <code>ar</code> installed, make sure to</p>

<pre><code>apt-get install binutils
</code></pre>

<h3>IPK packages</h3>

<p>An IPK package is very simple. It&#39;s like a <code>.deb</code> debian package, as in that is
has both data and control files packaged up into an archive. The data will be
extracted onto the filesystem where the package is installed, the control files
are used for dependency management and to execute pre and post install actions.</p>

<p>In my case, the <code>postinst</code> script is used to start the service (the binary we&#39;re
packaging up). The <code>prerm</code> script is used to stop the service and disable it
before uninstalling the package. The <code>postinst</code> script is used to check if the
serial number matches the machine.</p>

<p>An <code>ipk</code> is an archive (either <code>tar</code> or <code>ar</code> or <code>gzip</code>) containing two archives
(<code>control.tar.gz</code> &amp; <code>data.tar.gz</code>) and a <code>debian-binary</code> file with the contents
<code>2.0</code>:</p>

<pre><code>tar -tzf example_package_1.3.3.7.varam335x.ipk
</code></pre>

<p>Output:</p>

<pre><code>./debian-binary
./data.tar.gz
./control.tar.gz
</code></pre>

<h3>Folder structure &amp; Data</h3>

<p>The following folder structure is used for the package build. There is a <code>main</code>
folder named <code>packages</code>, which has a subfolder for each machine based on the
machines serial number. Under the machine folder there is a folder named after
the package we&#39;re building (<code>examplepackage</code>), which has a <code>control</code> and <code>data</code>
folder. The <code>data</code> folder contains the files that will be extracted on the
filesystem and the <code>control</code> folder contains the pre and post scripts and some
package information.</p>

<pre><code>packages/serialnumber/
|-- ipkbuild
|   `-- example_package
|       |-- control
|       |   |-- control
|       |   |-- postinst
|       |   |-- preinst
|       |   `-- prerm
|       |-- data
|       |   |-- usr
|       |   |   `-- bin
|       |   |       `-- my_binary
|       |   `-- lib
|       |       `-- systemd
|       |           `-- system
|       |               `-- example_package.service
|       `-- debian-binary
`-- example_package_1.3.3.7_varam335x.ipk
</code></pre>

<p>To create the folder structure listed above, use this command:</p>

<pre><code>mkdir -p packages/serial/ipkbuild/example_package/{control,data}
</code></pre>

<p>Then copy all the files you need installed (including folder structure and
permissions) into the <code>data</code> folder. As you can see in the above listing, my
<code>data</code> folder contains one binary and a systemd script (to start that binary).</p>

<p>Make sure that your binaries have executable permissions and are for the correct
architecture. A binary for a <code>mipsel</code> machine will not run on an <code>armv7l</code>, even
if it&#39;s in that <code>ipk</code> package.</p>

<h3>Control &amp; Postint, preinst, postrm and prerm scripts</h3>

<p>The <code>control</code> folder must contain at least a file named <code>control</code>. This has
information on the package, like name, version, dependencies, etc. My control
file is simple and contains just the bare minimum:</p>

<pre><code>cat packages/serial/ipkbuild/example_package/control/control
</code></pre>

<p>Output:</p>

<pre><code>Package: example_package
Version: 1.3.3.7
Architecture: varam335x
Maintainer: user@domain.tld
Description: This is an example IPK package
Priority: optional
Depends: systemd other_package
</code></pre>

<p>The <code>debian-binary</code> file must contain just <code>2.0</code>:</p>

<pre><code>echo 2.0 &gt; packages/serial/ipkbuild/example_package/debian-binary
</code></pre>

<p>Some systems use this to check the MIME type of the package.</p>

<p>The <code>postinst</code>, <code>postrm</code>, <code>preinst</code> and <code>prerm</code> are executed in their respective
phases during installation or removal. Exit code 0 means all is well and the
action will continue. Other exit codes (&gt;1) mean that something went wrong and
the action will stop. By default these scripts are executed with <code>sh</code>, but that
depends entirely on your embedded system. In my case I know <code>bash</code> is available,
but make sure to hold back onto <code>bash</code> specifics.</p>

<p>My <code>preinst</code> file contains a check on the machine serial number. Since I build
the packages for a specific machine, I know this beforehand. I want to make sure
that packages can only run on the machine they&#39;re built for:</p>

<pre><code>cat packages/serial/ipkbuild/example_package/control/preinst
</code></pre>

<p>Ouput:</p>

<pre><code>#!/bin/bash
confserial=123456789
machineserial=`cat /example/serial.txt`
if [ $confserial -ne $machineserial ]; then
    echo &quot;Configured serial does not match machine serial&quot;
    exit 1
fi
</code></pre>

<p>Make sure this file is executable. It will not run otherwise, <code>opkg</code> will fail
with a <code>Permission Denied</code> error.</p>

<pre><code>chmod +x packages/serial/ipkbuild/example_package/control/preinst
</code></pre>

<p>The <code>postinst</code> file is executed after successfull installation. I use it to
start the service we just installed:</p>

<pre><code>cat packages/serial/ipkbuild/example_package/control/postinst
</code></pre>

<p>Output:</p>

<pre><code>#!/bin/bash
systemctl --system daemon-reload
systemctl enable example_service
systemctl start example_service
</code></pre>

<p>This file must be executable as well:</p>

<pre><code>chmod +x packages/serial/ipkbuild/example_package/control/postinst
</code></pre>

<p>The <code>prerm</code> file is used to stop the service and remove it from systemd:</p>

<pre><code>cat packages/serial/ipkbuild/example_package/control/prerm
</code></pre>

<p>Output:</p>

<pre><code>#!/bin/bash
systemctl stop example_service
systemctl disable example_service
systemctl --system daemon-reload
</code></pre>

<p>This one has to be executable as like all the others:</p>

<pre><code>chmod +x packages/serial/ipkbuild/example_package/control/prerm
</code></pre>

<p>If you have all your data files and your control files in the correct folder you
can continue to package it all up.</p>

<h3>Packing it all up</h3>

<p>The archive files must not contain any paths, therefore we create them in the
folder structure we&#39;ve created. I use <code>pushd</code> and <code>popd</code> because it&#39;s all
scripted, but <code>cd</code> might work just as well. The paths and archive structure were
a bit of a try, fail and retry experiment for me.</p>

<pre><code>pushd packages/serial/ipkbuild/example_package/control/
tar --numeric-owner --group=0 --owner=0 -czf ../control.tar.gz ./*
popd

pushd packages/serial/ipkbuild/example_package/data
tar --numeric-owner --group=0 --owner=0 -czf ../data.tar.gz ./*
popd

pushd packages/serial/ipkbuild/example_package
tar --numeric-owner --group=0 --owner=0 -cf ../../example_package_1.3.3.7.varam335x.ipk ./debian-binary ./data.tar.gz ./control.tar.gz 
popd
</code></pre>

<p>You will now have an <code>ipk</code> package built:</p>

<pre><code>packages/serial/example_package_1.3.3.7_varam335x.ipk
</code></pre>

<h4>gzip vs debian binary package (mime type)</h4>

<p>If you have a system that does specific MIME type checks, you might want to use
<code>ar</code> to create the package. If you use <code>tar</code> to create a package, the mimetype
will be that of a tar or gzip file. Using <code>ar</code>, it will be a Debian Binary
package format.</p>

<p><code>tar</code> packaged package:</p>

<pre><code>example_package_1.3.3.7.varam335x.ipk: gzip compressed data, last modified: Thu Apr  4 07:51:34 2019, from Unix (application/gzip)
</code></pre>

<p><code>ar</code> packaged package:</p>

<pre><code>example_package_1.3.3.7.varam335x.ipk: Debian binary package (format 2.0) (application/vnd.debian.binary-package)
</code></pre>

<p>To create the package with <code>ar</code>, use the following command:</p>

<pre><code>pushd packages/serial/ipkbuild/example_package
ar rv ../../example_package_1.3.3.7.varam335x.ipk debian-binary ./data.tar.gz ./control.tar.gz 
popd
</code></pre>

<p>Output:</p>

<pre><code>ar: creating example_package_1.3.3.7.varam335x.ipk
a - ./debian-binary
a - ./data.tar.gz
a - ./control.tar.gz
</code></pre>
Tags: <a href="../tags/arm.html" class="link">arm</a>, <a href="../tags/deb.html" class="link">deb</a>, <a href="../tags/embedded.html" class="link">embedded</a>, <a href="../tags/ipk.html" class="link">ipk</a>, <a href="../tags/openembedded.html" class="link">openembedded</a>, <a href="../tags/openwrt.html" class="link">openwrt</a>, <a href="../tags/opkg.html" class="link">opkg</a>, <a href="../tags/packages.html" class="link">packages</a>, <a href="../tags/tutorials.html" class="link">tutorials</a>, <a href="../tags/variscite.html" class="link">variscite</a>, <a href="../tags/yocto.html" class="link">yocto</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    