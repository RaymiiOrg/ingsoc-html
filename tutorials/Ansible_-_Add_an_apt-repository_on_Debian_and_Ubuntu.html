
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Ansible - Add an apt-repository on Debian and Ubuntu - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Ansible - Add an apt-repository on Debian and Ubuntu</h2><p><small>Published: 15-05-2016 | Last update: 14-12-2018 | Author: Remy van Elst | <a href="Ansible_-_Add_an_apt-repository_on_Debian_and_Ubuntu.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>This is a guide that shows you how to add an apt repository to Debian and Ubuntu
using Ansible. It includes both the old way, when the apt modules only worked on
Ubuntu, and the new way, now that the apt-modules also support Debian, plus some
other tricks.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<ul>
<li>14-12-2018: updated ansible syntax to 2.5</li>
<li>15-05-2016: initial article</li>
</ul>

<h3>Introduction</h3>

<p>Ansible allows you to add apt repositories and apt repository signing keys
easily using the two modules <code>apt_repository</code> and <code>apt_key</code>. You can use this
when you need to install packages from an external location, for example,
<code>nginx</code> or <code>goaccess</code>. Both of these packages are in the repositories, but not
the latest version.</p>

<p>Using Ansible you can add the repository and the signing key, and then install
the package from the new repo. This guide will show you a few ways to do that in
playbooks.</p>

<h3>The new way</h3>

<p>The easy way is to first add the repository key, then add the repository and
finally install the package. Here&#39;s an example for nginx:</p>

<pre><code># always try to use HTTPS. I&#39;m not sure why the nginx folks don&#39;t provide it.
- name: add nginx apt-key
  apt_key: 
    url: http://nginx.org/keys/nginx_signing.key 
    state: present 

- name: add nginx apt repository
  apt_repository: 
    repo: &#39;deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx&#39; 
    state: present 
    filename: nginx 
    update_cache: yes

- name: install nginx
  apt: 
    name: nginx
    state: present
    update_cache: yes
</code></pre>

<p>This is a three line playbook which will download and install the repository
key, add the repository to a seperate file in <code>/etc/apt/sources.list.d/</code> and
install the package while also doing an <code>apt-get update</code> to refresh the apt
cache with the new repository.</p>

<p>This is the recommended way to add a repo and install packages from there. Read
on to find out the workarounds in ye olden days.</p>

<h3>The old way</h3>

<p>In the past the <code>apt_key</code> module and behaved wonky on Debian installations, but
not on Ubuntu. The <code>apt_key</code> module also did not support downloading keys from
external locations and was tailored more to PPA&#39;s, which are nonexistent on
Debian. Here&#39;s the same NGINX example, using the older way, which still works by
the way.</p>

<pre><code>- name: &#39;add nginx repository&#39;
  template: 
    src: nginx.list.j2
    dest: /etc/apt/sources.list.d/nginx.list

- name: make sure folder /var/keys exists
  file: 
    path: /var/keys
    state: directory 
    owner: root

- name: &#39;get nginx package signing key&#39;
  get_url: 
    url: http://nginx.org/keys/nginx_signing.key
    dest: /var/keys/nginx_signing.key
  register: result

- name: add nginx apt-key
  command: apt-key add &#39;/var/keys/nginx_signing.key&#39;
  when: result.changed

- name: install nginx
  apt:
    name: nginx 
    state: latest
    update_cache: yes
</code></pre>

<p>The nginx repository template contains the following:</p>

<pre><code># {{ ansible_managed }}
deb http://nginx.org/packages/mainline/{{ ansible_lsb.id|lower }}
/ {{ ansible_lsb.codename|lower }} nginx

deb-src http://nginx.org/packages/mainline/{{ ansible_lsb.id|lower }}
/ {{ ansible_lsb.codename|lower }} nginx
</code></pre>

<p>This is quite a nice trick, because it works on both Debian and Ubuntu, all
versions. On the latest Ubuntu 16.04 the resulting repository line is this:</p>

<pre><code>deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx
</code></pre>

<p>But on an onder Debian installation, the result is this:</p>

<pre><code>deb http://nginx.org/packages/mainline/debian/ wheezy nginx
</code></pre>

<p>You do need to make sure the upstream repository also follows this structure. In
the nginx case, it does.</p>

<p>First a directory is created for the keyfile. The apt-key is downloaded manually
to there, the result is registered. If the key already exists or is the same, we
don&#39;t do anything. If the key isn&#39;t there or has changed, we execute the <code>apt-
key add</code> command manually to add the repository signing key. If that&#39;s all done,
we update the apt-cache and install nginx.</p>

<p>That&#39;s quite a bit more steps and ways to break stuff, plus, less idempotent due
to the manual command. My playbook was so old, it still used the <code>action: apt</code>
instead of just <code>apt:</code>.</p>

<p>This is not the recommended way, but it still works just fine. If you add
repositories this way, no problem, but you might want to consider rewriting the
playbooks to the newer way.</p>

<h3>More documentation</h3>

<p>The official documentation for the two modules can be found on the Ansible docs
site: <a href="https://docs.ansible.com/ansible/apt_repository_module.html">apt_repository</a> and <a href="https://docs.ansible.com/ansible/apt_key_module.html">apt_key</a>.</p>

<p>You can also check out my other <a href="https://raymii.org/s/tags/ansible.html">Ansible articles</a>.</p>
Tags: <a href="../tags/ansible.html" class="link">ansible</a>, <a href="../tags/apt.html" class="link">apt</a>, <a href="../tags/deb.html" class="link">deb</a>, <a href="../tags/nginx.html" class="link">nginx</a>, <a href="../tags/packages.html" class="link">packages</a>, <a href="../tags/python.html" class="link">python</a>, <a href="../tags/repo.html" class="link">repo</a>, <a href="../tags/tutorials.html" class="link">tutorials</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p>
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    