
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>haproxy: intercept all cookies and set secure attribute - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>haproxy: intercept all cookies and set secure attribute</h2><p><small>Published: 01-02-2014 | Author: Remy van Elst | <a href="haproxy_intercept_all_cookies_and_set_secure_attribute.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>This snippet shows you how to use haproxy to set the secure attribute on
cookies. You might have a backend application which is not able to set the
secure attribute on cookies or for which haproxy does the ssl offloading. This
simple frontend rspirep sets the secure attribute for all cookies.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>Add the following to a <code>frontend</code> block:</p>

<pre><code>rspirep ^(set-cookie:.*)  \1;\ Secure
</code></pre>

<p>Like so:</p>

<pre><code>frontend example-frontend
  reqadd X-Forwarded-Proto:\ https
  rspadd Strict-Transport-Security:\ max-age=31536000;\ includeSubDomains
  option forwardfor except 127.0.0.1
  maxconn 2000
  rspirep ^(set-cookie:.*)  \1;\ Secure
  bind 10.20.30.40:443 ssl crt /etc/haproxy/pem/example.pem ciphers ECDHE+RSA+AES256+GCM+SHA384:ECDHE+RSA+AES128+GCM+SHA256:DHE+RSA+AES256+GCM+SHA384:DHE+RSA+AES128+GCM+SHA256:ECDHE+RSA+AES256+SHA384:ECDHE+RSA+AES128+SHA256:ECDHE+RSA+AES256+SHA:ECDHE+RSA+AES128+SHA:DHE+RSA+AES256+SHA256:DHE+RSA+AES128+SHA256:DHE+RSA+AES256+SHA:DHE+RSA+AES128+SHA:ECDHE+RSA+DES+CBC3+SHA:EDH+RSA+DES+CBC3+SHA:AES256+GCM+SHA384:AES128+GCM+SHA256:AES256+SHA256:AES128+SHA256:AES256+SHA:AES128+SHA:DES+CBC3+SHA:HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4
  default_backend example-backend
</code></pre>

<p>This will set (and re-set) all your cookies with the secure attribute on.</p>

<p><a href="http://cbonte.github.io/haproxy-dconv/configuration-1.5.html#rspirep">Documentation on rspirep</a></p>
Tags: <a href="../tags/cookies.html" class="link">cookies</a>, <a href="../tags/haproxy.html" class="link">haproxy</a>, <a href="../tags/loadbalancer.html" class="link">loadbalancer</a>, <a href="../tags/secure.html" class="link">secure</a>, <a href="../tags/ssl.html" class="link">ssl</a>, <a href="../tags/tutorials.html" class="link">tutorials</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    