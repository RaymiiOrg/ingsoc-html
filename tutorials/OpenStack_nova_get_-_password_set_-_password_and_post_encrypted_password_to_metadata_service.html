
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>OpenStack nova get-password, set-password and post encrypted password to metadata service - Raymii.org</title>
        <link href="/s/inc/css/custom-first.css" rel="stylesheet" />
        <!-- <link href="/s/inc/css/light.css" rel="stylesheet"  />
        # <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        <a class="skip-main" href="#main">Skip to main content</a>
        <a id="top-of-page"></a>
        <div class="container-fluid ">
            <div class="row">
                <div class="col-md-12">
                    <div class="col-md-3 col-sm-3 max-200">
                        <div class="well well-none"> 
                            <h3 class="headheader"><a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a></h3>
                            <h6 class="headheader">Quis custodiet ipsos custodes?</h6>
                            <h6><a href="https://raymii.org/s/feed.xml">RSS Feed</a> | <a href="gopher://raymii.org:70">Gopher</a></h6>
                        </div>
          

    
    <form role="search" action="https://encrypted.google.com/search">
        <div class="form-group">
          <input type="hidden" name="as_sitesearch" value="raymii.org">
          <input type="hidden" name="as_qdr" value="all">
          <input type="text" name="as_q" class="form-control" placeholder="Search">
        </div>
      </form>
      <div class="menu"><ul class="nav nav-pills nav-stacked"><li><a href="/s/index.html" class="special-menu">Home</a></li><li class='bottom-spacing'><a href="/s/tags/all.html" class="special-menu">All Pages</a></li><li class='hideifsmall'><a href="/s/tags/articles.html" class="link">Articles</a></li>
<li class='hideifsmall'><a href="/s/tags/blog.html" class="link">Blog</a></li>
<li class='hideifsmall'><a href="/s/tags/tutorials.html" class="link">Tutorials</a></li>
<li class='hideifsmall'><a href="/s/tags/ansible.html" class="link">Ansible</a></li><li class='hideifsmall'><a href="/s/tags/openstack.html" class="link">Openstack</a></li><li class='hideifsmall'><a href="/s/tags/bash.html" class="link">Bash</a></li><li class='hideifsmall'><a href="/s/tags/ssl.html" class="link">SSL</a></li><li class='hideifsmall'><a href="/s/tags/monitoring.html" class="link">Monitoring</a></li><li class='hideifsmall'><a href="/s/tags/ubuntu.html" class="link">Ubuntu</a></li><li class='hideifsmall'><a href="/s/tags/openvms.html" class="link">OpenVMS</a></li></ul>            
               <!-- advertisement start -->
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212"><img src="https://raymii.org/s/inc/img/banner_trans.png"></a><br>
                <a href="http://clients.inceptionhosting.com/aff.php?aff=083">Inception Hosting Affiliate Link</a><br />
                <a href="https://www.digitalocean.com/?refcode=7435ae6b8212">Digital Ocean Affiliate Link, $100 free credit.</a><br />
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Raymii-2 -->
                <ins class="adsbygoogle"
                     style="display:inline-block;width:200px;height:200px"
                     data-ad-client="ca-pub-7993642564731324"
                     data-ad-slot="9322003332"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <!-- advertisement end -->
                </div>
           </div>  
           <div class="col-md-8 col-sm-8"> 
                <div class="inner">
                <div id="main"></div>

           <h2 class='headheader' id='main'>OpenStack nova get-password, set-password and post encrypted password to metadata service</h2><ul class="breadcrumb"><li><a href="../index.html" class="link">Home</a></li><li><a href="../tags/tutorials.html" class="link">Tutorials</a></li><li><a href="OpenStack_nova_get_-_password_set_-_password_and_post_encrypted_password_to_metadata_service.html" class="link">OpenStack nova get-password, set-password and post encrypted password to metadata service</a></li></ul><p><small>Published: 25-03-2018</small> | <small>Author: Remy van Elst | </small><a href="OpenStack_nova_get_-_password_set_-_password_and_post_encrypted_password_to_metadata_service.txt" class="link"><small>Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>When you create images for an OpenStack Cloud you want to use &#39;cloud&#39; features. Fancy term for automatic resizing of your instance disk, adding an SSH key, (re)setting passwords and executing scripts on first boot to configure your instance further. OpenStack provides the metadata service for instances, which supplies information for the instance, like its public IP, SSH public key that was provided and vendor or user provided data like scripts or information. The OpenStack metadata service allows an instance to post data to an endpoint wich can be retreived with the <code>nova get-password</code> command. It is meant to be an encrypted password (with the public SSH key) but it can be any plain text as well and it doesn&#39;t have to be the root password. In this guide I&#39;ll go over the scripts I use inside linux images to post a password to the metadata service and the <code>nova</code> commands such as <code>set-password</code> and <code>get-password</code>. That includes decrypting a password with an SSH key that is password-protected (Horizon and nova don&#39;t support that) and the <code>nova set-password</code> command, which sets the root password inside an instance when it has the <code>qemu-guest-agent</code> installed and running.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean VPS. With this link you&#39;ll get a $5 VPS for 2 months free (as in, you get $10 credit). (referral link)</a>  </p>

<p>The first section of the guide goes over the <code>nova get-password</code>, <code>nova set-password</code> and the manual decryption of the password. </p>

<p>The second part of the article shows the script I use to set the password inside cloud instances.</p>

<h3>nova get-password</h3>

<p>The <code>nova</code> command line client supports the <code>get-password</code> command. This command only works when a password has been posted to the metadata service (by the instance). </p>

<pre><code>$ nova help get-password
usage: nova get-password &lt;server&gt; [&lt;private-key&gt;]

Get the admin password for a server.

Positional arguments:
  &lt;server&gt;       Name or ID of server.
  &lt;private-key&gt;  Private key (used locally to decrypt password) (Optional).
                 When specified, the command displays the clear (decrypted) VM
                 password. When not specified, the ciphered VM password is
                 displayed.
</code></pre>

<p>Using it on a server that has a password set in the metadata service:</p>

<pre><code>$ nova get-password $instance_uuid
</code></pre>

<p>Output: </p>

<pre><code>bPLUcppp+MXbiO4kFMsIZ1zj4VbS/1kfafWTvqPBKr3B5Rk9z0eLotwVNDGCJkXYGmDmKca0q4hWdAt03N7QZ58DbgF24cvumgQIHddT5D14M98n85oiI3yPd0DCrEhvZQb5jwmYIWBBhqDCuyl+savwFNmVEn2cxdPleCZqvIN7BHs2HRVY7esHDcPiY1+Xdq5SMa92lcsJyn8LJRUUUuq0o0k75+4TTtEWEtClXiMyURIRDgDOpVDXBl2kgeU22a/e1rRKKOKg6CasVu7g0V9fmmLC/zXRmgTqfMwZlm0wDdq0X4jRUYzRNpxLarj6AXGYoSQT6moKx9ttcNL6JQ==
</code></pre>

<p>To decrypt it, supply the SSH private key with the command. It&#39;s a client side decryption:</p>

<pre><code>$ nova get-password $instance_uuid ~/.ssh/cloud_nopass.priv
</code></pre>

<p>Output: </p>

<pre><code>example_password
</code></pre>

<p>If your private key has a password, decrypting only works if you have <code>ssh-agent</code> running:</p>

<pre><code>$ nova get-password $instance_uuid ~/.ssh/cloud_pass.priv
</code></pre>

<p>Output:</p>

<pre><code>Enter pass phrase for ~/.ssh/cloud_pass.priv:
example_password
</code></pre>

<p>This way you can even use this feature if your SSH private key is stored on a hardware token like <a href="https://raymii.org/s/articles/Get_Started_With_The_Nitrokey_HSM.html">a NitroKey HSM</a> (smartcard), OpenPGP token like the <a href="https://raymii.org/s/articles/Nitrokey_Start_Getting_started_guide.html">NitroKey Start</a> or a YubiKey.</p>

<p>Using the Horizon dashboard you can also decrypt the password. This is also a client side operation and doesn&#39;t work if your private key is password protected.</p>

<p><img src="https://raymii.org/s/inc/img/retreive_password.png" alt="password"></p>

<h4>Manual decryption</h4>

<p>Using the <code>openssl</code> command line tools we can decrypt the encrypted password. It&#39;s base64 encoded so there is an extra step to decode the base64.</p>

<pre><code>$ echo &quot; bPLUcppp+MXbiO4kFMsIZ1zj4VbS/1kfafWTvqPBKr3B5Rk9z0eLotwVNDGCJkXYGmDmKca0q4hWdAt03N7QZ58DbgF24cvumgQIHddT5D14M98n85oiI3yPd0DCrEhvZQb5jwmYIWBBhqDCuyl+savwFNmVEn2cxdPleCZqvIN7BHs2HRVY7esHDcPiY1+Xdq5SMa92lcsJyn8LJRUUUuq0o0k75+4TTtEWEtClXiMyURIRDgDOpVDXBl2kgeU22a/e1rRKKOKg6CasVu7g0V9fmmLC/zXRmgTqfMwZlm0wDdq0X4jRUYzRNpxLarj6AXGYoSQT6moKx9ttcNL6JQ==&quot; \
| openssl base64 -d \
| openssl rsautl -decrypt -inkey ~/.ssh/cloud_pass.priv -keyform PEM
</code></pre>

<p>Output: </p>

<pre><code>Enter pass phrase for ~/.ssh/cloud_pass.priv:
example_password
</code></pre>

<h3>nova set-password</h3>

<p>The <code>nova set-password</code> command allows you to change the password in a server. But, only if the <a href="https://wiki.qemu.org/Features/GuestAgent">qemu-guest-agent</a> is installed.  </p>

<pre><code>$ nova help set-password
usage: nova set-password &lt;server&gt;

Change the admin password for a server.

Positional arguments:
  &lt;server&gt;  Name or ID of server.
</code></pre>

<p>This can only be done by the owner of the instance or an OpenStack admin. It then allows you to login to the console for example.</p>

<p>By default there is no command line output if successfull.</p>

<p>The <code>set-password</code> command fails when a password is already set. Looking at the source code of the <a href="https://web.archive.org/web/20180105005659/https://github.com/openstack/nova/blob/master/nova/api/metadata/password.py#L65">metadata api</a> there is no command to remove a stored password. There is a <a href="https://web.archive.org/web/20180323094911/https://developer.openstack.org/api-ref/compute/#clear-admin-password">nova API</a> command but that is admin-only by default.</p>

<pre><code>$ nova set-password $instance_uuid
</code></pre>

<p>Output:</p>

<pre><code>New password:
Again:
ERROR (Conflict): Failed to set admin password on $instance_uuid because error setting admin password (HTTP 409) (Request-ID: req-f3f6feed-4171-45d1-ab16-28a6875688d8)
</code></pre>

<p>Following the <a href="https://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L2072">nova</a> <a href="https://github.com/openstack/nova/blob/master/nova/virt/libvirt/guest.py#L506">source code</a> we can see that in the case of Libvirt (KVM/QEMU) it calls <a href="https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainSetUserPassword">virDomainSetUserPassword</a>. </p>

<p>So it technically would be possible to (re)set the password again but currently it&#39;s not supported.</p>

<h3>Post encrypted passwords to the metadata service</h3>

<p>The metadata service allows posting a password. Technically this can be any sort of (unencrypted) data that will be made visible in Horizon or the <code>nova get-password</code> command. It is recommended to encrypt this password with the users provided public key.</p>

<p>Why? Because any code running inside the guest can access the password via the metadata service. Any web application can request the API URL and get the data: </p>

<pre><code>$ curl http://169.254.169.254/openstack/latest/password
</code></pre>

<p>Output:</p>

<pre><code> bPLUcppp+MXbiO4kFMsIZ1zj4VbS/1kfafWTvqPBKr3B5Rk9z0eLotwVNDGCJkXYGmDmKca0q4hWdAt03N7QZ58DbgF24cvumgQIHddT5D14M98n85oiI3yPd0DCrEhvZQb5jwmYIWBBhqDCuyl+savwFNmVEn2cxdPleCZqvIN7BHs2HRVY7esHDcPiY1+Xdq5SMa92lcsJyn8LJRUUUuq0o0k75+4TTtEWEtClXiMyURIRDgDOpVDXBl2kgeU22a/e1rRKKOKg6CasVu7g0V9fmmLC/zXRmgTqfMwZlm0wDdq0X4jRUYzRNpxLarj6AXGYoSQT6moKx9ttcNL6JQ==
</code></pre>

<p>The password is also stored on the config_drive but that requires root privileges to mount. If I post unencrypted data to that endpoint:</p>

<pre><code>DATA=&quot;this_is_an_example_raymii.org&quot;
curl -s -X POST http://169.254.169.254/openstack/latest/password -d $DATA
</code></pre>

<p>Horizon (and the API) happily show that:</p>

<p><img src="https://raymii.org/s/inc/img/get_plaintext_password.png"></p>

<p>So that&#39;s why you want to encrypt it. What we&#39;re doing in the script is the following:</p>

<ul>
<li>Check if password was already set, and if so, exit</li>
<li>Get public SSH key from metadata service.</li>
<li>Convert the public key to a format usable with OpenSSL</li>
<li>Generate random root password</li>
<li>Set root password (and any other user like <code>admin</code> in the case of DirectAdmin)</li>
<li>Encrypt the root password with the SSL keyfile</li>
<li>Post the encrypted password to the metadata service.</li>
</ul>

<p>There is almost no error handling, and a weary catch all in the curl (<code>|| true</code>), since this script is meant to run via <code>/etc/rc.local</code> (or via cloud-init) and a non exit 0 in rc.local can result in bootup failure. </p>

<pre><code>#!/bin/bash
# Copyright (C) 2018 Remy van Elst.
# Author: Remy van Elst for https://www.cloudvps.com
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#

# This script sets the root password
# to a random password generated on the instance
# and posts that if possible to the openstack
# metadata service for nova get-password.

logger &quot;[CLOUDVPS] Started set root password and post to metadata service&quot;

if [[ -f &quot;/var/lib/cloud/instance/rootpassword-random&quot; ]]; then
    # script already ran on this instance. 
    # /var/lib/cloud/instance/ is a symlink to /var/lib/cloud/instances/$instance_uuid
    # if user creates an image and deploys image, this must run again, that file will not exist
    exit 0
fi

# Centos 6 doens&#39;t support ssh-keygen&#39;s pcks8 option.
# it has OpenSSH &lt; 5.6
if [[ -f &quot;/etc/redhat-release&quot; ]]; then
    NAME=&quot;$(awk &#39;{ print $1 }&#39; /etc/redhat-release)&quot;
    VERSION=&quot;$(grep -Eo &quot;[0-9]\.[0-9]&quot; /etc/redhat-release | cut -d . -f 1)&quot;
fi

# Two tmp files for the SSH and SSL pubkey
SSH_KEYFILE=$(mktemp)
SSL_KEYFILE=$(mktemp)

# get the ssh public key from the metadata server.
curl -s -f http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key &gt; $SSH_KEYFILE
if [[ $? != 0 ]]; then
  logger &quot;[CLOUDVPS] Instance public SSH key not found on metadata service. Unable to set password&quot;
  exit 0
fi

# generate a random password
# our images have haveged installed so should have enough entropy at boot.
RANDOM_PASSWORD=&quot;$(openssl rand -base64 32 | tr -dc &#39;a-zA-Z0-9&#39; | fold -w 32 | head -c 30)&quot;
if [[ -z ${RANDOM_PASSWORD} ]]; then
    logger &quot;[CLOUDVPS] unable to generate random password.&quot;
    exit 0
fi

# set the root password to this random password
# add any other password changes like admin for DirectAdmin.
echo &quot;root:${RANDOM_PASSWORD}&quot; | chpasswd
if [[ -s &quot;$SSH_KEYFILE&quot; ]]; then
    # convert the ssh pubkey to an SSL keyfile so that we can use it to encrypt with OpenSSL
    if [[ ${VERSION} -eq 6 &amp;&amp; ${NAME} == &quot;CentOS&quot; ]]; then
        logger &quot;centos 6 doesnt support PKCS8 in ssh-keygen so we have a workaround.&quot;
        # our centos6 image has this file.
        # otherwise, https://gist.github.com/RaymiiOrg/7cd92ec7b9711fd4b9f6a1178c1bf04f
        python2 /etc/cloudvps/sshpub-to-rsa.py $SSH_KEYFILE &gt; $SSL_KEYFILE
    else
        ssh-keygen -e -f $SSH_KEYFILE -m PKCS8 &gt; $SSL_KEYFILE
    fi
    ENCRYPTED=$(echo &quot;$RANDOM_PASSWORD&quot; | openssl rsautl -encrypt -pubin -inkey $SSL_KEYFILE -keyform PEM | openssl base64 -e -A)
    # post encrypted blob to metadata service. Must return true otherwise instance might fail to boot.
    curl -s -X POST http://169.254.169.254/openstack/2013-04-04/password -d $ENCRYPTED 2&gt;&amp;1 &gt; /dev/null || true
fi
# housekeeping
rm -rf $SSH_KEYFILE $SSL_KEYFILE

touch /var/lib/cloud/instance/rootpassword-random

exit 0
</code></pre>

<h4>Running the script at first boot</h4>

<p>This script can be ran at first boot of an instance using the good old trusty <code>/etc/rc.local</code> file. If you use a newer distribution with <code>systemd</code>, you can create <a href="https://raymii.org/s/tutorials/rc.local_support_on_Arch_Linux_and_systemd.html">a unit file</a> to run this at boot. </p>

<p>You can also leverage <code>cloud-init</code> by creating a config file:</p>

<pre><code>vim /etc/cloud/cloud.cfg.d/00-cloudvps-rootpasswd.cfg
</code></pre>

<p>Add the contents:</p>

<pre><code>runcmd:
- /bin/bash /etc/cloudvps/rootpassword-to-metadata.sh
</code></pre>

<p>In my case the script is injected in the image on that location. You could also add a <code>curl</code> command if you use <code>cloud-config</code> (you do not control the cloud-init config but use <code>user-data</code>).</p>
</div><hr>Tags: <a href="../tags/cloud.html" class="link">cloud &nbsp;</a><a href="../tags/debian.html" class="link">debian &nbsp;</a><a href="../tags/encryption.html" class="link">encryption &nbsp;</a><a href="../tags/metadata.html" class="link">metadata &nbsp;</a><a href="../tags/nova.html" class="link">nova &nbsp;</a><a href="../tags/openstack.html" class="link">openstack &nbsp;</a><a href="../tags/password.html" class="link">password &nbsp;</a><a href="../tags/security.html" class="link">security &nbsp;</a><a href="../tags/ssh.html" class="link">ssh &nbsp;</a><a href="../tags/tutorials.html" class="link">tutorials &nbsp;</a><div class="footer">
                <hr>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
                </div>
            </div>
        </div>
    </div>  
    </div>
    </div>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    