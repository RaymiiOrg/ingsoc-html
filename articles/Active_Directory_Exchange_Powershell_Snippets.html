
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Active Directory and Exchange Command Line Powershell - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Active Directory and Exchange Command Line Powershell</h2><p><small>Published: 27-02-2016 | Author: Remy van Elst | <a href="Active_Directory_Exchange_Powershell_Snippets.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>This is a collection of Powershell snippets to install Active Directory, create
a new Active Directory Domain, join an existing Active Directory domain, create
an Active Directory user and to install Microsoft Exchange 2013. The snippets
were tested on Windows Server 2012 R2.</p>

<p>I&#39;m quite suprised with how easy it is to do the above tasks with Powershell.
Much faster than the GUI wizards.</p>

<p>As a Linux admin, I do also like that these tasks can be automated via the
command line. Also, my Windows knowledge is very limited. There are probably
better ways to do the below things, if you know how, please shoot me an email
via the contact page.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>Start with a freshly installed Server 2012 R2 machine (or VM). Fire up a
Powershell session.</p>

<h3>Install Active Directory</h3>

<p>The following command installs the Active Directory Domain Services role:</p>

<pre><code>Install-WindowsFeature -name AD-Domain-Services -IncludeManagementTools
</code></pre>

<h3>Create a new Active Directory Domain:</h3>

<p>First import the module in the PowerShell session:</p>

<pre><code>Import-Module ADDSDeployment
</code></pre>

<p>Initiate the new Active Directory:</p>

<pre><code>Install-ADDSForest
-CreateDnsDelegation:$false `
-DatabasePath &quot;C:\Windows\NTDS&quot; `
-DomainMode &quot;Win2012R2&quot; `
-DomainName &quot;raymii.nl&quot; `
-DomainNetbiosName &quot;RAYMII&quot; `
-ForestMode &quot;Win2012R2&quot; `
-InstallDns:$true `
-LogPath &quot;C:\Windows\NTDS&quot; `
-NoRebootOnCompletion:$false `
-SysvolPath &quot;C:\Windows\SYSVOL&quot; `
-Force:$true
</code></pre>

<p>Replace the <code>DomainName</code> and <code>DomainNetbiosName</code> with your chosen domain name.
PowerShell will then ask you for the AD Recovery Password, make it a strong one.</p>

<h3>Add a server to a domain</h3>

<p>This adds a server to an existing domain, as a backup domain controller. First
install the AD Domain Services as described above and import it in your
powershell session.</p>

<p>First test the existing domain to make sure you can join:</p>

<pre><code>Test-ADDSForestInstallation -DomainName raymii.nl
</code></pre>

<p>Add the server to the domain as a backup domain controller:</p>

<pre><code>Install-ADDSDomainController -InstallDns -Credential `
  (Get-Credential RAYMII\Administrator) -DomainName raymii.nl
</code></pre>

<p>It&#39;ll prompt you for the user password.</p>

<h3>Create an Active Directory user account</h3>

<p>To create a new Active Directory user account, use the below command. It&#39;s
enabled and has a password:</p>

<pre><code>New-ADUser -Name &quot;John Doe&quot; -GivenName John -Surname Doe `
  -SamAccountName jdoe -UserPrincipalName jdoe@craymii.nl `
  -AccountPassword (Read-Host -AsSecureString &quot;hunter2&quot;) `
  -PassThru | Enable-ADAccount
</code></pre>

<p>The user is able to login right away after this. The user is created in the
default <code>Users</code> OU.</p>

<h3>Create an Active Directory group</h3>

<p>Use the below command to create a new global group in the default <code>Users</code> folder
of Active Directory called &quot;Managers&quot;:</p>

<pre><code>New-ADGroup -name &quot;Managers&quot; -groupscope Global
</code></pre>

<p>If it needs to exist in different path in Active Directory, specify the path by
its distinguished name:</p>

<pre><code>New-ADGroup -name &quot;Managers&quot; -groupscope Global -path &quot;OU=OtherOU,DC=Raymii,DC=nl&quot;
</code></pre>

<h3>Add user to a group</h3>

<p>The below command adds the user <code>jdoe</code> to the <code>Managers</code> group:</p>

<pre><code>Add-ADGroupMember -Identity &quot;Managers&quot; -Member &quot;jdoe&quot;
</code></pre>

<p>To add a user in a different OU to a group in a different OU, you can specify
the full DN:</p>

<pre><code>Add-ADGroupMember -Identity &quot;CN=SupportSlavesGroup,OU=SupportSlaves,DC=raymii,DC=nl&quot; -Members &quot;CN=jdoe,OU=OtherUserOU,DC=raymii,DC=nl&quot; 
</code></pre>

<h3>Install Microsoft Exchange 2013</h3>

<p>Install the RSAT-DSS role via Powershell:</p>

<pre><code>Install-WindowsFeature RSAT-ADDS
</code></pre>

<p>We prepare the forest for the instalation of Exchange. First the Schema:</p>

<pre><code>setup /ps /IAcceptExchangeServerLicenseTerms
</code></pre>

<p>The Active Directory:</p>

<pre><code>setup /PrepareAD /OrganizationName:&quot;Raymii&quot; /IAcceptExchangeServerLicenseTerms
</code></pre>

<p>The Domain itself:</p>

<pre><code>setup /pd /IAcceptExchangeServerLicenseTerms
</code></pre>

<p>Install other required components and features for Exchange:</p>

<pre><code>Install-WindowsFeature AS-HTTP-Activation, Desktop-Experience, NET-Framework-45-Features, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, WAS-Process-Model, Web-Asp-Net45, Web-Basic-Auth, Web-Client-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-Console, Web-Metabase, Web-Mgmt-Console, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-Server, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation
</code></pre>

<p>You need to download and install the following setups manually from the
Microsoft website and install them in the order listed below:</p>

<ul>
<li>Unified Communications Managed API 4.0 Runtime</li>
<li>Microsoft Office 2010 Filter Pack 64 bit</li>
<li>Microsoft Office 2010 Filter Pack SP1 64 bit</li>
</ul>

<p>Start the actual Exchange installation:</p>

<pre><code>setup /m:Install /Roles:ca,mb,mt /IAcceptExchangeServerLicenseTerms /InstallWindowsComponents /DBFilePath:&quot;E:\EXCHANGE\MDB001.edb&quot; /LogFolderPath:&quot;E:\EXCHANGE&quot; /MdbName:&quot;MDB001&quot;
</code></pre>

<p>When it&#39;s finished, the ECP web admin is available.</p>
Tags: <a href="../tags/active-directory.html" class="link">active-directory</a>, <a href="../tags/articles.html" class="link">articles</a>, <a href="../tags/domain.html" class="link">domain</a>, <a href="../tags/exchange.html" class="link">exchange</a>, <a href="../tags/ldap.html" class="link">ldap</a>, <a href="../tags/microsoft.html" class="link">microsoft</a>, <a href="../tags/owa.html" class="link">owa</a>, <a href="../tags/powershell.html" class="link">powershell</a>, <a href="../tags/windows-server.html" class="link">windows-server</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>Generated by <a href="/s/software/ingsoc.html">ingsoc</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                <a href="/s/static/About.html">About</a><br />
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    