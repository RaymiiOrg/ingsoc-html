
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Openstack Soft Delete - recover deleted instances - Raymii.org</title>
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <script src="/s//inc/js/instant.js"></script> 
        <script src="/s//inc/js/toc.js"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="/s/inc/img/resistor-50.png" alt="Logo (IEC resistor symbol)">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>Openstack Soft Delete - recover deleted instances</h2>
<p><small>Published: 18-03-2017 | Author: Remy van Elst | <a href="Openstack_Soft_Delete_-_recover_deleted_instances.txt">Text only version of this article</a>
</small></p>
<div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc">
<h3>Table of Contents</h3>
</div>
<hr>
<div id="contents">
<p><img src="https://raymii.org/s/inc/img/ocata-lg.jpg" alt=""></p>

<p>This article contains both an end user and OpenStack administrator guide to set
up and use <code>soft_delete</code> with OpenStack Nova. If an instance is deleted with
nova delete, it&#39;s gone right away. If <code>soft_delete</code> is enabled, it will be
queued for deletion for a set amount of time, allowing end-users and
administrators to restore the instance with the <code>nova restore</code> command. This can
save your ass (or an end-users bottom) if the wrong instance is removed. Setup
is simple, just one variable in <code>nova.conf</code>. There are some caveats we&#39;ll also
discuss here.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<h3>Pro&#39;s and Con&#39;s</h3>

<p>There are some considorations you need to make when enabling soft-deletion. I&#39;ll
discuss them below.</p>

<p>The most important one is that instances are not deleted right away. If you&#39;re a
heavy API user, herding cattle (spawning and deleting many instances all the
time), capacity management might be a problem.</p>

<p><img src="https://raymii.org/s/inc/img/cloudscaling_pets_cattle_servers.jpg" alt=""></p>

<p>Let&#39;s say you set the <code>reclaim_instance_interval</code> to 3 days (because, what if a
user removes an instance during the weekend, this is a ass-saver after all), but
you spawn and remove about a hundred servers every day. (Let&#39;s assume you have
cloud-ready applications, good for you). Normally, the capacity (RAM, disk, cpu,
volumes, floating IP&#39;s, security groups) used by these VM&#39;s is removed right
away. With soft-delete enabled, all of this will be reserved until after 3 days
in this case. This means you need to have capacity to store 300 instances extra.
This can be mitigated by using <code>nova force-delete</code>. This delete function skips
the <code>SOFT_DELETE</code> state entirely. Or you can set the <code>reclaim_instance_interval</code>
to a smaller amount of time. This is a consideration you should plan for based
on the available infrastructure and usage patterns in your cloud.</p>

<p>The second caveat is that when you delete an instance, attached resources
(Volumes, Floating IP&#39;s, Security Groups) stay reserved. If you need a volume
that was attached to an instance that is soft-deleted, you first need to
<code>recover</code> that instance, then detach the volume (or other resource) and then
delete the instance again. Or detach the resource before you delete the
instance. Normally, when deleting an instance, the resources are released
automatically. If you use the API for resource management you <a href="https://github.com/hashicorp/terraform/issues/5104">need to</a> take
this into consideration as well.</p>

<p>The third is that a <code>nova list</code> doesn&#39;t show instances in the <code>SOFT_DELETED</code>
state. Recovering can only be done with the UUID, so you must have noted that
somewhere, or do a database query if you have that level of access. If a
floating IP or volume is still attached to the VM, you are able to get the UUID
from there, otherwise you&#39;re out of luck.</p>

<p>The positive part of soft-delete is that you can recover instances. I work for a
large cloud provider and the amount of times we get the question from end users
will suprise you. Higher up however decided that this feature should not be
enabled, so we always have to tell users something along the lines of &#39;Time to
restore your backups&#39;. Mostly this is because of the extreme amount of resources
being created and deleted, also because you just should have good backups
(regularly tested).</p>

<p>In a private cloud setting this is a much better argument. Users there will
probably remove the wrong instance and panic, call you, and you will be the hero
of the day. In a public cloud this can also be a feature, marketing wise.</p>

<p>Now, after all the points, let&#39;s continue on to the setup.</p>

<h3>Administrator setup</h3>

<p>In your <code>/etc/nova/nova.conf</code> file, there is a (commented by default) variable
<code>reclaim_instance_interval</code>. This is the amount of time, in seconds, that an
instance will at least be in the state <code>SOFT_DELETED</code>. There is a scheduler task
that runs every <code>$reclaim_instance_interval</code> seconds. It checks if an instance
has the state <code>SOFT_DELETED</code>, and if it is at least <code>reclaim_instance_interval</code>
seconds in this state. If so, it will be removed permanently. If you set
<code>reclaim_instance_interval</code> to 4 hours, and an instance is deleted just when
this task runs, it might overlap and will be removed after 8 hours, since one of
the two conditions is not met. In practice this won&#39;t happen very often.</p>

<p>You need to deploy this change to <code>nova.conf</code> on all your <code>nova-compute</code> servers
and everywhere the <code>nova-api</code> runs (<code>scheduler</code>, <code>conducter</code>, etc). Restart the
services afterwards.</p>

<h3>Testing</h3>

<p>After you&#39;ve enabled soft-delete, create an instance (<code>nova boot</code>), attach a
volume and make sure it boots:</p>

<pre><code>$ nova show 905b8228-6a0b-48ec-a7e6-e2e7b7460004
+--------------------------------------+----------------------------------------------------------------------------------------------------+
| Property                             | Value                                                                                              |
+--------------------------------------+----------------------------------------------------------------------------------------------------+
| OS-DCF:diskConfig                    | MANUAL                                                                                             |
| OS-EXT-AZ:availability_zone          | NL1                                                                                                |
| OS-EXT-SRV-ATTR:host                 | compute-3-7                                                                                        |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | compute-3-7                                                                                        |
| OS-EXT-SRV-ATTR:instance_name        | instance-00044243                                                                                  |
| OS-EXT-STS:power_state               | 1                                                                                                  |
| OS-EXT-STS:task_state                | -                                                                                                  |
| OS-EXT-STS:vm_state                  | active                                                                                             |
| OS-SRV-USG:launched_at               | 2017-03-18T10:21:25.000000                                                                         |
| OS-SRV-USG:terminated_at             | -                                                                                                  |
| accessIPv4                           |                                                                                                    |
| accessIPv6                           |                                                                                                    |
| config_drive                         |                                                                                                    |
| created                              | 2017-03-18T10:20:46Z                                                                               |
| flavor                               | Tiny (199)                                                                                         |
| hostId                               | 3d7ed510fb3dfa987e7eb7ae6f70106917a5feb57fe56ef740a1d9ed                                           |
| id                                   | 905b8228-6a0b-48ec-a7e6-e2e7b7460004                                                               |
| image                                | CloudVPS Ubuntu 16.04 (cda1773d-064c-4750-9c41-081467fc6575)                                       |
| metadata                             | {}                                                                                                 |
| name                                 | test-delete                                                                                        |
| net-public network                   | 185.3.210.299                                                                                     |
| os-extended-volumes:volumes_attached | [{&quot;id&quot;: &quot;6a664e03-46bf-4f7b-9eb7-14d16d305a6d&quot;}]                                                   |
| progress                             | 0                                                                                                  |
| security_groups                      | built-in-allow-icmp, built-in-allow-web, built-in-provider-access, built-in-remote-access, default |
| status                               | ACTIVE                                                                                             |
| updated                              | 2017-03-18T10:21:25Z                                                                               |
+--------------------------------------+----------------------------------------------------------------------------------------------------+
</code></pre>

<p>Delete the instance:</p>

<pre><code>$ nova delete 905b8228-6a0b-48ec-a7e6-e2e7b7460004
Request to delete server 905b8228-6a0b-48ec-a7e6-e2e7b7460004 has been accepted.
</code></pre>

<p>A <code>nova show</code> will now show the instance as SOFT_DELETED:</p>

<pre><code>$ nova show 905b8228-6a0b-48ec-a7e6-e2e7b7460004
+--------------------------------------+----------------------------------------------------------------------------------------------------+
| Property                             | Value                                                                                              |
+--------------------------------------+----------------------------------------------------------------------------------------------------+
| OS-DCF:diskConfig                    | MANUAL                                                                                             |
| OS-EXT-AZ:availability_zone          | NL1                                                                                                |
| OS-EXT-SRV-ATTR:host                 | compute-3-7                                                                                        |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | compute-3-7                                                                                        |
| OS-EXT-SRV-ATTR:instance_name        | instance-00044243                                                                                  |
| OS-EXT-STS:power_state               | 4                                                                                                  |
| OS-EXT-STS:task_state                | -                                                                                                  |
| OS-EXT-STS:vm_state                  | soft-delete                                                                                        |
| OS-SRV-USG:launched_at               | 2017-03-18T10:21:25.000000                                                                         |
| OS-SRV-USG:terminated_at             | -                                                                                                  |
| accessIPv4                           |                                                                                                    |
| accessIPv6                           |                                                                                                    |
| config_drive                         |                                                                                                    |
| created                              | 2017-03-18T10:20:46Z                                                                               |
| flavor                               | Tiny (199)                                                                                         |
| hostId                               | 3d7ed510fb3dfa987e7eb7ae6f70106917a5feb57fe56ef740a1d9ed                                           |
| id                                   | 905b8228-6a0b-48ec-a7e6-e2e7b7460004                                                               |
| image                                | CloudVPS Ubuntu 16.04 (cda1773d-064c-4750-9c41-081467fc6575)                                       |
| key_name                             | Remy                                                                                               |
| metadata                             | {}                                                                                                 |
| name                                 | test-delete                                                                                        |
| net-public network                   | 185.3.210.227                                                                                      |
| os-extended-volumes:volumes_attached | [{&quot;id&quot;: &quot;6a664e03-46bf-4f7b-9eb7-14d16d305a6d&quot;}]                                                   |
| security_groups                      | built-in-allow-icmp, built-in-allow-web, built-in-provider-access, built-in-remote-access, default |
| status                               | SOFT_DELETED                                                                                       |
| updated                              | 2017-03-18T10:50:25Z                                                                               |
+--------------------------------------+----------------------------------------------------------------------------------------------------+
</code></pre>

<p>The volume will still show as attached:</p>

<pre><code>$ cinder show 6a664e03-46bf-4f7b-9eb7-14d16d305a6d

+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Property                       | Value                                                                                                                                                                                               |
+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| attachments                    | [{&#39;id&#39;: &#39;6a664e03-46bf-4f7b-9eb7-14d16d305a6d&#39;, &#39;host_name&#39;: None, &#39;device&#39;: &#39;/dev/sdb&#39;, &#39;server_id&#39;: &#39;905b8228-6a0b-48ec-a7e6-e2e7b7460004&#39;, &#39;volume_id&#39;: &#39;6a664e03-46bf-4f7b-9eb7-14d16d305a6d&#39;}] |
| availability_zone              | NL1                                                                                                                                                                                                 |
| bootable                       | false                                                                                                                                                                                               |
| created_at                     | 2017-03-18T10:47:14.000000                                                                                                                                                                          |
| description                    | None                                                                                                                                                                                                |
| encrypted                      | False                                                                                                                                                                                               |
| id                             | 6a664e03-46bf-4f7b-9eb7-14d16d305a6d                                                                                                                                                                |
| metadata                       | {&#39;readonly&#39;: &#39;False&#39;, &#39;attached_mode&#39;: &#39;rw&#39;}                                                                                                                                                        |
| name                           | test-delete                                                                                                                                                                                         |
| os-vol-host-attr:host          | zfs-3-4                                                                                                                                                                                             |
| os-vol-mig-status-attr:migstat | None                                                                                                                                                                                                |
| os-vol-mig-status-attr:name_id | None                                                                                                                                                                                                |
| size                           | 8                                                                                                                                                                                                   |
| snapshot_id                    | None                                                                                                                                                                                                |
| source_volid                   | None                                                                                                                                                                                                |
| status                         | in-use                                                                                                                                                                                              |
| volume_type                    | None                                                                                                                                                                                                |
+--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</code></pre>

<p>Horizon and other interfaces will probably show it as well:</p>

<p><img src="https://raymii.org/s/inc/img/soft-delete.png" alt=""></p>

<p><img src="https://raymii.org/s/inc/img/soft-delete2.png" alt=""></p>

<p>Using the <code>nova restore</code> command we can bring back the server:</p>

<pre><code>$ nova restore 905b8228-6a0b-48ec-a7e6-e2e7b7460004
</code></pre>

<p>There is no output. A <code>nova show</code> will show the server back in <code>ACTIVE</code> state,
it will boot up as if it had a regular shutdown.</p>

<p>Now do this again and await the scheduler. If you then do a <code>nova show</code>, the
instance should be removed and the volume should be released.</p>

<h3>End user usage</h3>

<p>The <code>nova restore</code> action is by default not admin only. If you have a UUID you
can restore an instance, if the public cloud provider has enabled this feature.</p>

<p>To test if it is enabled, just remove an instance and see if it goes into the
<code>SOFT_DELETED</code> state with <code>nova show</code>. If so, send them a message / ticket
asking what the scheduler timeout is, how long you can recover the instance.</p>

<h3>Database query to get all soft_deleted instances</h3>

<p>If you manage a private cloud and someone calls you to recover their instance,
if you have access to the database of nova, you can execute the following query
to get all instances in soft <em>deleted state with their UUID. The caller will
probably have a name, and otherwise a tenant</em> id helps as well. Then just do a
<code>nova recover</code> and you&#39;re all set:</p>

<pre><code>SELECT uuid,hostname,project_id FROM nova.instances WHERE vm_state = &#39;soft-delete&#39;;
</code></pre>

<p>Example output:</p>

<pre><code>+--------------------------------------+--------------------+----------------------------------+
| uuid                                 | hostname           | project_id                       |
+--------------------------------------+--------------------+----------------------------------+
| 8b6f7517-8155-463a-a277-e08d5597c1cd | test               | c3347bc952eb4904bb922c379beb1932 |
| 73e6f3bf-e3b8-432f-b6ce-4208f476b8f9 | khjkjhkjhjkhkhkhjk | e80a4d46437446b1b51d57ecc566f9e4 |
| 169c8696-d831-4331-8a7e-831b1526bbac | jkhjkhkh           | 3335ae642c4a42549b7a4489adf98d7c |
| 8c7a7c1f-bfa9-41cc-8172-9fa190f3ff9d | c7-test            | e80a4d46437446b1b51d57ecc566f9e4 |
| 099b37fa-04f8-4561-a6f4-e5d9d0bd9223 | lkjlkjlkj          | e80a4d46437446b1b51d57ecc566f9e4 |
| 905b8228-6a0b-48ec-a7e6-e2e7b7460004 | test-delete        | 3335ae642c4a42549b7a4489adf98d7c |
+--------------------------------------+--------------------+----------------------------------+
6 rows in set (0.20 sec)
</code></pre>
Tags: <a href="../tags/articles.html">articles</a>
, <a href="../tags/backup.html">backup</a>
, <a href="../tags/cloud.html">cloud</a>
, <a href="../tags/compute.html">compute</a>
, <a href="../tags/nova.html">nova</a>
, <a href="../tags/openstack.html">openstack</a>
, <a href="../tags/soft-delete.html">soft-delete</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
     
    </main>
    </body>
    </html>
    