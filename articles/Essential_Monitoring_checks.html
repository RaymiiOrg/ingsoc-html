    <!DOCTYPE html><html lang="en"><head><title>Essential Monitoring checks - Raymii.org</title><style>*,::before,::after{background-repeat:no-repeat;-webkit-box-sizing:border-box;box-sizing:border-box}::before,::after{text-decoration:inherit;vertical-align:inherit}html{cursor:default;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;word-break:break-word}body{margin:0}h1{font-size:2em;margin:.67em 0}hr{height:0;overflow:visible}main{display:block}nav ol,nav ul{list-style:none}pre{font-family:Menlo,Consolas,Roboto Mono,Ubuntu Monospace,Noto Mono,Oxygen Mono,Liberation Mono,monospace;font-size:1em}a{background-color:transparent}abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:Menlo,Consolas,Roboto Mono,Ubuntu Monospace,Noto Mono,Oxygen Mono,Liberation Mono,monospace;font-size:1em}small{font-size:80%}::-moz-selection{background-color:#b3d4fc;color:#000;text-shadow:none}::selection{background-color:#b3d4fc;color:#000;text-shadow:none}audio,canvas,iframe,img,svg,video{vertical-align:middle}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}img{border-style:none}svg:not([fill]){fill:currentColor}svg:not(:root){overflow:hidden}table{border-collapse:collapse}button,input,select,textarea{font-family:inherit;font-size:inherit;line-height:inherit}button,input,select{margin:0}button{overflow:visible;text-transform:none}button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button}fieldset{padding:.35em .75em .625em}input{overflow:visible}legend{color:inherit;display:table;max-width:100%;white-space:normal}progress{display:inline-block;vertical-align:baseline}select{text-transform:none}textarea{margin:0;overflow:auto;resize:vertical}[type="checkbox"],[type="radio"]{padding:0}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}details{display:block}dialog{background-color:white;border:solid;color:black;display:block;height:-moz-fit-content;height:-webkit-fit-content;height:fit-content;left:0;margin:auto;padding:1em;position:absolute;right:0;width:-moz-fit-content;width:-webkit-fit-content;width:fit-content}dialog:not([open]){display:none}summary{display:list-item}canvas{display:inline-block}template{display:none}a,area,button,input,label,select,summary,textarea,[tabindex]{-ms-touch-action:manipulation;touch-action:manipulation}[hidden]{display:none}[aria-busy="true"]{cursor:progress}[aria-controls]{cursor:pointer}[aria-disabled="true"],[disabled]{cursor:not-allowed}[aria-hidden="false"][hidden]:not(:focus){clip:rect(0,0,0,0);display:inherit;position:absolute}main,header,footer,article,section,aside,details,summary{margin:0 auto;margin-bottom:16px;width:100%}main{display:block;margin:0 auto;max-width:1000px;padding:0 16px 16px}footer{border-top:1px solid rgba(0,0,0,.12);padding:16px 0;text-align:left}footer p{margin-bottom:0}hr{border:0;border-top:1px solid rgba(0,0,0,.12);display:block;margin-top:16px;margin-bottom:16px;width:100%;-webkit-box-sizing:content-box;box-sizing:content-box;height:0;overflow:visible}img{height:auto;max-width:100%;vertical-align:baseline}@media screen and (max-width:400px){article,section,aside{clear:both;display:block;max-width:100%}img{margin-right:16px}}embed,iframe,video{border:0}body{color:rgba(0,0,0,.8);font-family:"Raleway",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5}p{margin:0;margin-bottom:16px}h1,h2,h3,h4,h5,h6{color:inherit;font-family:inherit;line-height:1.2;font-weight:500}h1{font-size:40px;margin:20px 0 16px}h2{font-size:32px;margin:20px 0 16px}h3{font-size:28px;margin:16px 0 4px}h4{font-size:24px;margin:16px 0 4px}h5{font-size:20px;margin:16px 0 4px}h6{font-size:16px;margin:16px 0 4px}small{color:rgba(0,0,0,.54);vertical-align:bottom}pre{background:#f7f7f9;color:rgba(0,0,0,.8);display:block;font-family:Menlo,Monaco,Consolas,"Courier New",monospace;font-size:16px;margin:16px 0;padding:16px;white-space:pre-wrap;overflow-wrap:break-word}code{color:rgba(0,0,0,.8);font-family:Menlo,Monaco,Consolas,"Courier New",monospace;font-size:16px;line-height:inherit;margin:0;padding:0;vertical-align:baseline;word-break:break-all;word-wrap:break-word}a{color:#75cc00;text-decoration:none;background-color:transparent}a:hover,a:focus{color:#0062cc;text-decoration:underline}dl{margin-bottom:16px}dd{margin-left:40px}ul,ol{margin-bottom:8px;padding-left:40px;vertical-align:baseline}blockquote{border-left:2px solid rgba(0,0,0,.8);font-family:Georgia,Times,"Times New Roman",serif;font-style:italic;margin:16px 0;padding-left:16px}figcaption{font-family:Georgia,Times,"Times New Roman",serif}u{text-decoration:underline}s{text-decoration:line-through}sup{font-size:14px;vertical-align:super}sub{font-size:14px;vertical-align:sub}mark{background:#ffeb3b}input[type="text"],input[type="password"],input[type="email"],input[type="url"],input[type="date"],input[type="month"],input[type="time"],input[type="datetime"],input[type="datetime-local"],input[type="week"],input[type="number"],input[type="search"],input[type="tel"],select,textarea{background:#fff;background-clip:padding-box;border:1px solid rgba(0,0,0,.12);border-radius:4px;color:rgba(0,0,0,.8);display:block;width:100%;padding:8px 16px;line-height:1.5;-webkit-transition:border-color .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;transition:border-color .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}input[type="color"]{background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:4px;display:inline-block;vertical-align:middle}input:not([type]){-webkit-appearance:none;background:#fff;background-clip:padding-box;border:1px solid rgba(0,0,0,.12);border-radius:4px;color:rgba(0,0,0,.8);display:block;width:100%;padding:8px 16px;line-height:1.5;-webkit-transition:border-color .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;transition:border-color .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;text-align:left}input[type="text"]:focus,input[type="password"]:focus,input[type="email"]:focus,input[type="url"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,input[type="week"]:focus,input[type="number"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="color"]:focus,select:focus,textarea:focus{background-color:#fff;border-color:#80bdff;outline:0;-webkit-box-shadow:0 0 0 .2rem rgba(0,123,255,.25);box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}input:not([type]):focus{background-color:#fff;border-color:#80bdff;outline:0;-webkit-box-shadow:0 0 0 .2rem rgba(0,123,255,.25);box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}input[type="file"]:focus,input[type="radio"]:focus,input[type="checkbox"]:focus{outline:1px thin rgba(0,0,0,.12)}input[type="text"][disabled],input[type="password"][disabled],input[type="email"][disabled],input[type="url"][disabled],input[type="date"][disabled],input[type="month"][disabled],input[type="time"][disabled],input[type="datetime"][disabled],input[type="datetime-local"][disabled],input[type="week"][disabled],input[type="number"][disabled],input[type="search"][disabled],input[type="tel"][disabled],input[type="color"][disabled],select[disabled],textarea[disabled]{background-color:rgba(0,0,0,.12);color:rgba(0,0,0,.54);cursor:not-allowed;opacity:1}input:not([type])[disabled]{background-color:rgba(0,0,0,.12);color:rgba(0,0,0,.54);cursor:not-allowed;opacity:1}input[readonly],select[readonly],textarea[readonly]{border-color:rgba(0,0,0,.12);color:rgba(0,0,0,.54)}input:focus:invalid,textarea:focus:invalid,select:focus:invalid{border-color:#ea1c0d;color:#f44336}input[type="file"]:focus:invalid:focus,input[type="radio"]:focus:invalid:focus,input[type="checkbox"]:focus:invalid:focus{outline-color:#f44336}select{border:1px solid rgba(0,0,0,.12);vertical-align:sub}select:not([size]):not([multiple]){height:-webkit-calc(2.25rem + 2px);height:calc(2.25rem + 2px)}select[multiple]{height:auto}label{display:inline-block;line-height:2}fieldset{border:0;margin:0;padding:8px 0}legend{border-bottom:1px solid rgba(0,0,0,.12);color:rgba(0,0,0,.8);display:block;margin-bottom:8px;padding:8px 0;width:100%}textarea{overflow:auto;resize:vertical}input[type=checkbox],input[type=radio]{-webkit-box-sizing:border-box;box-sizing:border-box;padding:0;display:inline}input[type=submit],input[type=reset],input[type=button],button{background-color:#75cc00;border:#75cc00;border-radius:4px;color:#fff;padding:8px 16px;display:inline-block;font-weight:400;text-align:center;white-space:nowrap;vertical-align:middle;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;border:1px solid transparent;font-size:1rem;line-height:1.5;-webkit-transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,-webkit-box-shadow .15s ease-in-out;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out,-webkit-box-shadow .15s ease-in-out}input[type=submit]::-moz-focus-inner,input[type=reset]::-moz-focus-inner,input[type=button]::-moz-focus-inner,button::-moz-focus-inner{padding:0}input[type=submit]:hover,input[type=reset]:hover,input[type=button]:hover,button:hover{background-color:#0069d9;border-color:#0062cc;color:#fff}input[type=submit]:not(:disabled):active,input[type=reset]:not(:disabled):active,input[type=button]:not(:disabled):active,button:not(:disabled):active{background-color:#0062cc;border-color:#005cbf;color:#fff}input[type=submit]:focus,input[type=reset]:focus,input[type=button]:focus,button:focus{outline:0;-webkit-box-shadow:0 0 0 .2rem rgba(0,123,255,.5);box-shadow:0 0 0 .2rem rgba(0,123,255,.5)}input[type=submit]:disabled,input[type=reset]:disabled,input[type=button]:disabled,button:disabled{opacity:.65;cursor:not-allowed;background-color:#75cc00;border-color:#75cc00;color:#fff}table{border-top:1px solid rgba(0,0,0,.12);margin-bottom:16px}caption{padding:8px 0}thead th{border:0;border-bottom:2px solid rgba(0,0,0,.12);text-align:left}tr{margin-bottom:8px}th,td{border-bottom:1px solid rgba(0,0,0,.12);padding:16px;white-space:nowrap;vertical-align:inherit}tfoot tr{text-align:left}tfoot td{color:rgba(0,0,0,.54);font-size:8px;font-style:italic;padding:16px 4px}a.skip-main{left:-999px;position:absolute;top:auto;width:1px;height:1px;overflow:hidden;z-index:-999}a.skip-main:focus,a.skip-main:active{color:#fff;background-color:#000;left:auto;top:auto;width:30%;height:auto;overflow:auto;margin:10px 35%;padding:5px;border-radius:15px;border:4px solid yellow;text-align:center;font-size:1.2em;z-index:999}@font-face{font-family:'Raleway';font-display: swap;font-style:normal;font-weight:400;src:url(/s/inc/css/raleway.eot);src:local('Raleway'),local('Raleway'),url(/s/inc/css/raleway.ttf)}.headheader{font-family:"Raleway"!important}.headheader a{color:#000;text-decoration:none}.headheader a:hover{color:#000;text-decoration:none!important}</style><script>window.onload=function(){var a="",b=0;document.getElementById("contents").innerHTML=document.getElementById("contents").innerHTML.replace(/<h([\d])>([^<]+)<\/h([\d])>/gi,function(c,d,e,f){if(d!=f)return c;d>b?a+=Array(d-b+1).join(""):d<b&&(a+=Array(b-d+1).join("")),b=parseInt(d);var g=e.replace(/ /g,"_");return a+="<a href=\"#"+g+"\">"+e+"</a><br/>","<h"+d+"><a name=\""+g+"\">"+e+"</a></h"+f+">"}),b&&(a+=Array(b+1).join("")),document.getElementById("toc").innerHTML+=a};</script><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"><link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/><link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" /></head><body><a id="top-of-page"></a><main><a class="skip-main" href="#main">Skip to main content</a><header><h1 class="headheader"><a href="https://raymii.org/s/">Raymii.org                         <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAKCAYAAAD2Fg1xAAABgElEQVQ4jb3VP0iVYRTH8c9waXBokog7OYhTXChuF3GIi4hoiJA4REQIOTgGtoWTg6ODs0SYComIXCJEMhpKtD9guUU0ujRFS0PQ8DzC24v3Pq+3S9/pnMOP8/7Ocx6el/OziRN0JXTD+I2xhK4WdeNteGmbu8IgC3jQQlfCZ0zgINHzJabwoQP+ClHGV1zGJXwRDJ/FDJZi3MBQE10dL2K8gZFOGE3REDZyyjLunKG7KAzZHfMaXjXp+QbXYlzBfrvmSuhBNaHrxQU8zdQW8RhrOe0snuB7zA/jd6p4n9HV8QMfY/4JPzGAt7meFfS18LdXEk7uemIQuJ/Lj6PZQezFWhm3cTWnXcAj3MrU5oWh5WpzGM3UurGNZy28HSa8J7mB3Uy+4u/rl+UdrsT4Jraa6F6jP5M3MP0PHguzL9zzqmC2GRNYjXF2qDzDwgbgHp53wGMhJrEunGQ9oT3CQ+GFasWBsLVvwiv5XygJz/JOAe208POrJHST+CVspBB/AFY9Q3+QJqLxAAAAAElFTkSuQmCC" alt="Logo (IEC resistor symbol)"></a></h1><small>                  Quis custodiet ipsos custodes?<br><a href="/s/">Home</a> |                   <a href="/s/static/About.html">About</a> |                   <a href="/s/tags/all.html">All pages</a> |                   <a href="https://raymii.org/s/feed.xml">RSS Feed</a> |                   <a href="gopher://raymii.org:70">Gopher</a></small></header><h2 class='headheader' id='main'>Essential Monitoring checks</h2><p><small>Published: 20-03-2018 | Author: Remy van Elst | <a href="Essential_Monitoring_checks.txt">Text only version of this article</a></small></p><div class='ad'><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle"                                 style="display:inline-block;width:728px;height:90px"                                 data-ad-client="ca-pub-7993642564731324"                                 data-ad-slot="6172324376"></ins><script>                            (adsbygoogle = window.adsbygoogle || []).push({});                            </script></div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p><img src="https://raymii.org/s/inc/img/monitoring.jpg" alt=""></p><p>In this article I&#39;ll provide a list of checks I consider essential formonitoring and why they are usefull. It&#39;s on different levels, ranging from yourapplication (health checks), to operating system (disk usage, load) and hardware(iDrac, disks, power). Use it as a starting point when setting up yourmonitoring.</p><p>These checks can be setup in many different monitoring systems and with manydifferent technical solutions. One solution might be Nagios/Icinga2 with<code>nrpe</code>/<code>nsca</code>, one might be PRTG with snmp or one might be Pingdom. This list ismeant for you to look at and think, this could be usefull in our setup, thenimplement it in your own system.</p><p>If you have no monitoring at all, I recommend looking into Icinga2 or Nagios,but that&#39;s just personal preference. Read an <a href="https://raymii.org/s/tutorials/Nagios_Core_4_Installation_on_Ubuntu_12.04.html">install guide</a> and check out<a href="https://raymii.org/s/tags/monitoring.html">all my monitoring articles here</a>.</p><p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital OceanVPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p><p>This is quite a lengthy article, but using the table of contents you can skipdirectly to the sections relevant to you.</p><h3>What to monitor and when to alert?</h3><p>The short answer is <code>monitor as much as possible, escalate as few times aspossible</code>.</p><p>To expand on that, from the perspective of a systems administrator, more metricsand checks are better. Just as more logging and more documentation. Checks andmonitoring on every level and aspect of your environment help to diagnose issuesearly on and make sure they don&#39;t happen again.</p><p>Monitoring helps when doing a post-mortem. To be able to see what failed, why itfailed and what other things were affected is the holy grail during incidentmanagement. It saves time for you as a sysadmin, and thus downtime for yourusers. Not only because you can pinpoint problems faster due to not having todig everywhere, but also because you can focus on actual work instead offirefighting because everything is always broken.</p><p>You however don&#39;t want to be alerted for every issue. Many checks are allowed tofail or reach a certain threshold before things get critical. Environments Ibuild are always redundant and highly available, so I don&#39;t want to be awakendbecause one disk somewhere is nearly full. I don&#39;t even want to be awakened whentwo of the three datacenters / amazon regions are burning down, as long as theapplication / service is still working. The next business day I do want to lookat my dashboards and see that something went wrong, but as long as the actualservice was working, don&#39;t bother me. That&#39;s why I build high available systems,so that any component can fail without impact.</p><p>I do want to know when issues arise, so email alerts for all notifications arefine. I can work on those alerts when I have the time, and implement structuralfixes instead of hotfixes.</p><p>Whenever a more critical component fails, I&#39;d like to get a text message /<a href="https://pushover.net/">Pushover</a>. One example is when a database reports one or more clustermembers have failed, or when a cluster file system (like DRBD or GlusterFS) arein a degraded state. That is a failure that the cluster should be able totolerate, but does require fixing. I can still decide when I fix that, but somealerts have a bit more urgency then just an email.</p><p>When the application or service provided to the users fails, I want to becalled. When I&#39;m called it&#39;s urgent and on fire, must be fixed now. In thearticle I&#39;ll go in to different levels of alerting more per check.</p><p>Summarizing the above, I like to use three levels of alerting:</p><ul><li>issue, but not critical: email</li><li>issue or failure of a cluster component: text / pushover message</li><li>failure of service alltogether (SLA): call</li></ul><p>You can delegate different types of alerting to more junior members of yourteam. By doing that, they are learning about the environment, you have less workto do and your documentation is checked as well.</p><p>By decreasing the amount of alerts that require direct action, you also create acalmer work environment, thus resulting in happier sysadmins.</p><h4>Metrics</h4><p>Nagios and many other monitoring systems support saving history of alerts andmetrics. Nagios calls this <a href="http://nagios-plugins.org/doc/guidelines.html#AEN200">performance data</a>. Using a third party tool like<a href="http://nagiosgraph.sourceforge.net/">nagiosgraph</a>, or more modern, <a href="https://grafana.com/">Grafana</a>, you can turn these metrics intographs and dashboards.</p><p>Here is an example of the perfdata from the <code>check_http</code> plugin sent to <code>statsd</code>and graphed via Grafana:</p><p><img src="https://raymii.org/s/inc/img/https-graph.png" alt=""></p><p>In this graph, of the past 6 months, you can see 1 extra VIP (virtual IP, theloadbalancer high available IP) being added and this specific cluster havingperformance issues for about 10 days, as the response time goes from an averageof 200 ms to 800 ms.</p><p>Using metrics and easy to view graphs like these allow you to quickly get anoverview and historical state of your checks. They help to search down&#39;hunches&#39;, but can also confirm that everything is running smoothly for the pastmonths.</p><p>Graphs are especcialy usefull for latency checks, like disk performance, load orresponse times.</p><h3>Application</h3><p>With <code>application</code>, I mean the software you run on top of your server (or servercluster). This can be a website, CMS like Wordpress, but also an applicationservice like <code>jboss</code>, custom software or whatever. The thing that is providingservice to your users, or part of the service (like an API gateway, <code>tyk</code>).</p><h4>Health check</h4><p>The most important check of them all, the application health check. This is acheck that your application handles, and based on the result of that check, inmost cases, gives an HTTP 200 OK or a HTTP 500 internal server error. The check,which you must probably write yourself, checks all essential things theapplication needs to work correctly.</p><p>In the case of an ERP system it could be the local database, the vendor stockmanagement API and the payment API.</p><p>In case of a media (video) system this could be the the backend which houses allthe actual content, the DRM service and the customer database.</p><p>This check is, in my opinion, one of the few checks that should alert you byphone (or something that wakes you up at night). If this check fails, so willthe application and thus the service to your users. If you&#39;ve correctly setupyour high available redundant cluster any one part of it can fail withoutalerting you, but if the application health check fails, you should be woken up.Using the other monitoring you have (but which only alerts via email forexample), you&#39;re able to quickly find and fix the issue at hand.</p><h4>HTTP/HTTPS check</h4><p>In the case of a web application, a check on the HTTP(s) status code. 200 meansall is well, anything else probably means something is wrong.</p><p>Example output from Nagios:</p><pre><code>HTTP OK: HTTP/1.1 200 OK - 11595 bytes in 0.001 second response time</code></pre><p>If this check is triggered, your webserver has an issue. Check the logs for moreinformation. Examples I&#39;ve seen are the application server (like PHP, mod_pythonor Passenger) not working correctly, or someone making a mistake in a<code>.htaccess</code> file or <code>nginx</code> config.</p><h4>Brute force login</h4><p>If your application deals with login and user accounts, it is great to know whena brute force is going on. You must also have brute force protection, read the<a href="https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project">OWASP top 10 2017</a> for more tips on that. Even though, a high load due tobrute force attempts (logins can&#39;t be cached thus hit your database every time)is not a nice thing to have.</p><p>Just as the health check this is one of those checks that you must probablywrite yourself. Combine it with something like <code>fail2ban</code> for automatic blockingafter a set amount of failed attempts.</p><h4>API test</h4><p>If your application is dependent on external API&#39;s, it&#39;s a good thing to checkthe endpoints. Try to make a check that mimics something your application woulddo. Alert when it fails, your external provider might have an issue, or changedits API. This will help you diagnose issues quickly before your applicationfails.</p><p>This check could be integrated in the applicaton health check. I know of atelevision station which checks all their external content provider API&#39;s thisway so they know when the providers fail to meet their SLA&#39;s.</p><h4>Certificate expiry</h4><p>Again just for web applications, check when your certificates expire. Exampleoutput from Nagios:</p><pre><code>OK - Certificate &#39;www.raymii.nl&#39; will expire on Fri 29 Jun 2018 12:59:00 AM CEST.</code></pre><p>Let this check alert a month in advance to cover for vacation or validationissues with the certificate. If you use Let&#39;s Encrypt, make it 7 days or thelike, since that&#39;s more automatic.</p><p>If you have an Extended Validation certificate, let it alert 2 to 3 months aheadto cover any validation issues.</p><h4>Application functional tests</h4><p>This one falls in the same category as the health check. You can have many ofthese with lower alerting levels. This check does one thing as part of yourapplication. For a webshop, this could be placing an order and checking if theconfirmation email is received. And of course removing that order afterwards.</p><p>For a certificate authority, this could be requesting a certificate and checkingthe serial and expiry date of the given certificate.</p><p>For a cloud provider, this could be creating a VM, attaching an extra disk,checking if the extra disk works, if the IP pings, and then removing the VM.This way multiple parts of the system are touched in a way users also would do.Not all problems are caught this way, for example, if you have multiplehypervisors, one could have an issue but the check could create the VM on ahypervisor without isssues, but that should be caught by your detailedmonitoring of that specific hypervisor.</p><p>Here is some example output of one of the checks my current work does on theirhypervisor platform:</p><pre><code>OK: All tasks completed: Created instance with uuid $uuid: Pinging the server on ip $ipaddr successfull for 20 times after 34 attempts: SSH connection to $ipaddr successfull: Created volume with uuid $uuid: Attached volume successfully: Volume mounted in instance successfully: Deleted instance: Deleted volume</code></pre><p>When the check fails, for example when the volume service (<code>cinder</code>) schedulerhad an issue:</p><pre><code>ERROR: Created instance with uuid $uuid: Pinging the server on ip $ipaddr successfull for 20 times after 34 attempts: SSH connection to $ipaddr successfull: Created volume with uuid $uuid: Task attachVolume failed: Timeout waiting for $uuid to transition to in-use: Deleted instance: Deleted volume</code></pre><p>Another functional check we have is how many usable public IP&#39;s are allocated.If that falls below a certain number that can be the cause of a non-workingservice (as in your VM has no IP):</p><pre><code>OK: 8924 Usable Public IP&#39;s</code></pre><p>When a certain threshold is reached:</p><pre><code>WARNING: 800 Usable Public IP&#39;s</code></pre><p>That way we know when it&#39;s time to add a new subnet to Neutron.</p><p>A functional check can also include a latency check, for example, if you run afile service that download times on files are not lower than X. In that case,the definition of a working service requires X speed, and the functional testcan help you with that.</p><p>As you can see, functional checks can be as wide and varied as possible. Theyare valuable because they &#39;hit&#39; multiple levels of your stack and can helpdiagnose problems earlier. They are not the holy grail, because they aregeneric. In the case of the VM creation check, we can see that somewhere in thevolume part there is a failure. Dedicated monitoring of that service showed thatthe scheduler stopped, but it we didn&#39;t had that monitoring finding the actualcause would be difficult. Not to say that it is not a valuable check, it shouldnot be the only one to rely on.</p><h3>Services</h3><p>With <code>services</code> I mean applications providing a service on top of the operatingsystem. For example, Active Directory, MSSQL, your database, web server, loadbalancer or cluster software. Anything that is not directly the hardware oroperating system, but also not your application or service itself.</p><p>The lines are a bit blurry, because a process check, is that OS or service? Ilist those under OS, but they could just as well fall under services. If yourservice is providing a database, then that would fall under &#39;Application&#39; hereabove, but if the database is a component of your stack, it falls underservices.</p><p>I&#39;ll list a few of the checks I often utilize below, but of course, they are notlimited to just the ones below. As with this entire article, take what you needand adapt it to your environment.</p><h4>haproxy backends and frontends</h4><p>My loadbalancer of choice, because of the features, stability and monitoring /statistics. Read <a href="https://thehftguy.com/2016/10/03/haproxy-vs-nginx-why-you-should-never-use-nginx-for-load-balancing/">this article</a> for a nice overview why <code>haproxy</code> is bettermost of the times.</p><p>In haproxy you define frontends and backends. A frontend can be the point ofentry for your website, the backends can be multiple webservers. The frontendcan also be a TCP port and the backend a collection of redis/mysql servers. Thischeck, applicable for all load balancers, shows you which frontends and backendsare down (reported by haproxy):</p><pre><code>Check haproxy OK - checked 10 proxies.</code></pre><p>Failure:</p><pre><code>Check haproxy CRITICAL - server: appserver:app1 is MAINT (check status: layer 4 check OK): server: mysql:mysql_master is DOWN (check status: connection error): server: mysql:mysql_backup is DOWN (check status: connection error): BACKEND: mysql is DOWN:</code></pre><p>This check is not usefull when you have an active / passive setup, then it willalways alert because the passive systems are down. A two node redis cluster withhaproxy in front as entry point will have one active (MASTER) node and one down(SLAVE) node. The redis sentinels do a haproxy API call to switch the backendwhen required, but never are two redis servers up at the same time (the slave isread only until promoted to master, then the other master drops all it&#39;s dataand resyncs with the new master, as a slave).</p><p>I&#39;ve written a wrapper around this check that only escalates an alert when allbackends are down. Alerting is done via email otherwise, only DOWN and notMAINTENANCE, since maintenance is deliberate.</p><h4>DNS</h4><p>If you run your own local resolvers your servers are dependent on them, so theymust return correct results. Not only monitor the actual service itself, butalso it if returns correct results. Using this Nagios check, we specify thehostname and the expected IP&#39;s in return. This check works with all recordstypes (A, AAAA, MX, TXT etc.) thus can also be used to check if your MX recordsare still there and such. Very usefull in an environment where multiple peopledo DNS changes. Sometimes errors are made, like that BIND used <code>;</code> as a commentcharacter instead of <code>#</code>, and you don&#39;t want to have two hours without DNS.Response time can also be alerted on. Example output:</p><pre><code>DNS OK: 0.007 seconds response time. identity.stack.cloudvps.com returns 89.31.101.74, 89.31.101.76</code></pre><p>Alerting can be email only. It can happen that the alert is a false positive,because of actual DNS changes.</p><h4>MySQL, Galera (or Postgres)</h4><p>The database of choice for many people, single server, master-slave or master-master replication or a full blown Galera cluster. To monitor, I often create aseperate user (named <code>monitoring</code>). The Nagios plugin example output is listedbelow:</p><pre><code>Uptime: 1381613 Threads: 4 Questions: 4459389 Slow queries: 16 Opens: 12935 Flush tables: 1 Open tables: 400 Queries per second avg: 3.227</code></pre><p>This check put in a graph looks like <a href="https://raymii.org/s/inc/img/grafana-mysql.png">this</a>. Usefull to have when a newversion of your application is deployed and there is a tenfold increase inqueries and cache misses.</p><p>If you run a replication or cluster setup, it is important to check that aswell. The replication checks I use looks like this:</p><pre><code>OK - Waiting for master to send event, replicating host 10.0.0.100:3306</code></pre><p>Failure:</p><pre><code>CRITICAL - Replication problem: Slave IO not running!</code></pre><p>For Galera I use <a href="https://exchange.nagios.org/directory/Plugins/Databases/MySQL/check_galera_cluster/details">this check</a> which alerts if there are problems with theamount of nodes in the cluster.</p><p>In my use cases, I don&#39;t let this check escalate, since the application healthcheck catches this as well and that check already escalates.</p><h4>Corosync</h4><p>Corosync (and pacemaker) is the cluster resource manager. This service ensuresthat clustered resources and resource groups only run on the correct nodes andensure failover when required. One of the most important parts in a clustersetup. It can cluster almost anything, but I most often use it for <code>drbd</code>(filesystem), <code>postgres</code> (database) and high-available OpenStack instances with<a href="https://wiki.openstack.org/wiki/Masakari">Masakari</a>.</p><p>We have different checks on corosync, the generic one checks the status of allrings, if <a href="https://en.wikipedia.org/wiki/STONITH">stonith</a> is enabled, if maintenance mode is not enabled and ifthere are no failed actions:</p><pre><code>OK - ring 0: Ok, ring 1: Ok, failed: Ok, stonith: Ok, maintenance: OkOK:     status  = ring 0 active with no faultsOK:     status  = ring 1 active with no faultsOK: CRM masterOK: No failed actions present...OK: Stonith is enabled...OK: Maintenance Mode is inactive...</code></pre><p>It alerts with a warning when maintenance mode is enabled:</p><pre><code>WARN - ring 0: Ok, ring 1: Ok, failed: Ok, stonith: WARN, maintenance: WARNOK:     status  = ring 0 active with no faultsOK:     status  = ring 1 active with no faultsOK: No failed actions present...WARNING: Stonith is disabled...WARNING: Maintenance Mode is active...</code></pre><p>When the cluster starts failing, it will escalate:</p><pre><code>CRIT - ring 0: Ok, ring 1: Ok, failed: CRIT, stonith: CRIT, maintenance: CRITOK:     status  = ring 0 active with no faultsOK:     status  = ring 1 active with no faultsCRITICAL: could not connect to CRM...CRITICAL: could not connect to CRM...CRITICAL: could not connect to CRM...</code></pre><p>One extra check I enable specificaly to catch maintenance errors is a check on <a href="https://crmsh.github.io/man-2.0/#cmdhelp_resource_move">moved resources</a>:</p><pre><code>OK: Manual move is inactive...</code></pre><p>With <code>crm resource move</code>, if you leave out the expiry time, the resource willnever run on that node until it is <code>cleared</code>/<code>unmoved</code> (<a href="https://crmsh.github.io/man-2.0/#cmdhelp_resource_clear">manpage</a>). If youforget to clear a resource and the other nodes fail, even when this node ishealthy, the cluster will not move it there resulting in an outage. This checkreminds you that you have uncleared resources, so that when you&#39;ve finished yourmaintenance you don&#39;t forget to clear the resource.</p><h4>Application server (php-fpm, passenger, unicorn etc)</h4><p>When running web applications with a scripting language like Python (django),Ruby (Rails) or PHP often there is an application server involved. Often this is<code>php-fpm</code> for PHP or <code>passenger</code> for Ruby on Rails and Python. For Passenger<a href="https://github.com/aredondo/check_passenger">there is a nice check here</a> that reports user data as well.</p><p>If for whatever reason your application server fails, your application healthcheck will go off and it will be escalated. If you have a loadbalanced setup,the other servers will take over and your application health check should notalert or escalate, but you still want to know that this one server is havingproblems. Most often, this check will go off and the <code>haproxy</code> check describedabove will also go off.</p><h4>GlusterFS</h4><p>GlusterFS is a clustered file system. It allows multiple servers to have thesame filesytem, both via NFS, SMB or it&#39;s own filesystem module. When yourapplication is not cluster-ready or is heavily dependent on local filesGlusterFS is usefull. Or when you have to provide high-available file sharingservices. It is a tad bit slower than <code>nfs</code> with <code>drbd</code>, but provides morefeatures (like bitrot detection, geo-replication and advanced cluster controls).</p><p><a href="https://github.com/atlantos/nagios-check-gluster">This plugin</a> for recent versions of GlusterFS (&gt; 3.7) and <a href="https://exchange.nagios.org/directory/Plugins/System-Metrics/File-System/GlusterFS-checks/details">this pugin</a>for older versions are both good. The number of bricks, daemon status, volumestatus, diskspace and healing status are checked.</p><p>I don&#39;t let this check escalate, since the application health check will alsoescalate when its filesystem disappears.</p><h4>nfs/drbd</h4><p>NFS and DRBD, combined with CoroSync, is in my opinion the only fast sharedfilesystem. It&#39;s simple, stable and many operating systems talk NFS. DRBD is&#39;RAID 1&#39; over the network. A three node setup has <a href="https://docs.linbit.com/doc/users-guide-83/s-three-nodes/">always been a bit more workto setup</a>, but with version 9 <a href="https://web.archive.org/web/20180225072139/https://docs.linbit.com/docs/users-guide-9.0/#s-multi-node">this is now very easy and built in</a>.</p><p>The check checks if the device is connected and in sync/consistent. Output:</p><pre><code>DRBD OK: Device 0 Connected UpToDate</code></pre><p>When doing a resync, for example after a resize:</p><pre><code>DRBD WARNING: Device 0 SyncSource UpToDate</code></pre><p>Failure:</p><pre><code>DRBD CRITICAL: Device 0 SyncTarget InconsistentDRBD CRITICAL: Device 0 WFConnection UpToDate</code></pre><p>I don&#39;t let this check escalate, since the application health check will alsoescalate when its filesystem disappears.</p><h4>Redis</h4><p>Redis is a fast, in memory, key-value store. It can be clustered, but only 1node can be the master at any given time. The <a href="https://web.archive.org/web/20180225072427/https://redis.io/topics/cluster-tutorial">docs on clustering</a> areexcellent. Slaves are read-only and Sentinels monitor the state of the clusterand can trigger failovers.</p><p>My monitoring of redis is limited to <a href="https://exchange.nagios.org/directory/Plugins/Databases/check_redis-2Epl/details">this check</a> on the active master and aprocess check of <code>redis</code> and <code>redis-sentinel</code> on the slaves and sentinels.</p><h5>Quorum</h5><p>Any cluster setup has to have a Quorum component. Simply explained, the Quorumis the number of nodes required to keep the cluster running. If the Quorum isnot met, the cluster stops functioning to prevent split-brain situations.</p><p>A quorum must be an odd number, minimum of three. If you have a five nodecluster, the Quorum can be three. If you have a three node cluster, the quorummust be three. Two node clusters cannot have a quorum, since if one node failsthe other is unable to verify that itself is failed or the other node is failed.You can disable the Quorum and run a 2 node cluster, but that will give a highrisk of split brain and related issues.</p><p>Do note that the above is very much a simplified explanation. <a href="https://blogs.msdn.microsoft.com/clustering/2011/05/27/understanding-quorum-in-a-failover-cluster/">Microsoft</a>has a nice article covering the Quorum in a Hyper-V failover cluster setup.</p><p>If you run any type of cluster, be sure to monitor the quorum, whichever waypossible.</p><h5>Ceph</h5><p>Ceph is the best thing for high-available storage since sliced bread.<a href="https://en.wikipedia.org/wiki/Ceph_(software)">Wikipedia</a> has the best description, so I&#39;m not going to cover it here.</p><p>The checks I run on a ceph cluster are checks of the different components(<code>mon</code>, <code>mds</code> and <code>osd</code>). The OSD check, basically all the disks underneathCeph:</p><pre><code>Ceph OSD down: 0</code></pre><p>Failure:</p><pre><code>Ceph OSD down: 8</code></pre><p>On the storage servers itself there also runs a check on the actual OSD devices.When all are available, the check outputs:</p><pre><code>DISK OK</code></pre><p>Inclusing performance data on how much space is used per OSD:</p><pre><code>Label                       Value       Max         Warning     Critical/var/lib/ceph/osd/ceph-5    640.77 GiB  3.63 TiB    2.72 TiB    3.08 TiB/var/lib/ceph/osd/ceph-76   602.44 GiB  3.63 TiB    2.72 TiB    3.08 TiB</code></pre><p>When a disk fails:</p><pre><code>DISK CRITICAL - /var/lib/ceph/osd/ceph-86 is not accessible: Input/output error</code></pre><p>The ceph cluster health is also checked. If all is well, not much output:</p><pre><code>HEALTH_OK</code></pre><p>When a disk has failed, the health check output more information that is used indebugging:</p><pre><code>HEALTH_WARN 239 pgs degraded: 41 pgs stuck unclean: 239 pgs undersized: 100 requests are blocked &gt; 32 sec: 1 osds have slow requests: recovery 337342/53695956 objects degraded (0.628%): 1/213 in osds are downpg 2.9dd is stuck unclean for 302.205938, current state active+undersized+degraded, last acting [189, 187]pg 2.8d5 is stuck unclean for 304.844369, current state active+undersized+degraded, last acting [178, 35]pg 2.840 is stuck unclean for 304.032332, current state active+undersized+degraded, last acting [189, 214]pg 2.70b is stuck unclean for 317.764231, current state active+undersized+degraded, last acting [179, 178]pg 2.6dd is stuck unclean for 331.966147, current state active+undersized+degraded, last acting [197, 8]pg 2.73b is stuck unclean for 303.225730, current state active+undersized+degraded, last acting [187, 178]pg 2.5f2 is stuck unclean for 307.264681, current state active+undersized+degraded, last acting [175, 173]pg 2.5a3 is stuck unclean for 322.817106, current state active+undersized+d</code></pre><p>When a disk is replaced and the cluster is rebalancing:</p><pre><code>HEALTH_WARN 87 pgs degraded: 1 pgs recovering: 86 pgs recovery_wait: 87 pgs stuck unclean: recovery 445/53359560 objects degraded (0.001%)pg 2.8d5 is stuck unclean for 421.504447, current state active+recovery_wait+degraded, last acting [168, 178, 35]HEALTH_WARN 51 requests are blocked &gt; 32 sec: 2 osds have slow requests30 ops are blocked &gt; 65.536 sec on osd.1707 ops are blocked &gt; 32.768 sec on osd.1708 ops are blocked &gt; 65.536 sec on osd.1906 ops are blocked &gt; 32.768 sec on osd.1902 osds have slow requests</code></pre><p>Since Ceph runs the block devices that other servers use to provide storage andservices, if there are major failures, more checks will trigger. If one disk, orone storage node fails, Ceph handles it without problems, so no escalation.</p><p>Combined with the hardware monitoring (below in the article), I do know when adisk fails or has badblocks and thus needs replacement.</p><h3>Operating System</h3><p>The Operating System, the part that runs your applications and services. Can beWindows, Linux, BSD or anything else, everything can be monitored. The belowchecks are geared towards Linux and BSD but the concepts are applicable to otheroperating systems as well.</p><h4>Load</h4><p>Linux load average should be no higher than the amount of CPU cores in yoursystem. Load is not the same as CPU usage, <a href="http://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html">this article</a> explains in detailwhat Linux load average means. The &#39;amount of CPU cores&#39; rule of thumb is what Iuse for alerting on the 15 minute load avg.</p><p>When all is well:</p><pre><code>OK - load average: 1.51, 1.47, 1.47</code></pre><p>Too much on a 2 core system (15 min avg):</p><pre><code>CRITICAL - load average: 10.19, 5.10, 3.49</code></pre><p>I don&#39;t escalate this check, since the application health check and other checks(loadbalancer) will go off as well.</p><h4>CPU usage</h4><p>The percent of CPU usage and the 7 other states are usefull indicators ofarising problems. If your machine is using 100% CPU all the time, something iswrong. Incidental bursts are often not a problem, since the capacity is meant tobe used. The performance data of this check is usefull, for example in virtualenvironments to catch CPU steal (a hypervisor that is overloaded). <a href="https://web.archive.org/web/20180225080457/http://blog.scoutapp.com/articles/2015/02/24/understanding-linuxs-cpu-stats">Thisarticle</a> explains the CPU statistics in detail.</p><p>Perfdata captured:</p><pre><code>Label   Valueid      61.4%   # CPU idle timeusage   38%     # usage %us      27.6%   # user spacesy      7.1%    # kernelsi      3.4%    # software interruptswa      0.5%    # idle while waiting on I/Oni      0%      # niced processeshi      0%      # hardware interruptsst      0%      # CPU steal, how long the virtual CPU has spent waiting for the hypervisor to service another virtual CPU running on a different virtual machine.</code></pre><p>I only alert on high <code>wait</code> or CPU steal on virtual machines, since that is anindication of something wrong with the hypervisor or storage. No escalation,since other checks will escalate if needed.</p><h4>RAM and swap</h4><p>High memory usage on your server, just as CPU usage, can be an indication ofthings going wrong. Not a reason to alert just on this check, but this is a niceone to graph. Memory leaks are easy to find that way.</p><p>Example from a hypervisor that is not yet in use:</p><pre><code>Memory: OK Total: 773557 MB - Used: 11197 MB - 1% used</code></pre><p>When doing a load test on a hypervisor:</p><pre><code>Memory: CRITICAL Total: 386939 MB - Used: 383085 MB - 99% used!</code></pre><p>Swap, if enabled, is also checked. When all is well:</p><pre><code>OK - Memoryusage within acceptable levels</code></pre><p>If too much swap is used:</p><pre><code>CRITICAL - Memoryusage above critical value of 90%</code></pre><p>Generally you don&#39;t want your swap to be used, especcialy on hardware with lotsof RAM. On VM&#39;s with limited amount of RAM, swap can be usefull, but be sure toset <code>vm.swappiness</code> sysctl to something low.</p><h4>Ping</h4><p>Ping can be twofold, most of the time you do a ping check from your monitoringserver to the instance you are monitoring. Good for measuring latency andchecking if the host is up or not:</p><pre><code>PING OK - Packet loss = 0%, RTA = 3.41 ms</code></pre><p>Issues arise when there is lots of latency or packet loss:</p><pre><code>PING CRITICAL - Packet loss = 100%PING CRITICAL - Packet loss = 80%, RTA = 5.80 msPING CRITICAL - Packet loss = 0%, RTA = 211.72 ms</code></pre><p>Ping checks are used by default in Nagios to check if a host is up or not. If aping check fails I let that send a text message / pushover. Not critical, butstill requires more attention than just an email. Do make sure to rate limityour texts, otherwise a datacenter failure results in hundreds of texts.</p><p>Ping can also be used inside of a cluster. Most of my high-available clusterhosts have a ping check to the load balancer and router of that cluster, tomeasure internal network latency. Those checks do not alert, but are justgraphed into dashboards to get an overview of latency.</p><h4>TCP Sockets</h4><p><img src="https://raymii.org/s/inc/img/check_sockets.png" alt=""></p><p>Linux TCP network connections are going through different states. The most oftenfound states are <code>LISTEN</code>, <code>CLOSED</code> and <code>ESTABLISHED</code>, however during openingand closing connections different other states can appear. It&#39;s not bad to haveconnections in that state, but having lots of connections in a particular statecan be a sign of congestion or something that requires performance tuning.</p><h5>TCP Socket state flow</h5><p>When a connection is opened:</p><ul><li>Client / initiator sends a <code>SYN</code> to the server / receiver</li><li>Client marks connection state to <code>SYN-SENT</code></li><li>Server marks connection state to <code>SYN-RECEIVED</code></li><li>Server sends <code>SYN-ACK</code> to client</li><li>Client marks connection state to <code>ESTABLISHED</code></li><li>Client sends <code>ACK</code> to server</li><li>Server marks connection state to <code>ESTABLISHED</code></li></ul><p>When the client wants to terminate the connection:</p><ul><li>Client sends a <code>FIN</code> packet to the server</li><li>Client marks connection state <code>FIN-WAIT-1</code></li><li>Server receives termination requests and sends <code>ACK</code> to client</li><li>Server marks connection state as <code>CLOSE-WAIT</code></li><li>Client receives reply from server and marks connection state as <code>FIN-WAIT-2</code></li></ul><p>The server then has to terminate the connection as well:</p><ul><li>Server, after sending the <code>ACK</code> to client, with connection state <code>CLOSE-WAIT</code>, sends a <code>FIN</code> packet to client</li><li>Server marks state as <code>LAST-ACK</code></li><li>Client receives termination requests and sends <code>ACK</code> to server, marks connection as <code>TIME-WAIT</code></li><li>Server marks connection as <code>CLOSED</code></li><li>Client leaves connection in the TIME-WAIT state for a maximum of four minutes (defined by RFC793 and the maximum segment lifetime); then marks connection as <code>CLOSED</code> as well.</li></ul><p>There&#39;s also a three-way handshake alternative available, which occurs when theserver sends its <code>ACK+FIN</code> in one single packet (server goes from <code>ESTABLISHED</code>to <code>LAST-ACK</code> in a single step).</p><p><a href="https://exchange.nagios.org/directory/Plugins/Network-Connections%2C-Stats-and-Bandwidth/Check-Current-Connections/details">This plugin for Nagios</a> works great for monitoring the different socketstates. Busy loadbalancers have a higher limit, and alerting is not enabled.This is just one of those checks that helps get insight in your environment. Ifound out that one client was doing over 5000 redis connections for a singlepage load due to wrong configuration in their application for example.</p><p><a href="https://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux">This is</a> a nice read on tweaking and tuning servers for high performanceand <a href="https://blog.confirm.ch/tcp-connection-states/">this article</a> explains how linux network states work in more detail.</p><p>With <code>ss</code> you can check all tcp sockets and using shell tools sort them by stateand</p><p>This is a busy server which runs <code>haproxy</code> to redirect everything to <code>redis</code>.Redis is currently also running on that machine.</p><pre><code>ss -t -a | awk &#39;{print $1&quot; &quot;$5}&#39; | sort | uniq -c | sort    [...]     42 ESTAB 10.0.0.21:6379     45 ESTAB 127.0.0.1:6378   2585 TIME-WAIT 10.0.0.102:mysql  20679 TIME-WAIT 127.0.0.1:6378  20686 TIME-WAIT 10.0.0.21:6379ss -t -a | awk &#39;{print $1}&#39; | sort | uniq -c | sort      1 SYN-SENT      1 State     21 LISTEN    237 ESTAB  42850 TIME-WAIT</code></pre><h4>Logged in Users</h4><p>When you use a configuration management system, you often never have to login toa server by yourself to install or update stuff. Only when troubleshooting anissue, but for that you should have your central log cluster. I&#39;m not a big fanof this check, but there are situations where it is usefull. A jumphost, VPNserver, remote desktop machine, etc. Example check output:</p><pre><code>USERS OK - 0 users currently logged in</code></pre><p>The default limit is set to 6, but I have it set to 2. No alerting.</p><ul><li>Conntrack</li></ul><p>On hypervisors, loadbalancers and routers this is a usefull check to have. The<code>iptables</code> firewall keeps track of connections in the conntrack table. If it&#39;sfull, new connections <a href="https://major.io/2008/01/24/ip_conntrack-table-full-dropping-packet/">experience issues</a>.</p><p>Example output:</p><pre><code>OK conntrack table is 0% full and timeout is 14400</code></pre><p>Example output when issues arise:</p><pre><code>WARN conntrack table is 14% full and timeout is 14400INFO: tcp connections for src 192.81.222.236 reached CRIT 271464 &gt; 262144INFO: tcp connections for dst 10.200.10.9 reached WARN 137531 &gt; 65536INFO: tcp connections for dst 172.32.173.163 reached WARN 137442 &gt; 65536</code></pre><p><a href="https://web.archive.org/web/20180225150133/https://securedragon.net/clients/knowledgebase/177/What-is-conntrack-and-how-can-I-check-how-many-sessions-I-am-using.html">More info on conntrack can be found here</a>. <a href="https://exchange.nagios.org/directory/Plugins/Uncategorized/Software/check_conntrack-2Esh/details">This</a> is the check I use.</p><p>On dedicated firewall appliances this kind of check can also be usefull(Fortigate, Sophos, pfSense etc).</p><h4>Disk space and inodes</h4><p>One of the more basic checks, because servers act weird when their disks arefull:</p><pre><code>DISK OK - free space: / 23150 MB (60% inode=93%): /home/web/domains 30471 MB (74% inode=99%): /glusterfs/xvda3 30472 MB (74% inode=99%):</code></pre><p>Warning:</p><pre><code>DISK WARNING - free space: / 35606 MB (93% inode=94%): /mnt/export 49504 MB (10% inode=97%):</code></pre><p>Make sure to tweak the alert value to your specific setup. By default it&#39;s 10%,but on a 4 TB disk, that is 400 GB and that can be way to much to already alert.I generally set it to 10 GB.</p><p>Do note that this check can also go off when you&#39;ve ran out of <a href="https://en.wikipedia.org/wiki/Inode">inodes</a>.Then you have too many files, probably a boatload of small ones (cache anyone).The used disk space can have lots left, but the inodes (<code>df -i</code>) can be all usedup. This check checks both space and inodes.</p><h4>Disk stats, IO wait and IOPS</h4><p><a href="https://exchange.nagios.org/directory/Plugins/System-Metrics/Storage-Subsystem/check_diskstat/details">check_diskstat</a>, <a href="https://exchange.nagios.org/directory/Plugins/Operating-Systems/Linux/check_iostat--2D-I-2FO-statistics/details">check_iostat</a> and <a href="https://exchange.nagios.org/directory/Plugins/System-Metrics/File-System/Check-IO-Wait-(by-Nestor@Toronto)/details">check_iowait</a> are just likethe connection sockets checks usefull to graph and get insight in theperformance of your environment. Good to kick your VM provider if their platformhas issues with IO performance, especially when you&#39;re able to show what statsare normal.</p><p>check_diskstat:</p><pre><code>OK - summary: 0 io/s, read 0 sectors (0kB/s), write 816 sectors (1kB/s), queue size 0 in 300 seconds</code></pre><p>check_iostat:</p><pre><code>OK - I/O stats: Transfers/Sec=649.9 Read Requests/Sec=5.7 Write Requests/Sec=644.2 KBytes Read/Sec=264.4 KBytes_Written/Sec=8341.75</code></pre><p>check_iowait</p><pre><code>OK - Wait Time Stats: Avg I/O Wait Time (ms)=10.05 Avg Read Wait Time (ms)=11.27 Avg Write Wait Time (ms)=0.50 Avg Service Wait Time (ms)=0.54 Avg CPU Utilization=1.16</code></pre><p>No escalating, just graphing.</p><h4>Process checks</h4><p>The total amount of processes on a machine varies in my experience. A busymachine can have over a thousand running processes, sometimes more depending onthe hardware. The average VM has around 300-600 running. Another check to giveyou more insight in the environment:</p><pre><code>Processes running: 10 : Number of context switches last second: 56749TOTAL PROCS OK: 629 processes</code></pre><h5>Specific processes</h5><p>For essential programs on a system, for a webserver for example <code>apache</code> or<code>nginx</code> and for a database server <code>mysql</code>, you want to have a simple check tosee if the process is running. This check will not give you any insight on ifthe process actually works, funcionality wise, it could be as dead as doornail,but it will make sure you know when it is not running.</p><pre><code>PROCS OK: 3 processes with command name &#39;keepalived&#39;</code></pre><h5>Zombie processes</h5><p>Zooming in further in process checks, <a href="https://en.wikipedia.org/wiki/Zombie_process">zombie processes</a> are things youdon&#39;t want on your system. Check for them:</p><pre><code>PROCS OK: 0 processes with STATE = Z</code></pre><p>Alert, but not escalate. Zombie processes often are caused by disk IO issues orfailure so your other checks will go off as well.</p><h4>Time (and NTP)</h4><p>Correct time on your server is important for correct funcionality and logging.Make sure to always use NTP for correct timekeeping and <a href="https://exchange.nagios.org/directory/Plugins/System-Metrics/Time/check_ntp_time-2Epl/details">a check</a> to showwhen you are drifting (time difference):</p><pre><code>OK - NTPd Health is 100% with 3 peer(s).Thresholds:  Health (60%, 40%): Peers (2, 1)------------------------------------------------------Received 100% of the traffic from +192.170.92.1Received 100% of the traffic from +192.1.254.130Received 100% of the traffic from *192.1.254.50</code></pre><p>If you use <a href="https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm">TOTP</a> in your application, a time difference of more than 30seconds can be an issue already since the generated codes are invalid and yourusers are not able to login.</p><p>If you work with short-lived certificates, time difference can also cause hugeproblems since valid certificates can be considerend invalid due to servers nothaving the correct time.</p><h4>Uptime</h4><p>System uptime, it&#39;s not a contest on who has the largest. High available systemcomponents can all be brought down to be updated or checked without problems forthe service provided. Regular updates, newer kernels, disk checks (fsck) andgeneral cruft cleanup are reasons use to reboot machines every once in a while.If a machine reboots itself without being instructed, that can be an issue, asign of hardware failure or a disruption at your VM provider. Check the uptime:</p><pre><code>System Uptime - up 458 days, 5 Hours, 43 Minutes</code></pre><p>Alert when less than 1 hour or more than 100 days. After a hundred days it&#39;stime to apply the updates and do a reboot. Perfect task for your intern orjunior member.</p><h4>cronjobs</h4><p>Cronjobs can be an important part of your system. Maybe you use one to run yourbilling, to run a queue of some sort or to do backups. Whatever the cronjob is,it can be important to monitor if it ran correctly. There are no ready-madeplugins to do this, but what I use is a combination of a logfile and the<code>check_file_age</code> plugin. Let&#39;s say I have a cronjob that runs at midnight andtakes about two hours. The cronjob must log to a file. I set up the<code>check_file_age</code> to alert if that logfile is older than an hour with a<code>check_period</code> just after the cronjob is finished. That way, the check runsafter the cronjob should have finished and only alerts if the logfile has notbeen updated.</p><h4>Log parser</h4><p>Let&#39;s say you have an application that logs when something goes wrong, but thatsomething that goes wrong does require action or is a preface to a largerfailure. You might want to monitor that logfile and alert if that line shows upin there.</p><p>One of my usecases is to check for authentication failures in an internalapplication. Not regular authentication where someone enters a password, butiSCSI authentication. One of the pieces of software that places config filessometimes has an error where the passwords are incorrect. The manufacturer isunable to fix this bug so we monitor the iSCSI servers:</p><pre><code>OK - There are only 0 instances of &quot;\*\*\*ERROR\*\*\* auth failed&quot; in the last 60 minutes - Warning threshold is 10OK - There are only 0 instances of &quot;Listen queue overflow&quot; in the last 60 minutes - Warning threshold is 1</code></pre><p>Any one of those lines in the log means trouble. Not directly, but every twohours when the software restarts.</p><p><a href="https://exchange.nagios.org/directory/Plugins/Log-Files/check_log3-2Epl/details">This plugin</a> is the one I use.</p><h3>Hardware</h3><p>When you manage physical hardware it can be easy to forget that hardwarerequires special checks, especially when you are used to just check virtualmachines. But, hardware has many extra quirks. I often say, hardware is stupidjust go to the cloud, as a joke. Hardware requires maintenance, but withwarranty and a reputable provider that is not an issue at al. Even better if youmade your applications redundant, then hardware failure is no problem.</p><p>Where in VPSes you just check the OS and software side of things, with serverhardware you also check, well, the hardware. So think, RAM (the actual DIMM&#39;s),disks (bad blocks), RAID config (physical disks, controllers, virtual disks,battery), network cards (uplink, bonding), temperature (CPU, disks), power(reduntant PSU status, power usage).</p><p>If you have special hardware like network devices, KVM switches, ATSes (Autotranser switch, to make a device with only single PSU power redundant) or APC&#39;s(remote controlled power bars) you also want to check those.</p><p>This overview lists examples of all the hardware checks. As with the entirearticle, take from it whatever you like and integrate it in your setup.</p><h4>iDrac/ILO/BMC/ipmi</h4><p>Many terms for the same thing, the out of band access to your server. Sometimeswith a different NIC, sometimes shared on the internal NIC, sometimes with alicense (Dell/HP) or with all the features (Supermicro). Provides remote accessto the server when it&#39;s off (or on), often with console access and otherutilities like firmware upgrades and hardware status.</p><p>Dell has the <a href="https://web.archive.org/web/20180311123048/http://linux.dell.com/repo/hardware/omsa.html">OpenManage</a> tools, for Supermicro you can use <a href="https://linux.die.net/man/1/ipmitool">ipmitool</a>.The Dell iDrac can also be monitored via the XML API on the iDrac webserveritself.</p><p>Both HP and Dell support SNMP for their OOB management.</p><p>One way or another, it can provide insight in the server. I use it to monitorRAM DIMM&#39;s, PSU status and usage, RAID status and in the case of Dell thegeneric <code>omreport chassis</code> output.</p><p>Whenever something breaks, we create an RMA request and get it covered in thewarranty.</p><p>The main reason to monitor your out of band access is that you want to make sureit works, because when you need it (there is a problem with the hardwareitself), you don&#39;t want to find out that it has been unavailable or not working.</p><p>In my case I&#39;ve written custom checks for the OOB-hardware checks. Some parse<code>omreport</code> commands, others parse web pages or XML files. Some use SNMP.</p><p>This is an example of the SNMP Dell DIMM check:</p><pre><code>Memory 1 (DIMM Socket A1) 32.0 GB/2400 MHz: ENABLED/OK [26, Hynix Semiconductor, S/N: 2B425762]Memory 2 (DIMM Socket A2) 32.0 GB/2400 MHz: ENABLED/NONCRITICAL [26, Hynix Semiconductor, S/N: 2B425743]Memory 3 (DIMM Socket A3) 32.0 GB/2400 MHz: ENABLED/OK [26, Hynix Semiconductor, S/N: 2B425579]</code></pre><p>Dimm A2 needs a replacement.</p><p>The general <code>omreport</code> check:</p><pre><code>OK - Fans: Ok, Intrusion: Ok, Memory: Ok, Processors: Ok, Temperatures: Ok, Voltages: Ok, Hardware_log: Ok, Batteries: Ok, Power Supplies: Ok, Power Management: Ok</code></pre><p>If it goes off, check the part that is not <code>Ok</code> and investigate further.</p><h4>Ports</h4><p>The main ports I monitor are network uplinks, both RJ-45 and Fiber. Some talkethernet, some talk Fabric, but all of them must be up, often in the correctVLAN. Both in the server as on the router/switch side.</p><p>On the switch/router side you can check port status, but also the error countson a port. If those are rising, it&#39;s probably time to replace your optic or SFPmodule.</p><p>If you are in an office situation with <a href="https://web.archive.org/web/20180311123633/https://www.cisco.com/c/en/us/td/docs/switches/lan/catalyst6500/ios/12-2SX/configuration/guide/book/port_sec.html">port security</a> enabled, whichbasically means only select MAC addresses can connect to a port, or with<a href="https://en.wikipedia.org/wiki/IEEE_802.1X">802.11x</a> enabled (authentication to get on the network) on, monitoring thatis a big help. If a port suddenly gets blocked you want to go and find out why(intruder or human mistake)? Or maybe your developer set up virtualbox with hisVM in Bridged mode. Or someone forgot their 802.11x password, or it expired.</p><p>Or maybe there are intruders and you catch them before you hit the news.</p><p>It also can be good to monitor traffic flow and alert if a port is doing muchmore traffic than it regularly does. That can be a hassle to setup correctly, itwill give lots of false positives. But, there are cases where it is usefull.Perhaps to find an employee leaving their computer on over the weekend to piratethe latest movoie.</p><p>Generally there are checks for major-brand switches and routers available. Atool like <a href="https://www.observium.org/">Observium</a> can be a great addition to your general monitoringsetup.</p><p>On the server level you can check if your network bond is still functioning:</p><pre><code>OK: bond0 - Bonding Mode: IEEE 802.3ad Dynamic link aggregation - enp341s0f1 (a9:36:9f:0e:d6:5a/up/10000Mbps) - enp342s0f0 (a9:36:9f:0e:d6:30/up/10000Mbps) - enp341s0f0 (a9:36:9f:0e:d6:58/up/10000Mbps) - enp342s0f1 (a9:36:9f:0e:d6:32/up/10000Mbps) - eth1 (24:6e:96:7c:f1:58/up/10000Mbps) - eth2 (24:6e:96:7c:f1:5a/up/10000Mbps)</code></pre><p>Failure might indicate a NIC problem or an issue with the switch.</p><h4>Disks, RAID, ZFS and controllers</h4><p>Storage is stupid because it breaks often. If you&#39;ve got over 10.000 spinningdisks then one breaks at least once a day. Not a problem in my case sinceeverything is redundant, both RAID as wel as Ceph, and we&#39;ve got a dedicated RMAguy who replaces them. There are a few checks I like to have on my disks andraid sets. Some are mentioned above in the Ceph section already.</p><h5>Raid array load</h5><p>Some storage vendors report array load. We&#39;ve got dedicated arrays for swapspace and regular disks, the swap volume alerts are an indication when a VPS isswapping heavily:</p><pre><code>CRITICAL: vpsvg-935=20 vpsvg-937=60 vpsvg-936=35 vpsswap-967=98(&gt;95)</code></pre><h5>Failed disks</h5><p>Either a disk is suddenly out of the RAID array, Ceph detects an error or thedisk reports Bad Blocks. All reasons to replace it. Here are different checks wehave for failed disks. First from an HP machine:</p><pre><code>RAID ERROR - Arrays: OK:1 Bad:1 - Disks: OK:13 Bad:0RAID WARNING - HP Smart Array Recovering:  Smart Array P420i in Slot 0 (Embedded) array A logicaldrive 1 (136.7 GB, RAID 1, OK) array B logicaldrive 2 (93.1 GB, RAID 1, Interim Recovery Mode)</code></pre><p>Dell, disk 14 has Bad blocks:</p><pre><code>WARNING - ID=0:1:0 Status=Ok, ID=0:1:1 Status=Ok, ID=0:1:2 Status=Ok, ID=0:1:3 Status=Ok, ID=0:1:4 Status=Ok, ID=0:1:5 Status=Ok, ID=0:1:6 Status=Ok, ID=0:1:7 Status=Ok, ID=0:1:8 Status=Ok, ID=0:1:9 Status=Ok, ID=0:1:10 Status=Ok, ID=0:1:11 Status=Ok, ID=0:1:12 Status=Ok, ID=0:1:13 Status=Ok, ID=0:1:14 Status=Non-Critical, ID=0:1:15 Status=Ok, ID=0:1:16 Status=Ok, ID=0:1:17 Status=Ok,</code></pre><p>The controllers and battery:</p><pre><code>vdisk OK: Controller0=Ok/Ready [ Battery0=Ok/Ready Vdisk0=Ok/Ready 0 [ 0:1:0=Ok/Online 0:1:1=Ok/Online 0:1:2=Ok/Online 0:1:3=Ok/Online 0:1:4=Ok/Online 0:1:5=Ok/Online 0:1:6=Ok/Online 0:1:7=Ok/Online ] ]</code></pre><p>If this check goes to Noncritical then you need to upgrade the firmware.OpenManage detects old firmwares and alerts.</p><pre><code>OK - Controller  PERC H730P Mini state is Ready and Controller status is Ok</code></pre><h4>Temperature and fans</h4><p>Disk temperature should not be to high, CPU and general system temperatureshould not as well. Monitoring these values allows you to detect errors in thecooling system of your datacenter or fan failure. SNMP is used often for thesechecks.</p><pre><code>System Board Inlet Temp: 22.0 C ENABLED/OKSystem Board Exhaust Temp: 38.0 C ENABLED/OKCPU1 Temp: 46.0 C ENABLED/OKCPU2 Temp: 44.0 C ENABLED/OK</code></pre><p>Fan status and speed:</p><pre><code>System Board Fan1A: 8120 RPM - ENABLED/OKSystem Board Fan2A: 8120 RPM - ENABLED/OKSystem Board Fan3A: 8240 RPM - ENABLED/OK</code></pre><p>This model of server has fans that can go up to 9000 RPM. My check is set toalert when it&#39;s OVER 9000!</p><p>We have powerbars in our datacenter racks, and we use those to monitor theambient temperature in the datacenter. When it goes over 25 degrees we let allalerts go off and escalate, since we had a major incident once where the coolingsystem in the datacenter failed. Using SNMP we monitor the APC power bar for thetemperature.</p><pre><code>SNMP OK - Temperature: 231 tenths of degrees celcius</code></pre><p>Even if someone works on the rack or leaves the doors open the temperature staysstable under 25 degrees.</p><h4>Power redundancy and status</h4><p>A rack often has a maximun amount of power you can draw, for example, 16 A or 32A. Using this check you can monitor that a server doesn&#39;t go above a certainthreshold that will make you use to much power.</p><pre><code>OK - Power Consumption in under the warning level psu statusPU 1: ENABLED/OK, RedundancyStatus: FULL, SystemBoard Pwr Consumption: 210 W</code></pre><p>We also check the power redundancy status. In Dell servers it requires aconfiguration setting to have the power supplies redundant. Not sure why, butsometimes this changes (after a firmware update) and you don&#39;t want to have aoutage because one feed went down.</p><p>One last thing we check is the CMOS battery. Also unsure why, but these thingsbreak and can cause strange issues. If this check alerts, we send an RMA andreplace the battery.</p><pre><code>System Board CMOS Battery: ENABLED/OK [PRESENCEDETECTED]</code></pre>Tags: <a href="../tags/articles.html">articles</a>, <a href="../tags/hardware.html">hardware</a>, <a href="../tags/health.html">health</a>, <a href="../tags/icinga.html">icinga</a>, <a href="../tags/monitoring.html">monitoring</a>, <a href="../tags/nagios.html">nagios</a>, <a href="../tags/ubuntu.html">ubuntu</a></div><br/><footer><br/><form role="search" action="https://encrypted.google.com/search"                style="min-width:250px;max-width:300px;"><div class="form-group"><input type="hidden" name="as_sitesearch" value="raymii.org"><input type="hidden" name="as_qdr" value="all"><input type="text" name="as_q" class="form-control" placeholder="Search"></div></form><br><p><small><a href="/s/">Home</a> |                 <a href="/s/static/About.html">About</a> |                 <a href="/s/tags/all.html">All pages</a> |                 <a href="/s/software/Sparkling_Network.html">Cluster Status</a> |                 Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p></footer><script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script><script>      window.dataLayer = window.dataLayer || [];      function gtag(){dataLayer.push(arguments);}      gtag('js', new Date());      gtag('config', 'UA-3704876-6');    </script></main></body></html>    