
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>OS X - Applescript to lock date and time preference panel to fix local sudo exploit - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>OS X - Applescript to lock date and time preference panel to fix local sudo exploit</h2><p><small>Published: 02-09-2013 | Author: Remy van Elst | <a href="OS-X-Applescript-To-Lock-Date-Time-Settings-Panel-for-Sudo-Exploit.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>This applescript locks the OS X Date and Time Preference Panel. It can be run
via Apple Remote Desktop. This is related to <a href="https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2013-1775">CVE-2013-1775</a>, a local sudo
root exploit on OS X. If the date and time preference panel is locked, setting
the date and time also requires a sudo password.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>To exploit the bug you have to be in an administrative group and you have to
have used sudo before. OS X by default does not require extra authentication to
set the date for administrative users. Limited users are not able to do this.</p>

<pre><code>When a user successfully authenticates with sudo, a time stamp
file is updated to allow that user to continue running sudo
without requiring a password for a preset time period (five
minutes by default).  The user&#39;s time stamp file can be reset
using &quot;sudo -k&quot; or removed altogether via &quot;sudo -K&quot;.

A user who has sudo access and is able to control the local
clock (common in desktop environments) can run a command via
sudo without authenticating as long as they have previously
authenticated themselves at least once by running &quot;sudo -k&quot; and
then setting the clock to the epoch (1970-01-01 01:00:00).

The vulnerability does not permit a user to run commands other
than those allowed by the sudoers policy.
</code></pre>

<p><a href="http://seclists.org/oss-sec/2013/q1/489">Source</a></p>

<p>This script locks the date and time panel. When that is done, OS X requires a
password to change the date and time. It is an applescript, it checks if the
panel is locked or unlocked and if it is unlocked it locks it. It can also be
run via Apple Remote Desktop.</p>

<p>The Applescript:</p>

<pre><code>-- By R. van Elst
-- License: GNU GPL v3 
quit application &quot;System Preferences&quot;
quit application &quot;System Preferences&quot;

tell application &quot;System Preferences&quot;
    activate
    set current pane to pane id &quot;com.apple.preference.datetime&quot;
end tell


tell application &quot;System Events&quot; to set frontmost of process &quot;System Preferences&quot; to true
tell application &quot;System Events&quot;
    tell process &quot;System Preferences&quot;
        tell window 1
            --set titlell to title of button 4
            --display dialog titlell
            if title of button 4 is &quot;Click the lock to prevent further changes.&quot; then
                click button 4
            end if
        end tell
    end tell
end tell
quit application &quot;System Preferences&quot;
</code></pre>

<p>To run this via Apple Remote Desktop, select a machine and the run a UNIX
command on it. Make sure it runs as the currently logged in console user. Paste
this command in there:</p>

<pre><code>osascript &lt;&lt; endofSCRIPT

quit application &quot;System Preferences&quot;
quit application &quot;System Preferences&quot;

tell application &quot;System Preferences&quot;
    activate
    set current pane to pane id &quot;com.apple.preference.datetime&quot;
end tell


tell application &quot;System Events&quot; to set frontmost of process &quot;System Preferences&quot; to true
tell application &quot;System Events&quot;
    tell process &quot;System Preferences&quot;
        tell window 1
            --set titlell to title of button 4
            --display dialog titlell
            if title of button 4 is &quot;Click the lock to prevent further changes.&quot; then
                click button 4
            end if
        end tell
    end tell
end tell
quit application &quot;System Preferences&quot;

endofSCRIPT
</code></pre>

<p>This also works when the machine is locked. **<a href="https://raymii.org/s/snippets/OS-X-Enable-Access-for-assistive-devices-via-command-line.html">You do need to enable access for
assistive devices. Click this link to see how to do that via the command
line</a></p>

<p>Another option is to configure sudo to ask for a password every time. Edit
<code>/etc/sudoers</code> and add the following:</p>

<pre><code>Defaults timestamp_timeout=0 
</code></pre>

<p>Thanks to <a href="http://tinyapps.org/">Miles from TinyApps.org for the tip!</a></p>
Tags: <a href="../tags/apple.html" class="link">apple</a>, <a href="../tags/apple-remote-desktop.html" class="link">apple-remote-desktop</a>, <a href="../tags/ard.html" class="link">ard</a>, <a href="../tags/command-line.html" class="link">command-line</a>, <a href="../tags/exploit.html" class="link">exploit</a>, <a href="../tags/mac.html" class="link">mac</a>, <a href="../tags/os-x.html" class="link">os-x</a>, <a href="../tags/software.html" class="link">software</a>, <a href="../tags/sudo.html" class="link">sudo</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    