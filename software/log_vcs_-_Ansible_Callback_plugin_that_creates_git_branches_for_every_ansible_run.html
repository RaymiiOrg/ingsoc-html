
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>log_vcs - Ansible callback plugin that creates VCS (git) branches for every Ansible run - Raymii.org</title>
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <script src="/s//inc/js/instant.js"></script> 
        <script src="/s//inc/js/toc.js"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org 
                        <img src="/s/inc/img/resistor-50.png" alt="Logo (IEC resistor symbol)">
                    </a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          
    <h2 class='headheader' id='main'>log_vcs - Ansible callback plugin that creates VCS (git) branches for every Ansible run</h2>
<p><small>Published: 10-07-2018 | Author: Remy van Elst | <a href="log_vcs_-_Ansible_Callback_plugin_that_creates_git_branches_for_every_ansible_run.txt" class="link">Text only version of this article</small></a>
</p>
<div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc">
<h3>Table of Contents</h3>
</div>
<hr>
<div id="contents">
<p>This callback plugin creates a VCS branch every time you run Ansible. If you
ever need to go back to a certain state or environment, check out that branch
and be sure nothing has changed.</p>

<p>This is useful when you have multiple environments or multiple people deploying
and continually develop your Ansible. When you often deploy to test / acceptance
and less often to production, you can checkout the last branch that deployed to
production if a hotfix or other maintenance is required, without having to
search back in your commits and logs. I would recommend to develop
infrastructure features in feature branches and have the master branch always
deployable to production. However, reality learns that that is not always the
case and this is a nice automatic way to have a fallback.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<h2>Requirements and installation</h2>

<p>The plugin requires &#39;GitPython&#39;. On Ubuntu this can be installed with the
package manager:</p>

<pre><code>apt-get install python-git python3-git
</code></pre>

<p>The plugin requires the Ansible folder to be a git repository. If you have a
seperate &#39;roles&#39; directory, that is not included in this plugin.</p>

<p>The plugin is hosted on <a href="https://github.com/RaymiiOrg/log_vcs">Github: https://github.com/RaymiiOrg/log_vcs</a></p>

<p>To install the plugin, create a folder in your Ansible folder:</p>

<pre><code>mkdir -p plugins/callbacks
</code></pre>

<p>Place the file in there and edit your <code>ansible.cfg</code> file:</p>

<pre><code>  [defaults]
  callback_whitelist = log_vcs
  callback_plugins = plugins/callbacks
</code></pre>

<h2>Environments</h2>

<p>If you have multiple environments (multiple inventories) then every inventory
needs a <code>group_var</code> (in <code>group_vars/all.yml</code>) named <code>environment</code>. The plugin
uses this in the branch name. In my case it can be <code>dev</code>, <code>tst</code>, <code>acc</code>, <code>prd</code> or
<code>mgmt</code>. It is not required, if it is not found the plugin will substitute it
with <code>env</code>.</p>

<h2>Branch name format</h2>

<p>The branch name format is:</p>

<pre><code>auto-$year$month$dayT$hour$minute-$env-$branch-$username-$playbook-filename
</code></pre>

<p>For example:</p>

<pre><code>auto-20180710T100719-env-master-remy-nginx-vps-for-raymii.org.yml
</code></pre>

<p>or:</p>

<pre><code>  auto-20180709T161235-tst-refactor-for-odoo-remy-odoo.yml
  auto-20180710T091419-prd-refactor-for-odoo-remy-ping.yml
</code></pre>

<h2>Auto-commit or cleanup?</h2>

<p>There is no auto-commit or auto-push to a git server. In my use-case deployment
is always done from a management machine, otherwise you have to extend the
plugin to do auto-commit and push. I decided in my case it would not be useful.</p>

<p>Auto-cleanup is also not implemented. We have bash for that:</p>

<pre><code>git branch | grep &#39;auto-&#39; | xargs -L 1 -I % git branch -d %
</code></pre>
Tags: <a href="../tags/ansible.html" class="link">ansible</a>
, <a href="../tags/configuration-management.html" class="link">configuration-management</a>
, <a href="../tags/deployment.html" class="link">deployment</a>
, <a href="../tags/devops.html" class="link">devops</a>
, <a href="../tags/git.html" class="link">git</a>
, <a href="../tags/python.html" class="link">python</a>
, <a href="../tags/software.html" class="link">software</a>
, <a href="../tags/sudoers.html" class="link">sudoers</a>
</div>
<br/>
<footer>
<br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p>
    
    </footer>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-3704876-6');
    </script>
     
    </main>
    </body>
    </html>
    