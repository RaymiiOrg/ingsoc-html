
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>Restrict SSH - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>Restrict SSH</h2><p><small>Published: 20-01-2013 | Author: Remy van Elst | <a href="Restrict_SSH.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>restrict <em>ssh.sh is a bash script which restricts ssh for a user to a set of
(flexible) commands via .ssh/authorized</em> keys, and log it verbosely.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<h3>Purpose</h3>

<p>I have a web application which needs to do some things over ssh on a server. It
runs as a separate user, and this script allows me to restrict the commands it
can execute as well. It however does allow regexes so filenames can be passed.
It also logs the commands and session info.</p>

<h3>Installation / Usage</h3>

<p>Download the script from github, or clone the repository.</p>

<p>Put this script in the users home directory, or a directory which is accessible
by that user.</p>

<p>Edit the <code>allowed_commands</code> array:</p>

<pre><code>declare -a allowed_commands=(&#39;^ls -[l|d|a]$&#39; &#39;ls -la&#39; &#39;w&#39; &#39;uptime&#39; &#39;pwd&#39; &#39;uname -a&#39;) 
</code></pre>

<p>Make sure that there are no comma&#39;s (<code>,</code>) between the options, otherwise it will
fail.</p>

<p>Make it executable for that user: <code>chown user:usergroup
/home/user/restrict_ssh.sh</code> and/or <code>chmod +x /home/user/restrict_ssh.sh</code>.</p>

<p>Modify the users <code>~/.ssh/authorized_keys</code> file, and before the ssh key(s) put
the line <code>command=&quot;/home/user/restrict_ssh.sh&quot;</code> before the key. Like so:</p>

<pre><code>command=&quot;/home/remy/restrict_ssh.sh&quot; ssh-rsa AAAAB[...]X9t remy@macbookpro.raymii.nl
</code></pre>

<p>Optional: Disable password login for that user, edit <code>/etc/ssh/sshd_config</code> and
add the following:</p>

<pre><code>Match User remy
    PasswordAuthentication no
</code></pre>

<p>This will disable password logins only for user <code>remy</code>.</p>

<h3>Regexing / Safety</h3>

<p>The default setup has a regex command allowed. It is the <code>ls</code> command, and the
regex allows either <code>ls -l</code>, <code>ls -d</code> or <code>ls -a</code>. If you know basic Perl style
regexes you can be very creative with this, for example <code>^ping -c 4
[a-zA-Z0-9]{2,20}.(com|org|net)$</code> allows the command ping to be executed for any
2 to 20 character .com, .net or .org domain. domain and nothing else.</p>

<p><em>BE CAREFUL WITH THIS. IF YOU CONFIGURE IT WRONG USER MAY BE ABLE TO GET A SHELL
(vim, :!bash) OR OVERWRITE THE .ssh/authorized</em> keys FILE. IF YOU ARE NOT SURE,
THEN DO NOT USE IT AT ALL!_</p>

<p>Also, if you allow <code>vim</code>, <code>less</code>, <code>man</code>, or any other program, a user might get
a shell. If the program you allow includes the possibility to run a shell, this
script/restriction is of no use.</p>

<h3>Logging</h3>

<p>By default it logs lines like these to syslog:</p>

<pre><code>Jan 20 20:39:23 vps11 RESTRICTED_SSH[9015]: INFO: SSH Connection: &#39;x.x.x.x 32309 x.x.x.x 22&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9014]: INFO: SSH Client: &#39;x.x.x.x 32309 22&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9017]: INFO: SSH Username: &#39;remy&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9016]: INFO: SSH Shell: &#39;/bin/bash&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9013]: INFO: Sent SSH command: &#39;vim&#39;
Jan 20 20:39:23 vps11 RESTRICTED_SSH[9018]: ERROR: Command &quot;vim&quot; is not allowed.
</code></pre>

<h3>Other info</h3>

<p>I think it requires <code>Bash 4+</code> because of the array search function. I have no
bash lower than v4 to test it with.</p>

<h3>Links</h3>

<p><a href="https://raymii.org/s/software/Restrict_SSH.html">https://raymii.org/s/software/Restrict_SSH.html</a><br>
<a href="https://github.com/RaymiiOrg/restrict_ssh">https://github.com/RaymiiOrg/restrict_ssh</a></p>
Tags: <a href="../tags/authorized_keys.html" class="link">authorized_keys</a>, <a href="../tags/bash.html" class="link">bash</a>, <a href="../tags/openssh.html" class="link">openssh</a>, <a href="../tags/restricted.html" class="link">restricted</a>, <a href="../tags/software.html" class="link">software</a>, <a href="../tags/ssh.html" class="link">ssh</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    