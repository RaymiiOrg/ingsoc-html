
    <!DOCTYPE html>
    <html lang="en">
        <head>
        <title>OpenVZ/Proxmox - pre-backup all container dump script - Raymii.org</title>
        <!-- <link href="/s/inc/css/custom-first.css" rel="stylesheet" />-->
        <link href="/s/inc/css/marx.css" rel="stylesheet"  />
        <!-- <link href="/s/inc/css/custom.css" rel="stylesheet" title="custom" />-->
        <script src="/s//inc/js/instant.js" type="text/javascript"></script> 
        <script src="/s//inc/js/toc.js" type="text/javascript"></script> 
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link type="application/opensearchdescription+xml" rel="search" href="/s/inc/opensearch.xml"/>
        <link rel="alternate" type="application/rss+xml" title="RSS Feed for Raymii.org" href="https://raymii.org/s/feed.xml" />
    </head>
    <body>
        
        <a id="top-of-page"></a>
        <main>
        <a class="skip-main" href="#main">Skip to main content</a>
            <header>
                <h1 class="headheader">
                    <a href="https://raymii.org/s/">Raymii.org <img src="/s/inc/img/resistor-50.png"></a>
                </h1>
                <small>
                  Quis custodiet ipsos custodes?<br>
                  <a href="/s/">Home</a> | 
                  <a href="/s/static/About.html">About</a> | 
                  <a href="/s/tags/all.html">All pages</a> | 
                  <a href="https://raymii.org/s/feed.xml">RSS Feed</a> | 
                  <a href="gopher://raymii.org:70">Gopher</a>
                </small>
            </header>
          

    <h2 class='headheader' id='main'>OpenVZ/Proxmox - pre-backup all container dump script</h2><p><small>Published: 18-01-2015 | Author: Remy van Elst | <a href="OpenVZ_Proxmox_-_pre-backup_all_container_dump_script.txt" class="link">Text only version of this article</small></a></p><div class='ad'>
                            <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                            <!-- voorartikel -->
                            <ins class="adsbygoogle"
                                 style="display:inline-block;width:728px;height:90px"
                                 data-ad-client="ca-pub-7993642564731324"
                                 data-ad-slot="6172324376"></ins>
                            <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                            </script>
                        </div><br><div id="toc"><h3>Table of Contents</h3></div><hr><div id="contents"><p>This simple script creates a vzdump of all the OpenVZ containers on a machine.
It can be used before an actual backup, in my case the actual backup excludes
the container path <code>/var/lib/vz/private</code>. This because a dump is easier to
backup because it has much less files in it.</p>

<p><a href="https://www.digitalocean.com/?refcode=7435ae6b8212">If you like this article, consider sponsoring me by trying out a Digital Ocean
VPS. With this link you&#39;ll get $100 credit for 60 days). (referral link)</a></p>

<p>If I include the container path my backups take about 40% longer to run then
with only the dumps enabled.</p>

<p>Do note that the VM&#39;s by default are stopped a very short while. The <code>mode</code> is
<code>suspend</code>, which means that first an online copy of all the files is performed,
then the VM is stopped and the remaining changed files are synced. Afterwards
the VM is booted again.</p>

<p>The <code>mode</code> can also be <code>snapshot</code>, then it will take an LVM snapshot without any
downtime. You do need to have enough free space on your LVM volume.</p>

<p>The last mode is <code>stop</code>, which will shut down the VM before the dump and boot it
up afterwards. Long downtime includes.</p>

<h3>Script</h3>

<pre><code>#!/bin/bash
# Author: Remy van Elst, https://raymii.org
# Small script to dump OpenVZ VM&#39;s before a backup. (pre-backup scripts)
# License: GNU GPLv3

BACKUPDIR=&quot;/var/backups/vz/$(date +%Y%m%d)&quot;
MODE=suspend
if [[ ! -d &quot;$BACKUDIRP&quot; ]]; then
    mkdir -p &quot;$BACKUPDIR&quot;
fi

vzdump &quot;${vmid}&quot; --stdexcludes --mode=${MODE} --dumpdir=${BACKUPDIR} --compress=gzip --all
</code></pre>

<p>My backup software allows me to run scripts before and after a backup, so called
pre and post backup scripts. This is a pre-backup script. You can also have a
post backup script which cleans up these temp dump files after the backup has
succeeded.</p>
Tags: <a href="../tags/bash.html" class="link">bash</a>, <a href="../tags/kvm.html" class="link">kvm</a>, <a href="../tags/openvz.html" class="link">openvz</a>, <a href="../tags/proxmox.html" class="link">proxmox</a>, <a href="../tags/proxmox-ve.html" class="link">proxmox-ve</a>, <a href="../tags/software.html" class="link">software</a>, <a href="../tags/ssh.html" class="link">ssh</a>, <a href="../tags/virtualization.html" class="link">virtualization</a>, <a href="../tags/vzdump.html" class="link">vzdump</a></div><br/><footer><br/>
                <form role="search" action="https://encrypted.google.com/search"
                style="min-width:250px;max-width:300px;">
                    <div class="form-group">
                      <input type="hidden" name="as_sitesearch" value="raymii.org">
                      <input type="hidden" name="as_qdr" value="all">
                      <input type="text" name="as_q" class="form-control" placeholder="Search">
                    </div>
                  </form>
                <br>
                <p><small>
                <a href="/s/">Home</a> | 
                <a href="/s/static/About.html">About</a> | 
                <a href="/s/tags/all.html">All pages</a> | 
                <a href="/s/software/Sparkling_Network.html">Cluster Status</a> | 
                Generated by <a href="/s/software/ingsoc.html">ingsoc</a>.</small></p>
            
    </footer>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3704876-6"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-3704876-6');
    </script>
     
    </body>
    </html>
    